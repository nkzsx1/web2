var BMapLib=window.BMapLib=BMapLib||{},BMAPLIB_TAB_SEARCH=0,BMAPLIB_TAB_TO_HERE=1,BMAPLIB_TAB_FROM_HERE=2;!function(){var t,i=t=i||{version:"1.5.0"};i.guid="$BAIDU$",window[i.guid]=window[i.guid]||{},i.lang=i.lang||{},i.lang.isString=function(t){return"[object String]"==Object.prototype.toString.call(t)},i.lang.Event=function(t,i){this.type=t,this.returnValue=!0,this.target=i||null,this.currentTarget=null},i.object=i.object||{},i.extend=i.object.extend=function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);return t},i.event=i.event||{},i.event._listeners=i.event._listeners||[],i.dom=i.dom||{},i.dom._g=function(t){return i.lang.isString(t)?document.getElementById(t):t},i._g=i.dom._g,i.event.on=function(t,e,s){e=e.replace(/^on/i,""),t=i.dom._g(t);var n,o=function(i){s.call(t,i)},a=i.event._listeners,r=i.event._eventFilter,h=e;return e=e.toLowerCase(),r&&r[e]&&(h=(n=r[e](t,e,o)).type,o=n.listener),t.addEventListener?t.addEventListener(h,o,!1):t.attachEvent&&t.attachEvent("on"+h,o),a[a.length]=[t,e,s,o,h],t},i.on=i.event.on,i.event.un=function(t,e,s){t=i.dom._g(t),e=e.replace(/^on/i,"").toLowerCase();for(var n,o,a,r=i.event._listeners,h=r.length,d=!s;h--;)(n=r[h])[1]!==e||n[0]!==t||!d&&n[2]!==s||(o=n[4],a=n[3],t.removeEventListener?t.removeEventListener(o,a,!1):t.detachEvent&&t.detachEvent("on"+o,a),r.splice(h,1));return t},i.un=i.event.un,i.dom.g=function(t){return"string"==typeof t||t instanceof String?document.getElementById(t):t&&t.nodeName&&(1==t.nodeType||9==t.nodeType)?t:null},i.g=i.G=i.dom.g,i.string=i.string||{},i.browser=i.browser||{},i.browser.ie=i.ie=/msie (\d+\.\d+)/i.test(navigator.userAgent)?document.documentMode||+RegExp.$1:void 0,i.dom._NAME_ATTRS=function(){var t={cellpadding:"cellPadding",cellspacing:"cellSpacing",colspan:"colSpan",rowspan:"rowSpan",valign:"vAlign",usemap:"useMap",frameborder:"frameBorder"};return i.browser.ie<8?(t.for="htmlFor",t.class="className"):(t.htmlFor="for",t.className="class"),t}(),i.dom.setAttr=function(t,e,s){return t=i.dom.g(t),"style"==e?t.style.cssText=s:(e=i.dom._NAME_ATTRS[e]||e,t.setAttribute(e,s)),t},i.setAttr=i.dom.setAttr,i.dom.setAttrs=function(t,e){t=i.dom.g(t);for(var s in e)i.dom.setAttr(t,s,e[s]);return t},i.setAttrs=i.dom.setAttrs,i.dom.create=function(t,e){var s=document.createElement(t),n=e||{};return i.dom.setAttrs(s,n)},t.undope=!0;var e=BMapLib.SearchInfoWindow=function(t,i,e){this.guid=s++,BMapLib.SearchInfoWindow.instance[this.guid]=this,this._isOpen=!1,this._map=t,this._opts=e=e||{},this._content=i||"",this._opts.width=e.width,this._opts.height=e.height,this._opts._title=e.title||"",this._opts.offset=e.offset||new BMap.Size(0,0),this._opts.enableAutoPan=!1!==e.enableAutoPan,this._opts._panel=e.panel||null,this._opts._searchTypes=e.searchTypes};e.prototype=new BMap.Overlay,e.prototype.initialize=function(t){this._closeOtherSearchInfo();var e=this,s=this._createSearchTemplate(),n=t.getPanes().floatPane;return n.style.width="auto",n.appendChild(s),this._initSearchTemplate(),this._getSearchInfoWindowSize(),this._boxWidth=parseInt(this.container.offsetWidth,10),this._boxHeight=parseInt(this.container.offsetHeight,10),i.event.on(s,"onmousedown",function(t){e._stopBubble(t)}),i.event.on(s,"onmouseover",function(t){e._stopBubble(t)}),i.event.on(s,"click",function(t){e._stopBubble(t)}),i.event.on(s,"dblclick",function(t){e._stopBubble(t)}),s},e.prototype.draw=function(){this._isOpen&&this._adjustPosition(this._point)},e.prototype.open=function(t){this._map.closeInfoWindow();var i,e=this;this._isOpen||(this._map.addOverlay(this),this._isOpen=!0,setTimeout(function(){e._dispatchEvent(e,"open",{point:e._point})},10)),t instanceof BMap.Point?(i=t,this._removeMarkerEvt(),this._marker=null):t instanceof BMap.Marker&&(this._marker&&this._removeMarkerEvt(),i=t.getPosition(),this._marker=t,!this._markerDragend&&this._marker.addEventListener("dragend",this._markerDragend=function(t){e._point=t.point,e._adjustPosition(e._point),e._panBox(),e.show()}),!this._markerDragging&&this._marker.addEventListener("dragging",this._markerDragging=function(){e.hide(),e._point=e._marker.getPosition(),e._adjustPosition(e._point)})),this.show(),this._point=i,this._panBox(),this._adjustPosition(this._point)},e.prototype.close=function(){this._isOpen&&(this._map.removeOverlay(this),this._disposeAutoComplete(),this._isOpen=!1,this._dispatchEvent(this,"close",{point:this._point}))},e.prototype.enableAutoPan=function(){this._opts.enableAutoPan=!0},e.prototype.disableAutoPan=function(){this._opts.enableAutoPan=!1},e.prototype.setContent=function(t){this._setContent(t),this._getSearchInfoWindowSize(),this._adjustPosition(this._point)},e.prototype.setTitle=function(t){this.dom.title.innerHTML=t,this._opts._title=t},e.prototype.getContent=function(){return this.dom.content.innerHTML},e.prototype.getTitle=function(){return this.dom.title.innerHTML},e.prototype.setPosition=function(t){this._point=t,this._adjustPosition(t),this._panBox(),this._removeMarkerEvt()},e.prototype.getPosition=function(){return this._point},e.prototype.getOffset=function(){return this._opts.offset},i.object.extend(e.prototype,{_closeOtherSearchInfo:function(){for(var t=BMapLib.SearchInfoWindow.instance,i=t.length;i--;)t[i]._isOpen&&t[i].close()},_setContent:function(t){if(this.dom&&this.dom.content){void 0===t.nodeType?this.dom.content.innerHTML=t:this.dom.content.appendChild(t);this._adjustContainerWidth(),this._content=t}},_adjustPosition:function(t){var i=this._getPointPosition(t),e=this._marker&&this._marker.getIcon();this._marker?(this.container.style.bottom=-(i.y-this._opts.offset.height-e.anchor.height+e.infoWindowAnchor.height)-this._marker.getOffset().height+2+30+"px",this.container.style.left=i.x-e.anchor.width+this._marker.getOffset().width+e.infoWindowAnchor.width-this._boxWidth/2+28+"px"):(this.container.style.bottom=30-(i.y-this._opts.offset.height)+"px",this.container.style.left=i.x-this._boxWidth/2+25+"px")},_getPointPosition:function(t){return this._pointPosition=this._map.pointToOverlayPixel(t),this._pointPosition},_getSearchInfoWindowSize:function(){this._boxWidth=parseInt(this.container.offsetWidth,10),this._boxHeight=parseInt(this.container.offsetHeight,10)},_stopBubble:function(t){t&&t.stopPropagation?t.stopPropagation():window.event.cancelBubble=!0},_panBox:function(){if(this._opts.enableAutoPan){var t=parseInt(this._map.getContainer().offsetHeight,10),i=parseInt(this._map.getContainer().offsetWidth,10),e=this._boxHeight,s=this._boxWidth;if(!(e>=t||s>=i)){this._map.getBounds().containsPoint(this._point)||this._map.setCenter(this._point);var n,o,a=this._map.pointToPixel(this._point),r=s/2-28-a.x+10,h=s/2+28+a.x-i+10;if(this._marker)var d=this._marker.getIcon();var c=this._marker?d.anchor.height+this._marker.getOffset().height-d.infoWindowAnchor.height:0;n=e-a.y+this._opts.offset.height+c+31+10,panX=r>0?r:h>0?-h:0,o=n>0?n:0,this._map.panBy(panX,o)}}},_removeMarkerEvt:function(){this._markerDragend&&this._marker.removeEventListener("dragend",this._markerDragend),this._markerDragging&&this._marker.removeEventListener("dragging",this._markerDragging),this._markerDragend=this._markerDragging=null},_dispatchEvent:function(t,e,s){0!=e.indexOf("on")&&(e="on"+e);var n=new i.lang.Event(e);if(s)for(var o in s)n[o]=s[o];t.dispatchEvent(n)},_initSearchTemplate:function(){this._initDom(),this._initPanelTemplate(),this.setTitle(this._opts._title),this._opts.height&&(this.dom.content.style.height=parseInt(this._opts.height,10)+"px"),this._setContent(this._content),this._initService(),this._bind(),this._opts._searchTypes&&this._setSearchTypes(),this._mendIE6()},_createSearchTemplate:function(){if(!this._div){var t=i.dom.create("div",{class:"BMapLib_SearchInfoWindow",id:"BMapLib_SearchInfoWindow"+this.guid}),e=['<div class="BMapLib_bubble_top">','<div class="BMapLib_bubble_title" id="BMapLib_bubble_title'+this.guid+'"></div>','<div class="BMapLib_bubble_tools">','<div class="BMapLib_bubble_close" title="关闭" id="BMapLib_bubble_close'+this.guid+'">',"</div>",'<div class="BMapLib_sendToPhone" title="发送到手机" id="BMapLib_sendToPhone'+this.guid+'">',"</div>","</div>","</div>",'<div class="BMapLib_bubble_center">','<div class="BMapLib_bubble_content" id="BMapLib_bubble_content'+this.guid+'">',"</div>",'<div class="BMapLib_nav" id="BMapLib_nav'+this.guid+'">','<ul class="BMapLib_nav_tab" id="BMapLib_nav_tab'+this.guid+'">','<li class="BMapLib_first BMapLib_current" id="BMapLib_tab_search'+this.guid+'" style="display:block;">','<span class="BMapLib_icon BMapLib_icon_nbs"></span>在附近找',"</li>",'<li class="" id="BMapLib_tab_tohere'+this.guid+'" style="display:block;">','<span class="BMapLib_icon BMapLib_icon_tohere"></span>到这里去',"</li>",'<li class="" id="BMapLib_tab_fromhere'+this.guid+'" style="display:block;">','<span class="BMapLib_icon BMapLib_icon_fromhere"></span>从这里出发',"</li>","</ul>",'<ul class="BMapLib_nav_tab_content">','<li id="BMapLib_searchBox'+this.guid+'">','<table width="100%" align="center" border=0 cellpadding=0 cellspacing=0>','<tr><td style="padding-left:8px;"><input id="BMapLib_search_text'+this.guid+'" class="BMapLib_search_text" type="text" maxlength="100" autocomplete="off"></td><td width="55" style="padding-left:7px;"><input id="BMapLib_search_nb_btn'+this.guid+'" type="submit" value="搜索" class="iw_bt"></td></tr>',"</table>","</li>",'<li id="BMapLib_transBox'+this.guid+'" style="display:none">','<table width="100%" align="center" border=0 cellpadding=0 cellspacing=0>','<tr><td width="30" style="padding-left:8px;"><div id="BMapLib_stationText'+this.guid+'">起点</div></td><td><input id="BMapLib_trans_text'+this.guid+'" class="BMapLib_trans_text" type="text" maxlength="100" autocomplete="off"></td><td width="106" style="padding-left:7px;"><input id="BMapLib_search_bus_btn'+this.guid+'" type="button" value="公交" class="iw_bt" style="margin-right:5px;"><input id="BMapLib_search_drive_btn'+this.guid+'" type="button" class="iw_bt" value="驾车"></td></tr>',"</table>","</li>","</ul>","</div>","</div>",'<div class="BMapLib_bubble_bottom"></div>','<img src="//'+G_PUBLICIP+'/api7/library/SearchInfoWindow/1.4/src/iw_tail.png" width="58" height="31" alt="" class="BMapLib_trans" id="BMapLib_trans'+this.guid+'" style="left:144px;"/>'];t.innerHTML=e.join(""),this._div=t}return this._div},_initPanelTemplate:function(){var t=i.g(this._opts._panel);if(!this.dom.panel&&t){t.innerHTML="",this.dom.panel=t;var e=i.dom.create("div");e.style.cssText="display:none;background:#FD9;height:30px;line-height:30px;text-align:center;font-size:12px;color:#994C00;",t.appendChild(e),this.dom.panel.address=e;var s=i.dom.create("div");t.appendChild(s),this.dom.panel.localSearch=s}},_initDom:function(){this.dom||(this.dom={container:i.g("BMapLib_SearchInfoWindow"+this.guid),content:i.g("BMapLib_bubble_content"+this.guid),title:i.g("BMapLib_bubble_title"+this.guid),closeBtn:i.g("BMapLib_bubble_close"+this.guid),transIco:i.g("BMapLib_trans"+this.guid),navBox:i.g("BMapLib_nav"+this.guid),navTab:i.g("BMapLib_nav_tab"+this.guid),seartTab:i.g("BMapLib_tab_search"+this.guid),tohereTab:i.g("BMapLib_tab_tohere"+this.guid),fromhereTab:i.g("BMapLib_tab_fromhere"+this.guid),searchBox:i.g("BMapLib_searchBox"+this.guid),transBox:i.g("BMapLib_transBox"+this.guid),stationText:i.g("BMapLib_stationText"+this.guid),nbBtn:i.g("BMapLib_search_nb_btn"+this.guid),busBtn:i.g("BMapLib_search_bus_btn"+this.guid),driveBtn:i.g("BMapLib_search_drive_btn"+this.guid),searchText:i.g("BMapLib_search_text"+this.guid),transText:i.g("BMapLib_trans_text"+this.guid)},this.container=this.dom.container)},_adjustContainerWidth:function(){var t=250;this._opts.width?(t=parseInt(this._opts.width,10),t+=10):t=parseInt(this.dom.content.offsetWidth,10),t<250&&(t=250),this._width=t,this.container.style.width=this._width+"px",this._adjustTransPosition()},_adjustTransPosition:function(){this.dom.transIco.style.left=this.container.offsetWidth/2-2-29+"px",this.dom.transIco.style.top=this.container.offsetHeight-2+"px"},_initService:function(){var t=this._map,i=this,e={};e.map=t,this.dom.panel&&(e.panel=this.dom.panel.localSearch),this.localSearch||(this.localSearch=new BMap.LocalSearch(t,{renderOptions:e,onSearchComplete:function(t){i._clearAddress(),i._drawCircleBound()}})),this.transitRoute||(this.transitRoute=new BMap.TransitRoute(t,{renderOptions:e,onSearchComplete:function(t){i._transitRouteComplete(i.transitRoute,t)}})),this.drivingRoute||(this.drivingRoute=new BMap.DrivingRoute(t,{renderOptions:e,onSearchComplete:function(t){i._transitRouteComplete(i.drivingRoute,t)}}))},_bind:function(){var t=this;i.on(this.dom.closeBtn,"click",function(i){t.close()}),i.on(this.dom.seartTab,"click",function(i){t._showTabContent(BMAPLIB_TAB_SEARCH)}),i.on(this.dom.tohereTab,"click",function(i){t._showTabContent(BMAPLIB_TAB_TO_HERE)}),i.on(this.dom.fromhereTab,"click",function(i){t._showTabContent(BMAPLIB_TAB_FROM_HERE)}),i.on(this.dom.nbBtn,"click",function(i){t._localSearchAction()}),i.on(this.dom.busBtn,"click",function(i){t._transitRouteAction(t.transitRoute)}),i.on(this.dom.driveBtn,"click",function(i){t._transitRouteAction(t.drivingRoute)}),this._autoCompleteIni()},_showTabContent:function(t){this._hideAutoComplete();for(var i=this.dom.navTab.getElementsByTagName("li"),e=i.length,s=0,e=i.length;s<e;s++)i[s].className="";switch(t){case BMAPLIB_TAB_SEARCH:this.dom.seartTab.className="BMapLib_current",this.dom.searchBox.style.display="block",this.dom.transBox.style.display="none";break;case BMAPLIB_TAB_TO_HERE:this.dom.tohereTab.className="BMapLib_current",this.dom.searchBox.style.display="none",this.dom.transBox.style.display="block",this.dom.stationText.innerHTML="起点",this._pointType="endPoint";break;case BMAPLIB_TAB_FROM_HERE:this.dom.fromhereTab.className="BMapLib_current",this.dom.searchBox.style.display="none",this.dom.transBox.style.display="block",this.dom.stationText.innerHTML="终点",this._pointType="startPoint"}this._firstTab.className+=" BMapLib_first"},_autoCompleteIni:function(){this.searchAC=new BMap.Autocomplete({input:this.dom.searchText,location:this._map}),this.transAC=new BMap.Autocomplete({input:this.dom.transText,location:this._map})},_hideAutoComplete:function(){this.searchAC.hide(),this.transAC.hide()},_disposeAutoComplete:function(){this.searchAC.dispose(),this.transAC.dispose()},_localSearchAction:function(){var t=this._kw=this.dom.searchText.value;if(""==t)this.dom.searchText.focus();else{this._reset(),this.close();var i=this._radius=1e3;this.localSearch.searchNearby(t,this._point,i)}},_drawCircleBound:function(){this._closeCircleBound();var t=this._searchCircle=new BMap.Circle(this._point,this._radius,{strokeWeight:3,strokeOpacity:.4,strokeColor:"#e00",filColor:"#00e",fillOpacity:.4}),i=this._searchLabel=new BMap.Label('<div onmousedown ="BMapLib.SearchInfoWindow.instance['+this.guid+']._stopBubble()"><input type="text" value="'+this._radius+'" style="width:30px;" id="BMapLib_search_radius'+this.guid+'"/>m <a href="javascript:void(0)" title="修改" onclick="BMapLib.SearchInfoWindow.instance['+this.guid+']._changeSearchRadius()" style="text-decoration:none;color:blue;">修改</a><img src="//'+G_PUBLICIP+'/api7/images/iw_close1d3.gif" alt="关闭" title="关闭" style="cursor:pointer;padding:0 5px;" onclick="BMapLib.SearchInfoWindow.instance['+this.guid+']._closeCircleBound()"/></div>',{position:this._point});this._map.addOverlay(t),this._map.addOverlay(i),this._hasCircle=!0},_changeSearchRadius:function(){var t=parseInt(i.g("BMapLib_search_radius"+this.guid).value,10);t>0&&t!=this._radius&&(this._radius=t,this.localSearch.searchNearby(this._kw,this._point,t),this._closeCircleBound())},_closeCircleBound:function(t){this._searchCircle&&this._map.removeOverlay(this._searchCircle),this._searchLabel&&this._map.removeOverlay(this._searchLabel),this._hasCircle=!1},_transitRouteAction:function(t){var i=this.dom.transText.value;if(""==i)this.dom.transText.focus();else{this._reset(),this.close();var e=this._getTransPoi(i);t.search(e.start,e.end)}},_transitRouteComplete:function(t,i){this._clearAddress();if(t.getStatus()==BMAP_STATUS_UNKNOWN_ROUTE){var e=i.getStartStatus(),s=i.getEndStatus(),n="";n="找不到相关的线路",e==BMAP_ROUTE_STATUS_EMPTY&&s==BMAP_ROUTE_STATUS_EMPTY?n="找不到相关的起点和终点":(e==BMAP_ROUTE_STATUS_EMPTY&&(n="找不到相关的起点"),s==BMAP_ROUTE_STATUS_EMPTY&&(n="找不到相关的终点")),"startPoint"==this._pointType&&s==BMAP_ROUTE_STATUS_ADDRESS||"endPoint"==this._pointType&&e==BMAP_ROUTE_STATUS_ADDRESS?this._searchAddress(t):(this.dom.panel.address.style.display="block",this.dom.panel.address.innerHTML=n)}},_searchAddress:function(t){var e=this,s=this.dom.panel;if(!this.lsAddress){var n={map:this._map};s&&(n.panel=this.dom.panel.localSearch),this.lsAddress=new BMap.LocalSearch(map,{renderOptions:n})}var o="startPoint"==e._pointType?"终点":"起点";s&&(this.dom.panel.address.style.display="block",this.dom.panel.address.innerHTML="请选择准确的"+o),this.lsAddress.setInfoHtmlSetCallback(function(s,n){var a=document.createElement("div");a.style.cssText="position:relative;left:50%;margin:5px 0 0 -30px;width:60px;height:27px;line-height:27px;border:1px solid #E0C3A6;text-align:center;color:#B35900;cursor:pointer;background-color:#FFEECC;border-radius:2px; background-image: -webkit-gradient(linear, left top, left bottom, from(#FFFDF8), to(#FFEECC))",a.innerHTML="设为"+o,n.appendChild(a),i.on(a,"click",function(){e._clearAddress();var i=s.marker.getPosition();"起点"==o?t.search(i,e._point):t.search(e._point,i)})}),this._reset(),this.lsAddress.search(this.dom.transText.value)},_getTransPoi:function(t){var i,e;return"startPoint"==this._pointType?(i=this._point,e=t):(i=t,e=this._point),{start:i,end:e}},_setSearchTypes:function(){var t,e=this._unique(this._opts._searchTypes),s=this.dom.navTab,n=[this.dom.seartTab,this.dom.tohereTab,this.dom.fromhereTab],o=0,a=0,r=0;if(this.tabLength=e.length,tabWidth=Math.floor((this._width-this.tabLength+1)/this.tabLength),0==e.length)this.dom.navBox.style.display="none";else{for(o=0,a=n.length;o<a;o++)n[o].className="",n[o].style.display="none";for(o=0;o<this.tabLength;o++){if(t=n[e[o]],0==o&&(t.className="BMapLib_first BMapLib_current",this._firstTab=t,r=e[o]),o==this.tabLength-1){var h=this._width-(this.tabLength-1)*(tabWidth+1);6==i.browser.ie?t.style.width=h-3+"px":t.style.width=h+"px"}else t.style.width=tabWidth+"px";t.style.display="block"}void 0!=e[1]&&s.appendChild(n[e[1]]),void 0!=e[2]&&s.appendChild(n[e[2]]),this._showTabContent(r)}this._adjustTransPosition()},_unique:function(t){for(var i,e,s=t.length,n=t.slice(0);--s>=0;)if((e=n[s])<0||e>2)n.splice(s,1);else for(i=s;i--;)if(e==n[i]){n.splice(s,1);break}return n},_reset:function(){this.localSearch.clearResults(),this.transitRoute.clearResults(),this.drivingRoute.clearResults(),this._closeCircleBound(),this._hideAutoComplete()},_clearAddress:function(){this.lsAddress&&this.lsAddress.clearResults(),this.dom.panel&&(this.dom.panel.address.style.display="none")},_mendIE6:function(t){if(i.browser.ie&&!(i.browser.ie>6))for(var e=this.container.getElementsByTagName("IMG"),s=0;s<e.length;s++)e[s].src.indexOf(".png")<0||(e[s].style.cssText+=";FILTER: progid:DXImageTransform.Microsoft.AlphaImageLoader(src="+e[s].src+",sizingMethod=crop)",e[s].src="//"+G_PUBLICIP+"/api7/images/blank.gif")}});var s=0;BMapLib.SearchInfoWindow.instance=[]}();