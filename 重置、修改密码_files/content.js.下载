// 接入插码
var _cmosq = _cmosq || [];
_cmosq.push(['sid', 'ngkm']);
var _root = window.location.host;
var _isTest = true;
if (_root != "localhost:18080" && _root != "localhost:8088" && _root != "192.168.100.36:8843" && _root != "127.0.0.1:18080" && _root != "ngkmcrm.cs.cmos"  && _root != "172.20.118.15:10010") {
    _isTest = false;
}
var loctionHref = window.location.href;
var serverHref = 'ngkm.cs.cmos';
if (loctionHref.indexOf(serverHref) >= '0') {
    _cmosq.push(['dataType', 'knowledge']);
} else {
    _cmosq.push(['dataType', 'knowledgetest']);
}
if (!_isTest) {
    var prov = window.localStorage.getItem("prov");
    _cmosq.push(['prov', prov]);
}
// 调用插码主函数
(function () {
    if (!_isTest) {
        var ma = document.createElement('script');
        ma.type = 'text/javascript';
        ma.async = true;
        //ma.src = ('https:' == document.location.protocol ? 'https://ngans.cs.cmos/ngans/' : 'http://ngans.cs.cmos/ngans/') + 'ngans.js';
        ma.src = window.location.protocol + "//" + window.location.host + '/ngkm/src/assets/common/ngans.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ma, s);
    }
})();
define([
    "Util",
    'crossAPI',
    'jquery',
    'js/constants/kmUtil',
    'js/knowledge/dialog',
    'js/personalCenter/MyAlert',
    'js/knowledge/jumpTo/navigateBars',
    'js/constants/constants',
    'js/knowledge/conMethod',
    'js/knowledge/messageSendNew',
    'js/knowledge/search/knowledgeSearch',
    'text!modules/knowledgeAppNew/knowledgeAttrAtomPreview.tpl',
    'js/knowledgeAppNew/contentSelect',
    'js/knowledgeAppNew/clickProcess',
    'js/personalCenterNew/klgFdbkSend',
    'text!modules/knowledgeAppNew/knowledgeInfoGroupexception.tpl',
    'text!modules/knowledgeAppNew/knowledgeInfoGroupexceptionZhujie.tpl',
    'video',
    'image',
    'dialog'
], function (Util, CrossAPI, $, kmUtil, dialog, myAlert, navigateBars, Constants, conMethod, msgSd, knowledgeSearch, knowledgeAttrAtomPreview, ContentSelect,clickProcess,klgFdbkSend ,knowledgeInfoGroupexception,knowledgeInfoGroupexceptionZhujie,Video, Image, Dialog) {
    var $detailLeft = $(".detail-left");
    var leftConWrap = $detailLeft.find(".left-content-wrap");
    var catelog = $detailLeft.find(".side-catelog");
    var layout_switch_wrap = $detailLeft.find(".layout-switch-wrap");

    //知识内容区域
    var knowdDetail = $(".knowd-detail");
    var $layout = $("#layout");
    //布局切换区
    var layoutSwitch = knowdDetail.find(".left-catelog-wrap");
    var $detaiTitle = knowdDetail.find(".detail-title");
    //不可发送项
    var notSendMessage = knowdDetail.find(".notSendMessage");
    var $detailTop = $(".detail-top");
    var $searchClick = $detailTop.find("#searchClick");
    var $topSearchInput = $searchClick.find("#topSearchInput");
    var atomImgAll = [];
    var imgIndex = 0;//当前图片在atomImgAll集合中的索引
    var $imgInner = $("#img-inner");
    var $imgContent = $("#img-content");
    var $imgLeft = $imgContent.find("#img-left");
    var $imgRight = $imgContent.find("#img-right");
    var domArray = null;
    var fireEvent = {};
    var lastNumAssCode = "";
    var obj = [];
    var searchNo = "0";
    var $detailRight = $(".detail-right");
    var IEVersionflag;//ie版本
    var platform;//系统版本
    /*var keyWord = urlParameter.keyWord; //关键词
    var light = urlParameter.light;//高亮设置*/
    var keyWord = kmUtil.getUrlParamter("keyWord"); //关键词
    keyWord = Constants.kmDecodeURl(decodeURIComponent(keyWord));
    var light = kmUtil.getUrlParamter("light");//高亮设置
    var inputKeyWord = "";//输入的关键词
    var cityScope;
    var serviceCode = kmUtil.getUrlParamter("sysCode");
    var accessType = "3";
    var serviceName = kmUtil.getUrlParamter("serviceName");
    var defaultCloseBtnState = $('#closeRight').find("span").text();//初始闭合状态

    //将头信息存入localStorge中
    var sessionId = kmUtil.getUrlParamter("kmsessionId");
    if(sessionId) {
        window.localStorage.setItem("sessionId",sessionId);
    }

    if (kmUtil.getUrlParamter("accessType")) {
        accessType = kmUtil.getUrlParamter("accessType");
    }
    var knwlgAls;
    // provId 省份编码
    var provId;
    var $orangeLine;
    var alsNameAll="";//原始知识别名
    var alsNameSub="";//截取后知识别名
    var searchKeyWordAll="";//原始搜索关键词
    var searchKeyWordSub="";//截取后搜索关键词
    var UnrealWords = '';//初始模拟搜索关键词
    var searchIndex = 0;//上下一个index
    var showSearchIndex = 0;//显示的上下一个index
    var divAdd = "<div class=\"above-arrow arrow-left\">\n" +
        "                            <div class=\"arrow-bg\"></div>\n" +
        "                            <a href=\"#nogo\" title=\"左移\">\n" +
        "                            <i class=\"icon km-hmleft\"></i>\n" +
        "                            </a>\n" +
        "                            </div>\n" +
        "                            <div class=\"above-arrow arrow-right\">\n" +
        "                            <div class=\"arrow-bg\"></div>\n" +
        "                            <a href=\"#nogo\" title=\"右移\">\n" +
        "                            <i class=\"icon km-hmright\"></i>\n" +
        "                            </a>\n" +
        "                            </div>";
    var knowledgeDetailInfo;//知识详情
    var lazyImg="";
    //查询知识详情
    var getKnowledgeInfo = function (callback) {
        verNo = kmUtil.getUrlParamter("verNo");//版本号
        if (knowledgeDetailInfo != undefined) {
            return;
        }
        var config = {
            type: 'post',  //请求类型 '../../../data.json'
            url: Constants.AJAXURL + '/knowledge/getKmDetatil', //Constants.AJAXURL + '/knowledge/getKmDetatil',  接受请求的地址
            data: {knwldgeId: knwlgId, verNo: verNo},  //要传递给url的数据 "knwldgeId": "201712232219151092"
            dataType: 'json', //返回值的数据类型
            success: function (data, textStatus) {
                if (textStatus !== "success") {

                    return false;
                }
                if (data.returnCode !== '0') {
                    return false;
                }
                if (data.object === null || data.object === undefined) {
                    return false;
                }
                knowledgeDetailInfo = data.object;
                if (callback) {
                    callback();
                }
                // console.log('知识详情：：',knowledgeDetailInfo);
            },  //url调用成功后执行的回调函数
            error: function (jqXHR, textStatus, errorThrown) {
                // new myAlert({'type': 'error', 'text': errorThrown});
            }  //url调用失败后执行的回调函数
        };
        Util.ajax.ajax(config);
    };

    /**
     * 检索dom列表
     * @returns {*|jQuery.fn.init|n.fn.init|jQuery|HTMLElement}
     */
    var initDom = function () {
        // <editor-fold desc="神策埋点开关控制">
        if(kmUtil.getOriginType("http://") || kmUtil.getOriginType("https://")){
            Util.ajax.getJson(Constants.AJAXURL + "/sensorsdata/getSensorsdata?t=" + + new Date().getTime(),{},function (data) {
                if(data.returnCode == 0 && data.object == "true"){
                    sensorsDataInit();
                }
            });
        }
        // </editor-fold>
        return $detailLeft.find(".detail-title:first,.left-catelog-wrap:first,.left-content-wrap");
    };

    function initdomArray() {
        return domArray = initDom();
    }

    initdomArray();

    // <editor-fold desc="前端埋点神策 SDK 初始化">
    var sensorsDataInit = function() {
        var env = Constants.getEnvment();
        var receiveUrl = 'http://sensors.ipaas.cmos/sa?project=production';
        if (Constants.NGKM_ENVIROMENT_DEV == env) {
            receiveUrl = Constants.getSensorsTestEnvReceiveUrl();
        } else if (Constants.NGKM_ENVIROMENT_TEST == env) {
            receiveUrl = Constants.getSensorsTestEnvReceiveUrl();
        } else {
            var httpType = window.location.protocol;
            if ('https:' == httpType) {
                receiveUrl = 'https://sensors.ipaas.cmos:20443/sa?project=production';
            }else {
                receiveUrl = 'http://sensors.ipaas.cmos/sa?project=production';
            }
        }
        (function (para) {
            var p = para.sdk_url, n = para.name, w = window, d = document, s = 'script', x = null, y = null;
            if(typeof(w['sensorsDataAnalytic201505']) !== 'undefined') {
                return false;
            }
            w['sensorsDataAnalytic201505'] = n;
            w[n] = w[n] || function (a) {
                return function () {
                    (w[n]._q = w[n]._q || []).push([a, arguments]);
                }
            };
            var ifs = ['track', 'quick', 'register', 'registerPage', 'registerOnce', 'clearAllRegister', 'trackSignup', 'trackAbtest', 'setProfile', 'setOnceProfile', 'appendProfile', 'incrementProfile', 'deleteProfile', 'unsetProfile', 'identify', 'login', 'logout', 'trackLink', 'clearAllRegister'];
            for (var i = 0; i < ifs.length; i++) {
                w[n][ifs[i]] = w[n].call(null, ifs[i]);
            }
            if (!w[n]._t) {
                x = d.createElement(s), y = d.getElementsByTagName(s)[0];
                x.async = 1;
                x.src = p;

                w[n].para = para;
                y.parentNode.insertBefore(x, y);
            }
        })({
            sdk_url: '../../../js/sensorsdata.min.js',
            name: 'sensorsdata',
            // server_url: 'http://172.22.243.150:8107/index.html?project=production'//神策数据接收地址
            server_url: receiveUrl,//神策数据接收地址
            heatmap_url: "../../../js/heatmap.min.js",
            heatmap:{
                clickmap:'default',
                scroll_notice_map:'default',
                collect_elements:"all"
            }
        });

        if(sensorsdata){
            Util.ajax.getJson(Constants.AJAXURL + '/user/session' + "?t=" + new Date().getTime(), {}, function (data, state) {
                if (state) {
                    if (data && data.bean) {
                        provId = data.bean.provnce;
                        var provinceName = '';
                        var superRrl2 = Constants.AJAXURL + '/kmConfig/getCacheCityByRegnId';
                        Util.ajax.postJson(superRrl2, {regnId: data.bean.provnce}, function (json, status) {
                            if (status){
                                provinceName = json.bean.regnNm;
                                //神策用户关联的方法，其中 user_id 为用户的真实 id，字符串或者数值类型都可以。
                                sensorsdata.identify(data.bean.staffCode,true);
                                //<editor-fold desc="神策要求添加的公共属性">
                                var call_id = "";
                                var call_mobile = "";
                                var dispose_mobile = "";
                                var belong_city = "";
                                var is_call = false;
                                if (kmUtil.getUrlParamter("openMode")) {
                                    var openMode =  kmUtil.getUrlParamter("openMode");
                                    kmUtil.setOpenMode(openMode);
                                }
                                var openMode = window.localStorage.getItem("openMode");
                                if ("2" == openMode && CrossAPI.url != undefined) {
                                    CrossAPI.getContact("getCallingInfo",Constants.PARAMJSONCALL, function (CallingInfo) {
                                        if(CallingInfo){

                                            call_id = CallingInfo.callId ? CallingInfo.callId : "";
                                            call_mobile = CallingInfo.callerNo ? CallingInfo.callerNo : "";
                                            dispose_mobile = CallingInfo.subsNumber ? CallingInfo.subsNumber : "";
                                            is_call = true;
                                            belong_city = CallingInfo.destProvId ? CallingInfo.destProvId : "";
                                        }else{
                                            is_call = false;
                                        }
                                    });
                                }
                                //</editor-fold>
                                sensorsdata.registerPage({
                                    staff_id: data.bean.staffCode,
                                    staff_name: data.bean.staffName,
                                    provnce: data.bean.provnce,
                                    provinceName: provinceName,
                                    serviceTypeId: data.bean.ngmttServicetype,
                                    first_model: "知识库",
                                    login_system: "知识库系统", // 登录的业务系统
                                    call_id: call_id,
                                    call_mobile: call_mobile,
                                    dispose_mobile: dispose_mobile,
                                    belong_city: belong_city,
                                    is_call: is_call
                                });
                                sensorsdata.setProfile({
                                    staff_id: data.bean.staffCode,
                                    staff_name: data.bean.staffName,
                                    provnce: data.bean.provnce,
                                    serviceTypeId:data.bean.ngmttServicetype,
                                    login_system: "知识库系统" // 登录的业务系统
                                });
                                sensorsdata.quick("autoTrack");
                            }
                        })
                    }
                }
            })
        }
    };

    //</editor-fold>

    //处理预览原子内容
    function atomsRelateEvent() {
        var preAtom = $("#preAtomBlur");
        catelog.css('z-index','8');
        layout_switch_wrap.css('z-index','8');
        $detaiTitle.css('z-index','8');
        //图片类型下载
        preAtom.find("img[linkType = 'img']").each(function () {
            var _this = $(this);
            _this.addClass('sn-image-target');
            if(lazyImg=="1"){
                _this.addClass("lazy1");
               // _this.attr("src","data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNzEwMzIzNjE1ODQ3IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDExMTcgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEzMzM0IiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgd2lkdGg9IjIxOC4xNjQwNjI1IiBoZWlnaHQ9IjIwMCI+PHBhdGggZD0iTTk3Ny40NTQ1NDUgMGExMzkuNjM2MzY0IDEzOS42MzYzNjQgMCAwIDEgMTM5LjYzNjM2NCAxMzkuNjM2MzY0djc0NC43MjcyNzJhMTM5LjYzNjM2NCAxMzkuNjM2MzY0IDAgMCAxLTEzOS42MzYzNjQgMTM5LjYzNjM2NEgxMzkuNjM2MzY0YTEzOS42MzYzNjQgMTM5LjYzNjM2NCAwIDAgMS0xMzkuNjM2MzY0LTEzOS42MzYzNjRWMTM5LjYzNjM2NGExMzkuNjM2MzY0IDEzOS42MzYzNjQgMCAwIDEgMTM5LjYzNjM2NC0xMzkuNjM2MzY0ek0zMjEuMTYzNjM2IDQ5NS44NDg3MjdMOTMuMDkwOTA5IDc2MS45MDI1NDVWODg0LjM2MzYzNmE0Ni41NDU0NTUgNDYuNTQ1NDU1IDAgMCAwIDQxLjA5OTYzNiA0Ni4yMTk2MzdMMTM5LjYzNjM2NCA5MzAuOTA5MDkxaDgzNy44MTgxODFhNDYuMzEyNzI3IDQ2LjMxMjcyNyAwIDAgMCAyMy4zMTkyNzMtNi4yMzcwOTEgNDIuOTE0OTA5IDQyLjkxNDkwOSAwIDAgMS04LjA1MjM2My01LjgxODE4MmwtNC4wNDk0NTUtNC4xODkwOTEtMTk2LjE4OTA5MS0yMzYuNjM3MDkxLTE1MS4wNCAxODguODgxNDU1YTQ2LjU0NTQ1NSA0Ni41NDU0NTUgMCAwIDEtNzEuNTg2OTA5IDEuMzk2MzY0bC0zLjQ5MDkwOS00LjY1NDU0NkwzMjEuMTYzNjM2IDQ5NS44NDg3Mjd6TTk3Ny40NTQ1NDUgOTMuMDkwOTA5SDEzOS42MzYzNjRhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMC00Ni41NDU0NTUgNDYuNTQ1NDU1djQ3OS4yMzJsMTk3LjM1MjcyNy0yMzAuMjYwMzY0YTQ2LjU0NTQ1NSA0Ni41NDU0NTUgMCAwIDEgNzAuNjU2LTAuMDQ2NTQ1bDMuNDQ0MzY0IDQuNTE0OTA5IDI0My45NDQ3MjcgMzY1Ljk0MDM2MyAxNDYuNDMyLTE4My4wMTY3MjdhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMSA2Ny42NzcwOTEtNS4zMDYxODJsNC4wMDI5MDkgNC4wOTZMMTAyNCA4MTEuNjU5NjM2VjEzOS42MzYzNjRhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMC00MS4wOTk2MzYtNDYuMjE5NjM3TDk3Ny40NTQ1NDUgOTMuMDkwOTA5eiBtLTE4Ni4xODE4MTggMTM5LjYzNjM2NGE5My4wOTA5MDkgOTMuMDkwOTA5IDAgMSAxIDAgMTg2LjE4MTgxOCA5My4wOTA5MDkgOTMuMDkwOTA5IDAgMCAxIDAtMTg2LjE4MTgxOHoiIGZpbGw9IiMwMDhkZjAiIHAtaWQ9IjEzMzM1Ij48L3BhdGg+PC9zdmc+");
                _this.attr("data-src", Constants.AJAXURL + "/file/download?key=NGKM_PICTURE_FILE&fileId=" + _this.attr("fileId"));

            }else{
                _this.attr("src", Constants.AJAXURL + "/file/download?key=NGKM_PICTURE_FILE&fileId=" + _this.attr("fileId"));
            }
           if (_this.hasClass("narrow")) {//cursor:pointer
                _this.css("cursor", "pointer");
            }
            var imgBorder = _this.attr("border");
            var borderColor = _this.css("border-color");
            if (imgBorder && imgBorder != "0" && borderColor) {
                _this.css("border", imgBorder + "px solid " + borderColor);
            }
        });
        //多媒体图片类型下载
        preAtom.find("img[linkTypes = 'imgDm']").each(function () {
            var _this = $(this);
            _this.addClass('sn-image-target');
            if(lazyImg=="1"){
                _this.addClass("lazy1");
                //_this.attr("src","data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNzEwMzIzNjE1ODQ3IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDExMTcgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEzMzM0IiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgd2lkdGg9IjIxOC4xNjQwNjI1IiBoZWlnaHQ9IjIwMCI+PHBhdGggZD0iTTk3Ny40NTQ1NDUgMGExMzkuNjM2MzY0IDEzOS42MzYzNjQgMCAwIDEgMTM5LjYzNjM2NCAxMzkuNjM2MzY0djc0NC43MjcyNzJhMTM5LjYzNjM2NCAxMzkuNjM2MzY0IDAgMCAxLTEzOS42MzYzNjQgMTM5LjYzNjM2NEgxMzkuNjM2MzY0YTEzOS42MzYzNjQgMTM5LjYzNjM2NCAwIDAgMS0xMzkuNjM2MzY0LTEzOS42MzYzNjRWMTM5LjYzNjM2NGExMzkuNjM2MzY0IDEzOS42MzYzNjQgMCAwIDEgMTM5LjYzNjM2NC0xMzkuNjM2MzY0ek0zMjEuMTYzNjM2IDQ5NS44NDg3MjdMOTMuMDkwOTA5IDc2MS45MDI1NDVWODg0LjM2MzYzNmE0Ni41NDU0NTUgNDYuNTQ1NDU1IDAgMCAwIDQxLjA5OTYzNiA0Ni4yMTk2MzdMMTM5LjYzNjM2NCA5MzAuOTA5MDkxaDgzNy44MTgxODFhNDYuMzEyNzI3IDQ2LjMxMjcyNyAwIDAgMCAyMy4zMTkyNzMtNi4yMzcwOTEgNDIuOTE0OTA5IDQyLjkxNDkwOSAwIDAgMS04LjA1MjM2My01LjgxODE4MmwtNC4wNDk0NTUtNC4xODkwOTEtMTk2LjE4OTA5MS0yMzYuNjM3MDkxLTE1MS4wNCAxODguODgxNDU1YTQ2LjU0NTQ1NSA0Ni41NDU0NTUgMCAwIDEtNzEuNTg2OTA5IDEuMzk2MzY0bC0zLjQ5MDkwOS00LjY1NDU0NkwzMjEuMTYzNjM2IDQ5NS44NDg3Mjd6TTk3Ny40NTQ1NDUgOTMuMDkwOTA5SDEzOS42MzYzNjRhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMC00Ni41NDU0NTUgNDYuNTQ1NDU1djQ3OS4yMzJsMTk3LjM1MjcyNy0yMzAuMjYwMzY0YTQ2LjU0NTQ1NSA0Ni41NDU0NTUgMCAwIDEgNzAuNjU2LTAuMDQ2NTQ1bDMuNDQ0MzY0IDQuNTE0OTA5IDI0My45NDQ3MjcgMzY1Ljk0MDM2MyAxNDYuNDMyLTE4My4wMTY3MjdhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMSA2Ny42NzcwOTEtNS4zMDYxODJsNC4wMDI5MDkgNC4wOTZMMTAyNCA4MTEuNjU5NjM2VjEzOS42MzYzNjRhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMC00MS4wOTk2MzYtNDYuMjE5NjM3TDk3Ny40NTQ1NDUgOTMuMDkwOTA5eiBtLTE4Ni4xODE4MTggMTM5LjYzNjM2NGE5My4wOTA5MDkgOTMuMDkwOTA5IDAgMSAxIDAgMTg2LjE4MTgxOCA5My4wOTA5MDkgOTMuMDkwOTA5IDAgMCAxIDAtMTg2LjE4MTgxOHoiIGZpbGw9IiMwMDhkZjAiIHAtaWQ9IjEzMzM1Ij48L3BhdGg+PC9zdmc+");
                _this.attr("data-src", Constants.AJAXURL + "/file/downloadWskm?key=MDKM_FILE_PATH&fileId=" + _this.attr("fileId"));
            }else{
                _this.attr("src", Constants.AJAXURL + "/file/downloadWskm?key=MDKM_FILE_PATH&fileId=" + _this.attr("fileId"));

            }
            if (_this.hasClass("narrow")) {//cursor:pointer
                _this.css("cursor", "pointer");
            }
            var imgBorder = _this.attr("border");
            var borderColor = _this.css("border-color");
            if (imgBorder && imgBorder != "0" && borderColor) {
                _this.css("border", imgBorder + "px solid " + borderColor);
            }
        });

        preAtom.find('.yuanzi-con').each(function () {
            var _this = $(this);
            if (_this.find("img[linkType = 'img']").length > 0) {
                _this.addClass('preview-img-wrap');
                var imgList = [];
                _this.find("img[linkType = 'img']").each(function () {
                    var $this = $(this);
                    var src = $this.attr('src');
                    imgList.push({
                        url: src,
                        name: $this.attr("fileid")
                    })
                })
                new Image({
                    el: _this,
                    showName: false, //是否显示图片名称,默认为true
                    showNum: true, //是否显示图片顺序,默认为true
                    showDownload: false, //是否可下载,默认为false
                    canPreview : true,
                    // downloadFn: function(){ //自定义下载功能，默认不配置，配置后会替换组件的下载逻辑
                    //     console.log('load.....',arguments)
                    // },
                    imgList: imgList
                })
                // $('.viewer-container').css("top", "40px");
            }
        })

        preAtom.find('.yuanzi-con').each(function () {
            var _this = $(this);
            if (_this.find("img[linkTypes = 'imgDm']").length > 0) {
                _this.addClass('preview-img-wrap');
                var imgList = [];
                _this.find("img[linkTypes = 'imgDm']").each(function () {
                    var $this = $(this);
                    var src = $this.attr('src');
                    imgList.push({
                        url: src,
                        name: $this.attr("fileid")
                    })
                })
                new Image({
                    el: _this,
                    showName: false, //是否显示图片名称,默认为true
                    showNum: true, //是否显示图片顺序,默认为true
                    showDownload: false, //是否可下载,默认为false
                    canPreview : true,
                    // downloadFn: function(){ //自定义下载功能，默认不配置，配置后会替换组件的下载逻辑
                    //     console.log('load.....',arguments)
                    // },
                    imgList: imgList
                })
                // $('.viewer-container').css("top", "40px");
            }
        })
        preAtom.find('.zhujie-con').each(function () {
            var _this = $(this);
            if (_this.find("img[linkType = 'img']").length > 0) {
                _this.addClass('preview-img-wrap');
                var imgList = [];
                _this.find("img[linkType = 'img']").each(function () {
                    var $this = $(this);
                    var src = $this.attr('src');
                    imgList.push({
                        url: src,
                        name: $this.attr("fileid")
                    })
                })
                new Image({
                    el: _this,
                    showName: false, //是否显示图片名称,默认为true
                    showNum: true, //是否显示图片顺序,默认为true
                    showDownload: false, //是否可下载,默认为false
                    canPreview : true,
                    // downloadFn: function(){ //自定义下载功能，默认不配置，配置后会替换组件的下载逻辑
                    //     console.log('load.....',arguments)
                    // },
                    imgList: imgList
                })
                // $('.viewer-container').css("top", "40px");
            }
        })

        preAtom.find('.zhujie-con').each(function () {
            var _this = $(this);
            if (_this.find("img[linkTypes = 'imgDm']").length > 0) {
                _this.addClass('preview-img-wrap');
                var imgList = [];
                _this.find("img[linkTypes = 'imgDm']").each(function () {
                    var $this = $(this);
                    var src = $this.attr('src');
                    imgList.push({
                        url: src,
                        name: $this.attr("fileid")
                    })
                })
                new Image({
                    el: _this,
                    showName: false, //是否显示图片名称,默认为true
                    showNum: true, //是否显示图片顺序,默认为true
                    showDownload: false, //是否可下载,默认为false
                    canPreview : true,
                    // downloadFn: function(){ //自定义下载功能，默认不配置，配置后会替换组件的下载逻辑
                    //     console.log('load.....',arguments)
                    // },
                    imgList: imgList
                })
                // $('.viewer-container').css("top", "40px");
            }
        })
        //附件类型预览
        preAtom.find("a[linkType = 'download']").each(function () {
            var _this = $(this);
            var sufix = _this.attr("sufix");
            var fileId = _this.attr("fileId");
            var fileName = encodeURIComponent(_this.html());
            if (sufix && sufix != "null") {
                _this.wrap("<div class=\"yuanzi-con fujian-con fujian-inline\"></div>");
                if (fileName)
                    _this.after("<span class=\"fj-preview download-preview\" title=\"预览\"><a href='#' id=\"viewFile.html?fileId=" + fileId + "&key=NGKM_FILE_ATTACH&fileSufix=" + sufix + "&fileName=" + encodeURIComponent(fileName) + "\"></a></span>");
            }
        });

        preAtom.find("img[linkType = 'emo']").each(function () {
            //处理表情包
            var src = $(this).attr("src");
            if (src) {
                $(this).attr("src", src.replace("/ngkmeditor/src/assets/img/emot", "/ngkm/src/assets/img/emot"));
            }
        });
        preAtom.find("object[linkType = 'video'],video[linkType = 'video']").each(function () {
            var $this = $(this);
            var width = $this.attr("width");
            var height = $this.attr("height");
            var fileId = $this.attr("fileId");
            var autostart = false;
            var _key = "NGKM_MEDIA_FILE";
            var link = window.location.protocol + "//" + window.location.host + Constants.AJAXURL + "/file/downloadMedia/" + _key + "/" + fileId;
            /*var userAgent = navigator.userAgent;
            var isIE = (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1);
            var fIEVersion;*/
            if(IEVersion()!="-1") {
                var object = '<object id="flv__id__' + fileId + '" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="' + width + '" height="' + height + '">\n' +
                    '<param name="wmode" value="transparent">' +
                    '<param name="movie" value="' + url_prefix + '/assets/plugin/flvplayer.swf">\n' +
                    '<param name="flashvars" value="file=' + link + '.mp4&autostart=' + autostart + '&image=&provider=video">\n' +
                    '<param name="quality" value="high">\n' +
                    '<param name="allowfullscreen" value="true">' +
                    '<embed wmode="transparent" type="application/x-shockwave-flash" src="' + url_prefix + '/assets/plugin/flvplayer.swf" width="' + width + '" height="' + height + '" flashvars="file=' + link + '.mp4&autostart=' + autostart + '&provider=video" quality="high" allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer"></embed>' +
                    '</object><br>';
                $this.replaceWith(object);
            }else{
                var $e2 = $('<div class="video'+fileId.split(".")[0]+'"  style="height: 480px; width: 400px;"></div>')
                $this.replaceWith($e2);
                var config = {
                    el: '.video'+fileId.split(".")[0],
                    className: 'video',
                    solution:'html,flash',
                    swfPath:url_prefix+'/assets/lib/jqueryPlugin/jPlayer/dist/jplayer',
                    autoPaly: 1, //是否自动播放，0手动播放|默认1自动播放
                    volume: 1, //音量设置，取值范围0-1，默认0.8
                    repeat: false, //是否循环播放 true|false,默认为false
                    shortcutKey: true,
                    minPlaybackRate: 1,//最小倍速，整数，默认为1，最小为1
                    playbackRate: 1,//默认倍速，整数，默认为1
                    rateStep: 2,//倍速每次改变的值，整数，默认为2
                    fullscreen: true,
                    remainingDuration: true, //为true时，播放器中默认显示剩余时长;为false时，默认显示总时长;
                    toggleDuration: true, //为true时，点击播放器中的时间，可以在 剩余时长/总时长 之间切换
                    url: link+'.mp4&autostart=false&image=&provider=video' //视频地址
                }
                var video = new Video(config); //生成自定义的音频组件。
            }
        });
        //多媒体视频
        preAtom.find("object[linkTypes = 'videoDm'],video[linkTypes = 'videoDm']").each(function () {
            var $this = $(this);
            var width = $this.attr("width");
            var height = $this.attr("height");
            var fileId = $this.attr("fileId");
            var autostart = false;
            var _key = "MDKM_FILE_PATH";
            var link = window.location.protocol + "//" + window.location.host + Constants.AJAXURL + "/file/downloadWskmMedia/" + _key + "/" + fileId;
            /*var userAgent = navigator.userAgent;
            var isIE = (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1);
            var fIEVersion;*/

            if(IEVersion()!="-1") {
                var object = '<object id="flv__id__' + fileId + '" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="' + width + '" height="' + height + '">\n' +
                    '<param name="wmode" value="transparent">' +
                    '<param name="movie" value="' + url_prefix + '/assets/plugin/flvplayer.swf">\n' +
                    '<param name="flashvars" value="file=' + link + '.mp4&autostart=' + autostart + '&image=&provider=video">\n' +
                    '<param name="quality" value="high">\n' +
                    '<param name="allowfullscreen" value="true">' +
                    '<embed wmode="transparent" type="application/x-shockwave-flash" src="' + url_prefix + '/assets/plugin/flvplayer.swf" width="' + width + '" height="' + height + '" flashvars="file=' + link + '.mp4&autostart=' + autostart + '&provider=video" quality="high" allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer"></embed>' +
                    '</object><br>';
                $this.replaceWith(object);
            }else{
                var $e2 = $('<div class="video'+fileId.split(".")[0]+'"  style="height: 480px; width: 400px;"></div>')
                $this.replaceWith($e2);
                var config = {
                    el: '.video'+fileId.split(".")[0],
                    className: 'video',
                    solution:'html,flash',
                    swfPath:url_prefix+'/assets/lib/jqueryPlugin/jPlayer/dist/jplayer',
                    autoPaly: 1, //是否自动播放，0手动播放|默认1自动播放
                    volume: 1, //音量设置，取值范围0-1，默认0.8
                    repeat: false, //是否循环播放 true|false,默认为false
                    shortcutKey: true,
                    minPlaybackRate: 1,//最小倍速，整数，默认为1，最小为1
                    playbackRate: 1,//默认倍速，整数，默认为1
                    rateStep: 2,//倍速每次改变的值，整数，默认为2
                    fullscreen: true,
                    remainingDuration: true, //为true时，播放器中默认显示剩余时长;为false时，默认显示总时长;
                    toggleDuration: true, //为true时，点击播放器中的时间，可以在 剩余时长/总时长 之间切换
                    url: link+'.mp4&autostart=false&image=&provider=video' //视频地址
                }
                var video = new Video(config); //生成自定义的音频组件。
            }
        });

        //解决ie11下表格bordercolor属性不起作用情况
        var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
        var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
        if (isIE11) {//如果为ie11
            preAtom.find(".yuanzi-con table").each(function () {
                var $this = $(this);
                var tableBorder = $this.attr("border");
                var borderColor = $this.attr("bordercolor");
                if (tableBorder && tableBorder != "0" && borderColor) {
                    $this.css("border", tableBorder + "px solid " + borderColor);
                }
            })
        }
        //点击关闭按钮
        preAtom.on("click", ".close", function () {
            var this_ = $(this);
            this_.parent().prev().removeClass('aft-preview');
            this_.parent().remove();
        });

    }

    var execpClick = function () {
        domArray.find(".left-words").each(function () {
            var _this = $(this);
            if (this.scrollWidth != undefined && this.clientWidth != undefined) {
                if (this.scrollWidth - this.clientWidth > 0) {
                    if (_this.find(".above-arrow").length == 0) {
                        _this.prepend(divAdd);
                        $(".above-arrow").hide();
                    }
                }
            }

        });

        domArray.find(".left-explain").each(function () {
            var _this = $(this);
            if (this.scrollWidth != undefined && this.clientWidth != undefined) {
                if (this.scrollWidth - this.clientWidth > 0) {
                    if (_this.find(".above-arrow").length == 0) {
                        _this.prepend(divAdd);
                        $(".above-arrow").hide();
                    }
                }
            }
        });
    };
    var doEcept = function (_this,exceptScope,type) {
        var regnId = _this.attr("regnId");
        var regnIds = regnId.split(",");
        for (var i = 0;i<regnIds.length;i++){
            if (regnIds[i] == exceptScope) {
                _this.parent("li").siblings().removeClass("active");
                _this.parent("li").addClass("active");
                var sel = _this.parents("div.atoms");
                var atomId = sel.attr("atomId");
                var regn = regnId.replace(/,/g, "");
                sel.children('.' + atomId).addClass("hide");
                sel.children("." + regn).removeClass("hide");
                var message;
                if (type == "1"){
                    message = _this.parents("div.nma").find("a.message");
                } else{
                    message = _this.parents("div.left-words").find("a.message");
                }
                if (_this.attr("isSendMes") === "1") {
                    message.addClass("hide").removeClass("notSendMessage");
                    _this.parents("div.left-words").find("a." + regn).removeClass("hide");
                } else {
                    message.addClass("hide");
                    _this.parents("div.left-words").find("a." + regn).removeClass("hide").addClass("notSendMessage");
                }
                var arrow = $(".left-words").find("div.above-arrow");
                if (arrow.length > 0) {
                    arrow.remove();
                }
                var explain = $(".left-explain").find("div.above-arrow");
                if (explain.length > 0) {
                    explain.remove();
                }
            }
        }

    }
    //富文本原子预览根据scope切换例外
    var refrushAtomExp = function (exceptScope) {
        domArray.find(".exceptionAtom").each(function () {
            var _this = $(this);
            doEcept(_this, exceptScope, "1");
        });
    };
    //获取富文本关联的原子内容
    var getKlgAtomContent = function (knwlgId, verNo, klgAttrAtomId, $this) {
        Util.ajax.ajax({
            type: 'get',
            url: Constants.AJAXURL + '/knowledge/getAtomContentById',
            data: {knwlgId: knwlgId, verNo: verNo, klgAttrAtomId: klgAttrAtomId, _v: new Date().getTime()},  //要传递给url的数据
            dataType: 'json', //返回值的数据类型
            async: true,
            success: function (result) {
                if (result.returnCode == "0") {
                    var atomDetail = result.object;
                    var AtomAlert = function () {
                        /*new myAlert({
                            type: 'error',
                            text: "当前原子不存在",
                            falseShow: false,
                            trueName: '确定'
                        });*/
                        dialog.alert({type: 'error', message: '当前原子不存在', falseShow: false, trueName: '确定'});
                    };
                    if (atomDetail == null || atomDetail == "") {
                        AtomAlert();
                    }
                    var atrrItems = atomDetail.atrrItems;
                    if (atrrItems == null || atrrItems == "" || atrrItems.length == 0) {
                        AtomAlert();
                    }
                    Util.hdb.registerHelper("equal", function (v1, v2, options) {
                        if (v1 === v2) {
                            //满足添加继续执行
                            return options.fn(this);
                        } else {
                            //不满足条件执行{{else}}部分
                            return options.inverse(this);
                        }
                    });
                    //注册一个判断相等的Helper,判断v1是否不等于v2
                    Util.hdb.registerHelper("notEqual", function (v1, v2, options) {
                        if (v1 !== v2) {
                            //满足添加继续执行
                            return options.fn(this);
                        } else {
                            //不满足条件执行{{else}}部分
                            return options.inverse(this);
                        }
                    });
                    //注册一个判断是否直接显示value值的Helper,是否直接显示value
                    Util.hdb.registerHelper("normal", function (v1, options) {
                        if (v1 === '1' || v1 === '2' || v1 === '3' || v1 === '4' || v1 === '5' || v1 === '6' || v1 === '7' || v1 === '9' ||
                            v1 === '11' || v1 === '12' || v1 === '14' || v1 === '16') {
                            //满足添加继续执行
                            return options.fn(this);
                        } else {
                            //不满足条件执行{{else}}部分
                            return options.inverse(this);
                        }
                    });
                    //注册一个判断是否有单位
                    Util.hdb.registerHelper("unit", function (v1, options) {
                        if (v1 === '5' || v1 === '9' || v1 === '11' || v1 === '12') {
                            //满足添加继续执行
                            return options.fn(this);
                        } else {
                            //不满足条件执行{{else}}部分
                            return options.inverse(this);
                        }
                    });
                    //注册一个判断数组为空的的Helper,判断item是否为空
                    Util.hdb.registerHelper("blank", function (items, options) {
                        if (items.length !== 0) {
                            //满足添加继续执行
                            return options.fn(this);
                        } else {
                            //不满足条件执行{{else}}部分
                            return options.inverse(this);
                        }
                    });
                    Util.hdb.registerHelper("excp", function (v1, options) {
                        if (v1 === '8' || v1 === '10' || v1 === '13' || v1 === '15' || v1 === '4') {
                            return options.fn(this);
                        } else {
                            return options.inverse(this);
                        }
                    });

                    $('#klgAttrAtom').show();
                    var templateLeft = Util.hdb.compile(knowledgeAttrAtomPreview);
                    var klgLeft = templateLeft(atomDetail);
                    $this.after(klgLeft);
                    //显示缩略图标，并使图标不可点击
                    $("#preAtomBlur").find("img.thumbnailPlus").attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
                    //$("#preAtomBlur .thumbnailPlus").css("pointer-events", "none");
                    var scope = atomDetail.scope;
                    if (scope !== undefined && scope !== "") {
                        refrushAtomExp(scope);
                    }
                    execpClick();
                    atomsRelateEvent();
                } else {
                    //new myAlert({'type': 'confirm', 'text': result.returnMessage, falseShow: false});
                    dialog.alert({type: 'confirm', message: result.returnMessage, falseShow: false});
                    return false;
                }
            },  //url调用成功后执行的回调函数
            error: function (jqXHR, textStatus, errorThrown) {
                //new myAlert({'type': 'error', 'text': errorThrown});
                dialog.alert({type: 'error', message: errorThrown});
            }  //url调用失败后执行的回调函数
        });
    };

    var exceptFaqClick = function () {
        domArray.on("click", ".exceptionAfq", function () {
            if(lazyImg=="1"){
                var currentheight  =$(".detail-left").height();
                var currentScroll =$(".left-content-wrap").scrollTop();
                if(currentheight==currentScroll){
                    $(".left-content-wrap").scrollTop(currentScroll - 0.5);
                }else{
                    $(".left-content-wrap").scrollTop(currentScroll+1);

                }
            }
            var _this = $(this);
            domArray.find(".exceptAfq img.thumbnailPlus").attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
            _this.parent().addClass("active").siblings().removeClass("active");
            var regnIds = _this.attr("regnIdAfqs");
            _this.parent().parent().parent().find("div[regnIdAfqs=" + regnIds + "]").removeClass("hide").siblings().addClass("hide");
        })
    };
    // 动态设置例外中缩略图图标和div的id
    var thumbImgAndDivIdChangeExcept = function ($dom) {

        $dom.find("img.thumbnailPlus").each(function () {
            var imgId = $(this).attr("id");
            $(this).addClass(imgId);
        });
        $dom.find('.thumbnailDiv').each(function () {
            var $this = $(this);
            $this.css("border", "1px solid #acd1e7");
            $this.css("background-color", "#eef4f9");
            var divId = $this.attr("id");
            $this.addClass(divId);
        });
        $dom.find('.yuanzi-title-inner').each(function () {
            $(this).css("border", "1px solid #acd1e7");
            $(this).css("background-color", "#eef4f9");
        });
        $dom.find("img.thumbnailPlus").attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
    };
    //动态设置缩略图图标和缩略图div的id
    var thumbImgAndDivIdChange = function () {

        domArray.find("img.thumbnailPlus").each(function () {
            var imgId = $(this).attr("id");
            $(this).addClass(imgId);
        });
        domArray.find('.thumbnailDiv').each(function () {
            var $this = $(this);
            $this.css("border", "1px solid #acd1e7");
            $this.css("background-color", "#eef4f9");
            var divId = $this.attr("id");
            $this.addClass(divId);
        });
        domArray.find('.yuanzi-title-inner').each(function () {
            $(this).css("border", "1px solid #acd1e7");
            $(this).css("background-color", "#eef4f9");
        });
    };
    // 例外拆分功能的闭合缩略
    var exceptionHideAdd = function (dom) {
        thumbImgAndDivIdChangeExcept(dom);//折叠按钮

        var thumbImgDom = dom.find("img.thumbnailPlus");
        thumbImgDom.attr("src", url_prefix + "/assets/img/thumbnailPlus.png");

        var thumbnailDivDom = dom.find('.thumbnailDiv');
        thumbnailDivDom.hide();
        var thumbnailDivFQA = dom.find("div.thumbnailDivFQA");
        thumbnailDivFQA.find('.has-inner-tag').hide();//FAQ缩略逻辑根一般缩略保持一致
        thumbnailDivFQA.hide();

        var $sidThumbnailLinkFQA = dom.find('a[sid="thumbnailLinkFQA"]');//缩略“+”图标
        $sidThumbnailLinkFQA.removeClass('open');

    }
    //缩略图功能事件 初次加载页面给缩略图默认展示方式(闭合)，搜索后再加载不做改动
    var thumbnailEvent = function (isInit) {
        thumbImgAndDivIdChange();
        var thumbnailDivDom = domArray.find('.thumbnailDiv');
        var $sidThumbnailLinkFQA = domArray.find('a[sid="thumbnailLinkFQA"]');//缩略“+”图标

        if (isInit) {
            thumbnailDivDom.hide();
            var thumbnailDivFQA = domArray.find("div.thumbnailDivFQA");
            thumbnailDivFQA.find('.has-inner-tag').hide();//FAQ缩略逻辑根一般缩略保持一致
            thumbnailDivFQA.hide();
            $sidThumbnailLinkFQA.removeClass('open');
        }

        window.setTimeout(function () {
            //没有缩略原子的缩略知识“+”图标点击
            domArray.on("click", 'a[sid=thumbnailLinkFQA]', function () {
                if(lazyImg=="1"){
                    var currentheight  =$(".detail-left").height();
                    var currentScroll =$(".left-content-wrap").scrollTop();
                    if(currentheight==currentScroll){
                        $(".left-content-wrap").scrollTop(currentScroll - 0.5);
                    }else{
                        $(".left-content-wrap").scrollTop(currentScroll + 1);

                    }
                }
                var _this = $(this);
                var id = _this.attr("id");
                if (!_this.hasClass('open')) {
                    if (_this.parent().find(".tab-inline")) {
                        var _thisP = _this.parent();
                        var _thisEq = _thisP.find(".exceptionAfq").eq(0);
                        _thisP.find(".location").hide();
                        _thisP.find(".tab-inline").show();
                        if (_thisEq.hasClass("active") == false && _thisEq.hasClass("morenAfq")) {
                            _thisEq.parent().addClass("active");
                            var regnIds = _thisEq.attr("regnIdAfqs");
                            _thisP.find("div[regnIdAfqs=" + regnIds + "]").removeClass("hide");
                        }
                    }
                    _this.addClass('open');
                    var $thumbDIv = _this.parent('.yuanzi-title').find('.' + id + "_div");
                    $thumbDIv.show();
                    $thumbDIv.find('.has-inner-tag').show();
                   // $(this).parent().find("img.thumbnailPlus").attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
                    suolueFunc($(this));
                } else {
                    if (_this.parent().find(".tab-inline")) {
                        var _thisP = _this.parent();
                        _thisP.find(".location").show();
                        _thisP.find(".tab-inline").hide();
                    }
                    _this.removeClass('open');
                    var $thumbDIv = _this.parent('.yuanzi-title').find('.' + id + "_div");
                    $thumbDIv.find('.has-inner-tag').hide();
                    $thumbDIv.hide();
                }
            })
            //FQA知识缩略“+”图标点击
            domArray.on("click", "a[sid=thumbnailLinkFQAMORE]", function () {
                var _this = $(this);
                if(lazyImg=="1"){
                    var currentheight  =$(".detail-left").height();
                    var currentScroll =$(".detail-left").scrollTop();
                    if(currentheight==currentScroll){
                        $(".left-content-wrap").scrollTop(currentScroll - 0.5);
                    }else{
                        $(".left-content-wrap").scrollTop(currentScroll + 1);

                    }
                }
                // _this.find(" img.thumbnailPlus").attr("src", "../../assets/img/thumbnailMinus.png");
                if (_this.hasClass("open")) {
                    _this.parent().find(".moreQuestion").hide();
                    _this.removeClass("open");
                } else {
                    _this.parent().find(".moreQuestion").show();
                    _this.addClass("open");
                   // $(this).parent().find("img.thumbnailPlus").attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
                    suolueFunc($(this));
                }
            });
            //FQA知识原子缩略“+”图标点击
            domArray.on("click", "a[sid=thumbnailLinkFQAMORENew]", function () {
                if(lazyImg=="1"){
                    var currentheight  =$(".detail-left").height();
                    var currentScroll =$(".left-content-wrap").scrollTop();
                    if(currentheight==currentScroll){
                        $(".left-content-wrap").scrollTop(currentScroll - 0.5);
                    }else{
                        $(".left-content-wrap").scrollTop(currentScroll );

                    }
                }
                var _this = $(this);
                if (_this.hasClass("open")) {
                    _this.parent().find(".yuanzi-title-include").hide();
                    _this.removeClass("open");
                } else {
                    _this.parent().find(".yuanzi-title-include").show();
                    _this.addClass("open");
                    //$(this).parent().find("img.thumbnailPlus").attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
                    suolueFunc($(this));
                }
            });

            exceptFaqClick();
            //faqVideo();
            //tagFaqThumbnailClick();
            //narrow();
        }, 500);

        var thumbImgDom = domArray.find("img.thumbnailPlus");
        if (isInit) {
            thumbImgDom.attr("src", url_prefix + "/assets/img/thumbnailPlus.png");
        }
        domArray.on("click", "img.thumbnailPlus", function () {
            var _this = $(this);
            var src = _this.attr("src");
            var id = _this.attr("id");
            if(lazyImg=="1"){
                var currentheight  =$(".detail-left").height();
                var currentScroll =$(".left-content-wrap").scrollTop();
                if(currentheight==currentScroll){
                    $(".left-content-wrap").scrollTop(currentScroll - 0.5);
                }else{
                    $(".left-content-wrap").scrollTop(currentScroll );
                }
            }

            if (src && src.indexOf("thumbnailPlus") != -1) {
                _this.attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
                $('.' + id).attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
                $('.' + id + "_div").show();
                thumbnailDivDom.css('padding', '10px');
            } else {
                _this.attr("src", url_prefix + "/assets/img/thumbnailPlus.png");
                $('.' + id).attr("src", url_prefix + "/assets/img/thumbnailPlus.png");
                $('.' + id + "_div").hide();
            }
        })
    };

    //问答和预览缩略中的缩略默认展开
    var suolueFunc=function (_this) {
        _this.parent().find("img.thumbnailPlus").each(function(){
            var thumbnailDivDom = domArray.find('.thumbnailDiv');
            var id = $(this).attr("id");
            $(this).attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
            $('.' + id).attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
            $('#' + id + "_div").show();
            thumbnailDivDom.css('padding', '10px');
        })

    };

    // 刷新富文本 关联的知识状态
    var refreshKlgState = function (leftContObj) {
        var $paratypecd4 = leftContObj.find('div[paratypecd="4"]');
        var $zjCon = leftContObj.find('div[class="zhujie-con"]');
        var relKlgIds = "";// 存储所有的页面富文本关联的知识id
        // 移除所有旧的标识
        $paratypecd4.find("em").each(function () {
            var thisText = $(this).text().replace(/\s+/g,'');
            if ((thisText.indexOf("隐") !=-1 && thisText.length<=2) || (thisText.indexOf("已上线") !=-1 && thisText.length<=4)|| (thisText.indexOf("已下线") !=-1 && thisText.length<=4)|| (thisText.indexOf("未上线") !=-1 && thisText.length<=4)) {
                if ($(this).prev().attr('linktype') == "relateKm" || $(this).prop('style').color.colorHex().toUpperCase() == "#B8B8B8" || $(this).prop('style').color.colorHex().toUpperCase() == "#FF7413" || $(this).prop('style').color.colorHex().toUpperCase() == "#E11C2D")
                    $(this).remove()
            }
        });
        $paratypecd4.nextAll().find("em").each(function () {
            var thisText = $(this).text().replace(/\s+/g,'');
            if ((thisText.indexOf("隐") !=-1 && thisText.length<=2) || (thisText.indexOf("已上线") !=-1 && thisText.length<=4)|| (thisText.indexOf("已下线") !=-1 && thisText.length<=4)|| (thisText.indexOf("未上线") !=-1 && thisText.length<=4)) {
                if ($(this).prev().attr('linktype') == "relateKm" || $(this).prop('style').color.colorHex().toUpperCase() == "#B8B8B8" || $(this).prop('style').color.colorHex().toUpperCase() == "#FF7413" || $(this).prop('style').color.colorHex().toUpperCase() == "#E11C2D")
                    $(this).remove()
            }
        });
        // 优化兼容很老的span 标识
        $paratypecd4.find("span").each(function () {
            var thisText = $(this).text().replace(/\s+/g,'');
            if ((thisText.indexOf("隐") !=-1 && thisText.length<=2) || (thisText.indexOf("已上线") !=-1 && thisText.length<=4)|| (thisText.indexOf("已下线") !=-1 && thisText.length<=4)|| (thisText.indexOf("未上线") !=-1 && thisText.length<=4)) {
                if ($(this).hasClass("status"))
                    $(this).remove()
            }
        });
        // 优化兼容很老的span 标识 例外情况
        $paratypecd4.nextAll().find("span").each(function () {
            var thisText = $(this).text().replace(/\s+/g,'');
            if ((thisText.indexOf("隐") !=-1 && thisText.length<=2) || (thisText.indexOf("已上线") !=-1 && thisText.length<=4)|| (thisText.indexOf("已下线") !=-1 && thisText.length<=4)|| (thisText.indexOf("未上线") !=-1 && thisText.length<=4)) {
                $(this).hasClass("status")
                $(this).remove()
            }
        });

        $zjCon.find("em").each(function () {
            var thisText = $(this).text().replace(/\s+/g,'');
            if ((thisText.indexOf("隐") !=-1 && thisText.length<=2) || (thisText.indexOf("已上线") !=-1 && thisText.length<=4)|| (thisText.indexOf("已下线") !=-1 && thisText.length<=4)|| (thisText.indexOf("未上线") !=-1 && thisText.length<=4)) {
                if ($(this).prev().attr('linktype') == "relateKm" || $(this).prop('style').color.colorHex().toUpperCase() == "#B8B8B8" || $(this).prop('style').color.colorHex().toUpperCase() == "#FF7413" || $(this).prop('style').color.colorHex().toUpperCase() == "#E11C2D")
                    $(this).remove()
            }
        });
        $zjCon.nextAll().find("em").each(function () {
            var thisText = $(this).text().replace(/\s+/g,'');
            if ((thisText.indexOf("隐") !=-1 && thisText.length<=2) || (thisText.indexOf("已上线") !=-1 && thisText.length<=4)|| (thisText.indexOf("已下线") !=-1 && thisText.length<=4)|| (thisText.indexOf("未上线") !=-1 && thisText.length<=4)) {
                if ($(this).prev().attr('linktype') == "relateKm" || $(this).prop('style').color.colorHex().toUpperCase() == "#B8B8B8" || $(this).prop('style').color.colorHex().toUpperCase() == "#FF7413" || $(this).prop('style').color.colorHex().toUpperCase() == "#E11C2D")
                    $(this).remove()
            }
        });
        // 优化兼容很老的span 标识
        $zjCon.find("span").each(function () {
            var thisText = $(this).text().replace(/\s+/g,'');
            if ((thisText.indexOf("隐") !=-1 && thisText.length<=2) || (thisText.indexOf("已上线") !=-1 && thisText.length<=4)|| (thisText.indexOf("已下线") !=-1 && thisText.length<=4)|| (thisText.indexOf("未上线") !=-1 && thisText.length<=4)) {
                if ($(this).hasClass("status"))
                    $(this).remove()
            }
        });
        // 优化兼容很老的span 标识 例外情况
        $zjCon.nextAll().find("span").each(function () {
            var thisText = $(this).text().replace(/\s+/g,'');
            if ((thisText.indexOf("隐") !=-1 && thisText.length<=2) || (thisText.indexOf("已上线") !=-1 && thisText.length<=4)|| (thisText.indexOf("已下线") !=-1 && thisText.length<=4)|| (thisText.indexOf("未上线") !=-1 && thisText.length<=4)) {
                $(this).hasClass("status")
                $(this).remove()
            }
        });

        // 只获取富文本类型下的 关联知识  只能获取到没例外的
        $paratypecd4.find('a[linktype="relateKm"]').each(
            function () {
                var relKlgId = $(this).attr("fileid");
                relKlgIds += relKlgId;
                relKlgIds += ",";
            }
        );
        // 只获取富文本类型下的 关联知识 获取包含例外的
        $paratypecd4.nextAll().find('a[linktype="relateKm"]').each(
            function () {
                var relKlgId = $(this).attr("fileid");
                relKlgIds += relKlgId;
                relKlgIds += ",";
            }
        );
        // 获取注解类型下的 关联知识  只能获取到没例外的
        $zjCon.find('a[linktype="relateKm"]').each(
            function () {
                var relKlgId = $(this).attr("fileid");
                relKlgIds += relKlgId;
                relKlgIds += ",";
            }
        );
        // 获取注解类型下的 关联知识 获取包含例外的
        $zjCon.nextAll().find('a[linktype="relateKm"]').each(
            function () {
                var relKlgId = $(this).attr("fileid");
                relKlgIds += relKlgId;
                relKlgIds += ",";
            }
        );

        if (relKlgIds) {
            Util.ajax.postJson(Constants.AJAXURL + '/searchKnowledgeNew/searchKlgStateByIds', {"relKlgIds": relKlgIds}, function (data, status) {
                if (status) {
                    var object = data.object;
                    var hideFlagMap = object.hideFlagMap;
                    var klgStateMap = object.klgStateMap;
                    // 渲染没例外的情况
                    $.map(klgStateMap, function (value, key) {
                        // 获取页面的所有相关知识 增加新标识
                        $paratypecd4.find('a[fileid="' + key + '"]').each(
                            function () {
                                if ("" != $.trim($(this).text())) {
                                    var nextObj = $(this).next("a");
                                    var nextObjLinkType = nextObj.attr("linktype");
                                    // 0 未上线  1  已下线 2  正常，正常不需要手动干预
                                    if ("0" == value) {
                                        // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                        //     nextObj.append('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FFEBD3; border-color: #FD7D28; color: #FF7413; ">未上线</em>');
                                        // } else {
                                        $(this).prepend('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FFEBD3; border-color: #FD7D28; color: #FF7413; ">未上线</em>');
                                        // }
                                    } else if ("1" == value) {
                                        // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                        //     nextObj.append('<em style="box-sizing: border-box; display: inline-block; font-size: 12px; height: 18px; line-height: 16px; border: 1px solid rgb(215, 215, 215); padding: 0px 3px; border-radius: 3px; margin-left: 3px; background-color: rgb(249, 249, 249); color: rgb(184, 184, 184);">已下线</em>');
                                        // } else {
                                        $(this).prepend('<em style="box-sizing: border-box; display: inline-block; font-size: 12px; height: 18px; line-height: 16px; border: 1px solid rgb(215, 215, 215); padding: 0px 3px; border-radius: 3px; margin-left: 3px; background-color: rgb(249, 249, 249); color: rgb(184, 184, 184);">已下线</em>');
                                        // }
                                    }
                                }
                            }
                        );
                    });
                    $.map(hideFlagMap, function (value, key) {
                        // 获取页面的所有相关知识 增加新标识
                        $paratypecd4.find('a[fileid="' + key + '"]').each(
                            function () {
                                if ("" != $.trim($(this).text())) {
                                    if ("1" == value) {// 1 是隐，0和其他情况是不隐
                                        var nextObj = $(this).next("a");
                                        var nextObjLinkType = nextObj.attr("linktype");
                                        var em = '<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FEE0DE; border-color: #E11C2D; color: #E11C2D;">隐</em>';
                                        // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                        //     //富文本关联了知识原子，将知识状态放到原子名称之后
                                        //     nextObj.append(em);
                                        // } else {
                                        $(this).prepend(em);
                                        // }
                                    }
                                }
                            }
                        );

                    });
                    // 渲染有例外的情况
                    $.map(klgStateMap, function (value, key) {
                        // 获取页面的所有相关知识 增加新标识
                        $paratypecd4.nextAll().find('a[fileid="' + key + '"]').each(
                            function () {
                                if ("" != $.trim($(this).text())) {
                                    var nextObj = $(this).next("a");
                                    var nextObjLinkType = nextObj.attr("linktype");
                                    // 0 未上线  1  已下线 2  正常，正常不需要手动干预
                                    if ("0" == value) {
                                        // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                        //     nextObj.append('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FFEBD3; border-color: #FD7D28; color: #FF7413; ">未上线</em>');
                                        // } else {
                                        $(this).prepend('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FFEBD3; border-color: #FD7D28; color: #FF7413; ">未上线</em>');
                                        // }
                                    } else if ("1" == value) {
                                        // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                        //     nextObj.append('<em style="box-sizing: border-box; display: inline-block; font-size: 12px; height: 18px; line-height: 16px; border: 1px solid rgb(215, 215, 215); padding: 0px 3px; border-radius: 3px; margin-left: 3px; background-color: rgb(249, 249, 249); color: rgb(184, 184, 184);">已下线</em>');
                                        // } else {
                                        $(this).prepend('<em style="box-sizing: border-box; display: inline-block; font-size: 12px; height: 18px; line-height: 16px; border: 1px solid rgb(215, 215, 215); padding: 0px 3px; border-radius: 3px; margin-left: 3px; background-color: rgb(249, 249, 249); color: rgb(184, 184, 184);">已下线</em>');
                                        // }
                                    }
                                }
                            }
                        );
                    });
                    $.map(hideFlagMap, function (value, key) {
                        // 获取页面的所有相关知识 增加新标识
                        $paratypecd4.nextAll().find('a[fileid="' + key + '"]').each(
                            function () {
                                if ("" != $.trim($(this).text())) {
                                    if ("1" == value) {// 1 是隐，0和其他情况是不 隐
                                        var nextObj = $(this).next("a");
                                        var nextObjLinkType = nextObj.attr("linktype");
                                        // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                        //     nextObj.append('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FEE0DE; border-color: #E11C2D; color: #E11C2D;">隐</em>');
                                        // } else {
                                        $(this).prepend('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FEE0DE; border-color: #E11C2D; color: #E11C2D;">隐</em>');
                                        // }
                                    }
                                }
                            }
                        );
                    });


                    $.map(klgStateMap, function (value, key) {
                        // 获取页面的所有相关知识 增加新标识
                        $zjCon.each(function () {
                            if ($($(this).parent().parent()[0].children[0]).attr("paratypecd") != '4') {
                                $(this).find('a[fileid="' + key + '"]').each(
                                    function () {
                                        if ("" != $.trim($(this).text())) {
                                            var nextObj = $(this).next("a");
                                            var nextObjLinkType = nextObj.attr("linktype");
                                            // 0 未上线  1  已下线 2  正常，正常不需要手动干预
                                            if ("0" == value) {
                                                // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                                //     nextObj.append('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FFEBD3; border-color: #FD7D28; color: #FF7413; ">未上线</em>');
                                                // } else {
                                                $(this).prepend('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FFEBD3; border-color: #FD7D28; color: #FF7413; ">未上线</em>');
                                                // }
                                            } else if ("1" == value) {
                                                // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                                //     nextObj.append('<em style="box-sizing: border-box; display: inline-block; font-size: 12px; height: 18px; line-height: 16px; border: 1px solid rgb(215, 215, 215); padding: 0px 3px; border-radius: 3px; margin-left: 3px; background-color: rgb(249, 249, 249); color: rgb(184, 184, 184);">已下线</em>');
                                                // } else {
                                                $(this).prepend('<em style="box-sizing: border-box; display: inline-block; font-size: 12px; height: 18px; line-height: 16px; border: 1px solid rgb(215, 215, 215); padding: 0px 3px; border-radius: 3px; margin-left: 3px; background-color: rgb(249, 249, 249); color: rgb(184, 184, 184);">已下线</em>');
                                                // }
                                            }
                                        }
                                    }
                                );
                            }
                        });
                    });
                    $.map(hideFlagMap, function (value, key) {
                        // 获取页面的所有相关知识 增加新标识
                        $zjCon.each(function () {
                            if ($($(this).parent().parent()[0].children[0]).attr("paratypecd") != '4') {
                                $(this).find('a[fileid="' + key + '"]').each(
                                    function () {
                                        if ("" != $.trim($(this).text())) {
                                            if ("1" == value) {// 1 是隐，0和其他情况是不 隐
                                                var nextObj = $(this).next("a");
                                                var nextObjLinkType = nextObj.attr("linktype");
                                                // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                                //     nextObj.append('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FEE0DE; border-color: #E11C2D; color: #E11C2D;">隐</em>');
                                                //
                                                // } else {
                                                $(this).prepend('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FEE0DE; border-color: #E11C2D; color: #E11C2D;">隐</em>');
                                                // }
                                            }
                                        }
                                    }
                                );
                            }
                        });
                    });
                    // 渲染有例外的情况

                    $.map(klgStateMap, function (value, key) {
                        // 获取页面的所有相关知识 增加新标识
                        $zjCon.each(function () {
                            if ($($(this).parent().parent()[0].children[0]).attr("paratypecd") != '4') {
                                $(this).nextAll().find('a[fileid="' + key + '"]').each(
                                    function () {
                                        if ("" != $.trim($(this).text())) {
                                            var nextObjLinkType = nextObj.attr("linktype");
                                            var nextObj = $(this).next("a");
                                            // 0 未上线  1  已下线 2  正常，正常不需要手动干预
                                            if ("0" == value) {
                                                // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                                //     nextObj.append('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FFEBD3; border-color: #FD7D28; color: #FF7413; ">未上线</em>');
                                                // } else {
                                                $(this).prepend('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FFEBD3; border-color: #FD7D28; color: #FF7413; ">未上线</em>');
                                                // }
                                            } else if ("1" == value) {
                                                // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                                //     nextObj.append('<em style="box-sizing: border-box; display: inline-block; font-size: 12px; height: 18px; line-height: 16px; border: 1px solid rgb(215, 215, 215); padding: 0px 3px; border-radius: 3px; margin-left: 3px; background-color: rgb(249, 249, 249); color: rgb(184, 184, 184);">已下线</em>');
                                                // } else {
                                                $(this).prepend('<em style="box-sizing: border-box; display: inline-block; font-size: 12px; height: 18px; line-height: 16px; border: 1px solid rgb(215, 215, 215); padding: 0px 3px; border-radius: 3px; margin-left: 3px; background-color: rgb(249, 249, 249); color: rgb(184, 184, 184);">已下线</em>');
                                                // }
                                            }
                                        }
                                    }
                                );
                            }
                        });
                    });
                    $.map(hideFlagMap, function (value, key) {
                        // 获取页面的所有相关知识 增加新标识
                        $zjCon.each(function () {
                            if ($($(this).parent().parent()[0].children[0]).attr("paratypecd") != '4') {
                                $(this).nextAll().find('a[fileid="' + key + '"]').each(
                                    function () {
                                        if ("" != $.trim($(this).text())) {
                                            if ("1" == value) {// 1 是隐，0和其他情况是不 隐
                                                var nextObj = $(this).next("a");
                                                var nextObjLinkType = nextObj.attr("linktype");
                                                // if (nextObjLinkType && nextObjLinkType == "relateKmAtom") {
                                                //     nextObj.append('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FEE0DE; border-color: #E11C2D; color: #E11C2D;">隐</em>');
                                                // } else {
                                                $(this).append('<em style=" box-sizing: border-box; display: inline-block; font-size: 12px; font-style: normal; height: 18px; line-height: 16px; border: 1px solid transparent; padding: 0 3px; border-radius: 3px; margin-left: 3px; background-color: #FEE0DE; border-color: #E11C2D; color: #E11C2D;">隐</em>');
                                                // }
                                            }
                                        }
                                    }
                                );
                            }
                        });
                    });
                } else {

                }
            });
        }

    }
    //处理多选类型原子逗号
    //全局遍历事件处理(预览按钮增加，图片展示)
    var addPreview = function ($this) {
        $this.find("object[linkType = 'video'],video[linkType = 'video']").each(function () {
            var $this = $(this);
            var width = $this.attr("width");
            var height = $this.attr("height");
            var fileId = $this.attr("fileId");
            var autostart = false;
            var _key = "NGKM_MEDIA_FILE";
            var link = window.location.protocol + "//" + window.location.host + Constants.AJAXURL + "/file/downloadMedia/" + _key + "/" + fileId;
            /*     var userAgent = navigator.userAgent;
                 var isIE = (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1);
                 var fIEVersion;*/

            var vidoeHtml = '<div class="video-player-box">\
            <div class="play-button-box pre-video" fileId="'+ fileId + '" link="' + link + '"></div>\
        </div>';
            $this.replaceWith(vidoeHtml);
            // if(IEVersion()!="-1") {
            //     var object = '<object id="flv__id__' + fileId + '" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="' + width + '" height="' + height + '">\n' +
            //         '<param name="wmode" value="transparent">' +
            //         '<param name="movie" value="' + url_prefix + '/assets/plugin/flvplayer.swf">\n' +
            //         '<param name="flashvars" value="file=' + link + '.mp4&autostart=' + autostart + '&image=&provider=video">\n' +
            //         '<param name="quality" value="high">\n' +
            //         '<param name="allowfullscreen" value="true">' +
            //         '<embed wmode="transparent" type="application/x-shockwave-flash" src="' + url_prefix + '/assets/plugin/flvplayer.swf" width="' + width + '" height="' + height + '" flashvars="file=' + link + '.mp4&autostart=' + autostart + '&provider=video" quality="high" allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer"></embed>' +
            //         '</object><br>';
            //     $this.replaceWith(object);
            // }else{
            //     var $e2 = $('<div class="video'+fileId+'"  style="height: 480px; width: 400px;"></div>')
            //     $this.replaceWith($e2);
            //     var config = {
            //         el: '.video'+fileId,
            //         className: 'video',
            //         solution:'html,flash',
            //         swfPath:url_prefix+'/assets/lib/jqueryPlugin/jPlayer/dist/jplayer',
            //         autoPaly: 1, //是否自动播放，0手动播放|默认1自动播放
            //         volume: 1, //音量设置，取值范围0-1，默认0.8
            //         repeat: false, //是否循环播放 true|false,默认为false
            //         shortcutKey: true,
            //         minPlaybackRate: 1,//最小倍速，整数，默认为1，最小为1
            //         playbackRate: 1,//默认倍速，整数，默认为1
            //         rateStep: 2,//倍速每次改变的值，整数，默认为2
            //         fullscreen: false,
            //         remainingDuration: true, //为true时，播放器中默认显示剩余时长;为false时，默认显示总时长;
            //         toggleDuration: true, //为true时，点击播放器中的时间，可以在 剩余时长/总时长 之间切换
            //         url: link+'.mp4&autostart=false&image=&provider=video' //视频地址
            //     }
            //     var video = new Video(config); //生成自定义的音频组件。
            // }
        });


        $this.find("object[linkTypes = 'videoDm'],video[linkTypes = 'videoDm']").each(function () {
            var $this = $(this);
            var width = $this.attr("width");
            var height = $this.attr("height");
            var fileId = $this.attr("fileId");
            var autostart = false;
            var _key = "MDKM_FILE_PATH";
            var link = window.location.protocol + "//" + window.location.host + Constants.AJAXURL + "/file/downloadWskmMedia/" + _key + "/" + fileId;
            /*     var userAgent = navigator.userAgent;
                 var isIE = (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1);
                 var fIEVersion;*/

            var vidoeHtml = '<div class="video-player-box">\
            <div class="play-button-box pre-video" fileId="'+fileId+'" link="'+link+'"></div>\
        </div>';
            $this.replaceWith(vidoeHtml);

            // if(IEVersion()!="-1") {
            //     var object = '<object id="flv__id__' + fileId.split(".")[0] + '" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="' + width + '" height="' + height + '">\n' +
            //         '<param name="wmode" value="transparent">' +
            //         '<param name="movie" value="' + url_prefix + '/assets/plugin/flvplayer.swf">\n' +
            //         '<param name="flashvars" value="file=' + link + '.mp4&autostart=' + autostart + '&image=&provider=video">\n' +
            //         '<param name="quality" value="high">\n' +
            //         '<param name="allowfullscreen" value="true">' +
            //         '<embed wmode="transparent" type="application/x-shockwave-flash" src="' + url_prefix + '/assets/plugin/flvplayer.swf" width="' + width + '" height="' + height + '" flashvars="file=' + link + '.mp4&autostart=' + autostart + '&provider=video" quality="high" allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer"></embed>' +
            //         '</object><br>';
            //     $this.replaceWith(object);
            // }else{
            //     var $e2 = $('<div class="video'+fileId.split(".")[0]+'"  style="height: 480px; width: 400px;"></div>')
            //     $this.replaceWith($e2);
            //     var config = {
            //         el: '.video'+fileId.split(".")[0],
            //         className: 'video',
            //         solution:'html,flash',
            //         swfPath:url_prefix+'/assets/lib/jqueryPlugin/jPlayer/dist/jplayer',
            //         autoPaly: 1, //是否自动播放，0手动播放|默认1自动播放
            //         volume: 1, //音量设置，取值范围0-1，默认0.8
            //         repeat: false, //是否循环播放 true|false,默认为false
            //         shortcutKey: true,
            //         minPlaybackRate: 1,//最小倍速，整数，默认为1，最小为1
            //         playbackRate: 1,//默认倍速，整数，默认为1
            //         rateStep: 2,//倍速每次改变的值，整数，默认为2
            //         fullscreen: false,
            //         remainingDuration: true, //为true时，播放器中默认显示剩余时长;为false时，默认显示总时长;
            //         toggleDuration: true, //为true时，点击播放器中的时间，可以在 剩余时长/总时长 之间切换
            //         url: link+'.mp4&autostart=false&image=&provider=video' //视频地址
            //     }
            //     var video = new Video(config); //生成自定义的音频组件。
            // }
        });
        //图片类型下载
        $this.find("img[linkType = 'img']").each(function () {
            var _this = $(this);
            _this.addClass('sn-image-target');
            if(lazyImg=="1"){
                _this.addClass("lazy1");
                //_this.attr("src","data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNzEwMzIzNjE1ODQ3IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDExMTcgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEzMzM0IiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgd2lkdGg9IjIxOC4xNjQwNjI1IiBoZWlnaHQ9IjIwMCI+PHBhdGggZD0iTTk3Ny40NTQ1NDUgMGExMzkuNjM2MzY0IDEzOS42MzYzNjQgMCAwIDEgMTM5LjYzNjM2NCAxMzkuNjM2MzY0djc0NC43MjcyNzJhMTM5LjYzNjM2NCAxMzkuNjM2MzY0IDAgMCAxLTEzOS42MzYzNjQgMTM5LjYzNjM2NEgxMzkuNjM2MzY0YTEzOS42MzYzNjQgMTM5LjYzNjM2NCAwIDAgMS0xMzkuNjM2MzY0LTEzOS42MzYzNjRWMTM5LjYzNjM2NGExMzkuNjM2MzY0IDEzOS42MzYzNjQgMCAwIDEgMTM5LjYzNjM2NC0xMzkuNjM2MzY0ek0zMjEuMTYzNjM2IDQ5NS44NDg3MjdMOTMuMDkwOTA5IDc2MS45MDI1NDVWODg0LjM2MzYzNmE0Ni41NDU0NTUgNDYuNTQ1NDU1IDAgMCAwIDQxLjA5OTYzNiA0Ni4yMTk2MzdMMTM5LjYzNjM2NCA5MzAuOTA5MDkxaDgzNy44MTgxODFhNDYuMzEyNzI3IDQ2LjMxMjcyNyAwIDAgMCAyMy4zMTkyNzMtNi4yMzcwOTEgNDIuOTE0OTA5IDQyLjkxNDkwOSAwIDAgMS04LjA1MjM2My01LjgxODE4MmwtNC4wNDk0NTUtNC4xODkwOTEtMTk2LjE4OTA5MS0yMzYuNjM3MDkxLTE1MS4wNCAxODguODgxNDU1YTQ2LjU0NTQ1NSA0Ni41NDU0NTUgMCAwIDEtNzEuNTg2OTA5IDEuMzk2MzY0bC0zLjQ5MDkwOS00LjY1NDU0NkwzMjEuMTYzNjM2IDQ5NS44NDg3Mjd6TTk3Ny40NTQ1NDUgOTMuMDkwOTA5SDEzOS42MzYzNjRhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMC00Ni41NDU0NTUgNDYuNTQ1NDU1djQ3OS4yMzJsMTk3LjM1MjcyNy0yMzAuMjYwMzY0YTQ2LjU0NTQ1NSA0Ni41NDU0NTUgMCAwIDEgNzAuNjU2LTAuMDQ2NTQ1bDMuNDQ0MzY0IDQuNTE0OTA5IDI0My45NDQ3MjcgMzY1Ljk0MDM2MyAxNDYuNDMyLTE4My4wMTY3MjdhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMSA2Ny42NzcwOTEtNS4zMDYxODJsNC4wMDI5MDkgNC4wOTZMMTAyNCA4MTEuNjU5NjM2VjEzOS42MzYzNjRhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMC00MS4wOTk2MzYtNDYuMjE5NjM3TDk3Ny40NTQ1NDUgOTMuMDkwOTA5eiBtLTE4Ni4xODE4MTggMTM5LjYzNjM2NGE5My4wOTA5MDkgOTMuMDkwOTA5IDAgMSAxIDAgMTg2LjE4MTgxOCA5My4wOTA5MDkgOTMuMDkwOTA5IDAgMCAxIDAtMTg2LjE4MTgxOHoiIGZpbGw9IiMwMDhkZjAiIHAtaWQ9IjEzMzM1Ij48L3BhdGg+PC9zdmc+");
                _this.attr("data-src", Constants.AJAXURL + "/file/download?key=NGKM_PICTURE_FILE&fileId=" + _this.attr("fileId"));

            }else{
                 _this.attr("src", Constants.AJAXURL + "/file/download?key=NGKM_PICTURE_FILE&fileId=" + _this.attr("fileId"));
            }
            if (_this.hasClass("narrow")) {//cursor:pointer
                _this.css("cursor", "pointer");
            }
            var imgBorder = _this.attr("border");
            var borderColor = _this.css("border-color");
            if (imgBorder && imgBorder != "0" && borderColor) {
                _this.css("border", imgBorder + "px solid " + borderColor);
            }
        });
        //多媒体图片类型下载
        $this.find("img[linkTypes = 'imgDm']").each(function () {
            var _this = $(this);
            _this.addClass('sn-image-target');
            if(lazyImg=="1"){
                _this.addClass("lazy1");
                //_this.attr("src","data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNzEwMzIzNjE1ODQ3IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDExMTcgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjEzMzM0IiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgd2lkdGg9IjIxOC4xNjQwNjI1IiBoZWlnaHQ9IjIwMCI+PHBhdGggZD0iTTk3Ny40NTQ1NDUgMGExMzkuNjM2MzY0IDEzOS42MzYzNjQgMCAwIDEgMTM5LjYzNjM2NCAxMzkuNjM2MzY0djc0NC43MjcyNzJhMTM5LjYzNjM2NCAxMzkuNjM2MzY0IDAgMCAxLTEzOS42MzYzNjQgMTM5LjYzNjM2NEgxMzkuNjM2MzY0YTEzOS42MzYzNjQgMTM5LjYzNjM2NCAwIDAgMS0xMzkuNjM2MzY0LTEzOS42MzYzNjRWMTM5LjYzNjM2NGExMzkuNjM2MzY0IDEzOS42MzYzNjQgMCAwIDEgMTM5LjYzNjM2NC0xMzkuNjM2MzY0ek0zMjEuMTYzNjM2IDQ5NS44NDg3MjdMOTMuMDkwOTA5IDc2MS45MDI1NDVWODg0LjM2MzYzNmE0Ni41NDU0NTUgNDYuNTQ1NDU1IDAgMCAwIDQxLjA5OTYzNiA0Ni4yMTk2MzdMMTM5LjYzNjM2NCA5MzAuOTA5MDkxaDgzNy44MTgxODFhNDYuMzEyNzI3IDQ2LjMxMjcyNyAwIDAgMCAyMy4zMTkyNzMtNi4yMzcwOTEgNDIuOTE0OTA5IDQyLjkxNDkwOSAwIDAgMS04LjA1MjM2My01LjgxODE4MmwtNC4wNDk0NTUtNC4xODkwOTEtMTk2LjE4OTA5MS0yMzYuNjM3MDkxLTE1MS4wNCAxODguODgxNDU1YTQ2LjU0NTQ1NSA0Ni41NDU0NTUgMCAwIDEtNzEuNTg2OTA5IDEuMzk2MzY0bC0zLjQ5MDkwOS00LjY1NDU0NkwzMjEuMTYzNjM2IDQ5NS44NDg3Mjd6TTk3Ny40NTQ1NDUgOTMuMDkwOTA5SDEzOS42MzYzNjRhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMC00Ni41NDU0NTUgNDYuNTQ1NDU1djQ3OS4yMzJsMTk3LjM1MjcyNy0yMzAuMjYwMzY0YTQ2LjU0NTQ1NSA0Ni41NDU0NTUgMCAwIDEgNzAuNjU2LTAuMDQ2NTQ1bDMuNDQ0MzY0IDQuNTE0OTA5IDI0My45NDQ3MjcgMzY1Ljk0MDM2MyAxNDYuNDMyLTE4My4wMTY3MjdhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMSA2Ny42NzcwOTEtNS4zMDYxODJsNC4wMDI5MDkgNC4wOTZMMTAyNCA4MTEuNjU5NjM2VjEzOS42MzYzNjRhNDYuNTQ1NDU1IDQ2LjU0NTQ1NSAwIDAgMC00MS4wOTk2MzYtNDYuMjE5NjM3TDk3Ny40NTQ1NDUgOTMuMDkwOTA5eiBtLTE4Ni4xODE4MTggMTM5LjYzNjM2NGE5My4wOTA5MDkgOTMuMDkwOTA5IDAgMSAxIDAgMTg2LjE4MTgxOCA5My4wOTA5MDkgOTMuMDkwOTA5IDAgMCAxIDAtMTg2LjE4MTgxOHoiIGZpbGw9IiMwMDhkZjAiIHAtaWQ9IjEzMzM1Ij48L3BhdGg+PC9zdmc+");
                _this.attr("data-src", Constants.AJAXURL + "/file/downloadWskm?key=MDKM_FILE_PATH&fileId=" + _this.attr("fileId"));
            }else{
                _this.attr("src", Constants.AJAXURL + "/file/downloadWskm?key=MDKM_FILE_PATH&fileId=" + _this.attr("fileId"));

            }
            if (_this.hasClass("narrow")) {//cursor:pointer
                _this.css("cursor", "pointer");
            }
            var imgBorder = _this.attr("border");
            var borderColor = _this.css("border-color");
            if (imgBorder && imgBorder != "0" && borderColor) {
                _this.css("border", imgBorder + "px solid " + borderColor);
            }
        });
        $this.find('.yuanzi-con').each(function () {
            var _this = $(this);
            if (_this.find("img[linkTypes = 'imgDm']").length > 0) {
                _this.addClass('preview-img-wrap');
                var imgList = [];
                _this.find("img[linkTypes = 'imgDm']").each(function () {
                    var $this = $(this);
                    var src = $this.attr('src');
                    imgList.push({
                        url: src,
                        name: $this.attr("fileid")
                    })
                })
                new Image({
                    el: _this,
                    showName: false, //是否显示图片名称,默认为true
                    showNum: true, //是否显示图片顺序,默认为true
                    showDownload: false, //是否可下载,默认为false
                    canPreview : true,
                    // downloadFn: function(){ //自定义下载功能，默认不配置，配置后会替换组件的下载逻辑
                    //     console.log('load.....',arguments)
                    // },
                    imgList: imgList
                })
                // $('.viewer-container').css("top", "40px");
            }
        })
        $this.find('.yuanzi-con').each(function () {
            var _this = $(this);
            if (_this.find("img[linkType = 'img']").length > 0) {
                _this.addClass('preview-img-wrap');
                var imgList = [];
                _this.find("img[linkType = 'img']").each(function () {
                    var $this = $(this);
                    var src = $this.attr('src');
                    imgList.push({
                        url: src,
                        name: $this.attr("fileid")
                    })
                })
                new Image({
                    el: _this,
                    showName: false, //是否显示图片名称,默认为true
                    showNum: true, //是否显示图片顺序,默认为true
                    showDownload: false, //是否可下载,默认为false
                    canPreview : true,
                    // downloadFn: function(){ //自定义下载功能，默认不配置，配置后会替换组件的下载逻辑
                    //     console.log('load.....',arguments)
                    // },
                    imgList: imgList
                })
                // $('.viewer-container').css("top", "40px");
            }
        })
        $this.find('.zhujie-con').each(function () {
            var _this = $(this);
            if (_this.find("img[linkType = 'img']").length > 0) {
                _this.addClass('preview-img-wrap');
                var imgList = [];
                _this.find("img[linkType = 'img']").each(function () {
                    var $this = $(this);
                    var src = $this.attr('src');
                    imgList.push({
                        url: src,
                        name: $this.attr("fileid")
                    })
                })
                new Image({
                    el: _this,
                    showName: false, //是否显示图片名称,默认为true
                    showNum: true, //是否显示图片顺序,默认为true
                    showDownload: false, //是否可下载,默认为false
                    canPreview : true,
                    // downloadFn: function(){ //自定义下载功能，默认不配置，配置后会替换组件的下载逻辑
                    //     console.log('load.....',arguments)
                    // },
                    imgList: imgList
                })
                // $('.viewer-container').css("top", "40px");
            }
        })
        $this.find('.zhujie-con').each(function () {
            var _this = $(this);
            if (_this.find("img[linkTypes = 'imgDm']").length > 0) {
                _this.addClass('preview-img-wrap');
                var imgList = [];
                _this.find("img[linkTypes = 'imgDm']").each(function () {
                    var $this = $(this);
                    var src = $this.attr('src');
                    imgList.push({
                        url: src,
                        name: $this.attr("fileid")
                    })
                })
                new Image({
                    el: _this,
                    showName: false, //是否显示图片名称,默认为true
                    showNum: true, //是否显示图片顺序,默认为true
                    showDownload: false, //是否可下载,默认为false
                    canPreview : true,
                    // downloadFn: function(){ //自定义下载功能，默认不配置，配置后会替换组件的下载逻辑
                    //     console.log('load.....',arguments)
                    // },
                    imgList: imgList
                })
                // $('.viewer-container').css("top", "40px");
            }
        })
        $this.find("img[linkType = 'emo']").each(function () {
            //处理表情包
            var src = $(this).attr("src");
            if (src) {
                $(this).attr("src", src.replace("/ngkmeditor/src/assets/img/emot", "/ngkm/src/assets/img/emot"));
            }
        });

        //附件增加预览按钮
        $this.find("a[linktype='download']").each(function () {
            var _this = $(this);
            var sufix = _this.attr("sufix");
            var fileId = _this.attr("fileId");
            var fileName;
            if(_this.attr("filename")!=undefined)
            {
                fileName= encodeURIComponent( _this.attr("filename"));
            }else if(_this.attr("title")!=undefined){
                fileName = encodeURIComponent( _this.attr("title"));
            }else{
                var reg=/<\/?.+?\/?>/g;
                fileName= encodeURIComponent(_this.html()).replace(reg, '')  ;
            }
            //截取文件后缀
            var subSufix = fileName.substring(fileName.lastIndexOf('.') + 1);
            if (sufix && sufix != "null" || subSufix=="pdf"||subSufix=="mht") {
                if (_this.parent().hasClass("fujian-inline") == false) {
                    _this.wrap("<div class=\"yuanzi-con fujian-con fujian-inline\"></div>");
                }
                if (fileName) {
                    if (subSufix=="mht"){
                        if ((!!window.ActiveXObject || "ActiveXObject" in window)){
                            //ie浏览器增加预览按钮
                            if (_this.next().hasClass("fj-preview") == false) {
                                _this.after("<span class=\"fj-preview\" title=\"预览\"><a href='#' id=\"viewFile.html?fileId=" + fileId + "&key=NGKM_FILE_ATTACH&fileSufix=" + subSufix + "&fileName=" + encodeURIComponent(fileName) + "\"></a></span>");
                            }
                        }else {
                            if (_this.next().hasClass("fj-preview") == false) {
                                _this.after("<span class=\"fj-preview download-preview\" title=\"无法预览,请下载\"></span>");
                            }
                        }
                    } else {
                        if (_this.next().hasClass("fj-preview") == false) {
                            _this.after("<span class=\"fj-preview\" title=\"预览\"><a href='#' id=\"viewFile.html?fileId=" + fileId + "&key=NGKM_FILE_ATTACH&fileSufix=" + subSufix + "&fileName=" + encodeURIComponent(fileName) + "\"></a></span>");
                        }
                    }
                }
            }
        });
        //富文本关联原子增加预览按钮
        $this.find("a[linkType = 'relateKmAtom']").each(function () {
            var _this = $(this);
            if (_this.next().hasClass("preview") == false) {
                _this.after("<span class=\"preview\" title=\"预览\">预览<a href='#' class = \"Atom\"></a></span>");

            }
        });

        // 增加卡片预览
        $this.find('div[paratypecd="22"]').each(function() {
            var _this = $(this);
            if(_this.children('div').hasClass("yuanzi-con")) {
                _this.children('div').append("<span class=\" kapan-preview\" title=\"预览\">预览<a href='#' class = \"Atom\"></a></span>")
                console.log('456预览')
            }
            $(".kapan-preview").css({
                backgroundColor: "#5BA52B",
                borderRadius: "10px",
                color:'#fff',
                cursor: "pointer",
                padding: '0px 5px'
            })
            console.log('123预览')
        })

        //音频类型
        var borswer = navigator.userAgent;
        //IE内核浏览器
        if (borswer.indexOf("Trident") >= 0) {
            $this.find("audio").each(function () {
                var $this = $(this);
                var fileId = $this.attr("fileId");
                var link = window.location.protocol + "//" + window.location.host + Constants.AJAXURL + "/file/download/?key=NGKM_FILE_ATTACH&fileId=" + fileId;
                var object = '<object classid="clsid:6bf52a52-394a-11d3-b153-00c04f79faa6" style="width:480px;height:50px;">\n' +
                    '<param name="windowlessvideo" value="1">' +
                    '<param name="url" value="' + link + '">\n' +
                    '<param name="autostart" value="false">\n' +
                    '<embed windowlessvideo="1" src="' + link + '" pluginspage="http://microsoft.com/windows/mediaplayer/en/download/"></embed>' +
                    '</object><br>';
                $this.next("object").remove();
                $this.replaceWith(object);
            });
        } else {
            //非IE内核浏览器
            $this.find("audio").each(function () {
                var $this = $(this);
                var fileId = $this.attr("fileId");
                var link = window.location.protocol + "//" + window.location.host + Constants.AJAXURL + "/file/download/?key=NGKM_FILE_ATTACH&fileId=" + fileId;
                var object = '<audio controls="controls" controlsList="nodownload"  oncontextmenu="return false" style="width:480px;height:50px;"  src="' + link + '"><object classid="clsid:6bf52a52-394a-11d3-b153-00c04f79faa6" style="width:480px;height:50px;">\n' +
                    '<param name="windowlessvideo" value="1">' +
                    '<param name="url" value="' + link + '">\n' +
                    '<param name="autostart" value="false">\n' +
                    '</object></audio><br>';
                $this.replaceWith(object);
            });
        }
        var bossLongHide = function (leftContObj) {
            var orange = leftContObj.find(".left-content-inner .orange-line");
            for (var i = 0; i < orange.length; i++) {
                if ("BOSS代码：" == $(orange[i])[0].outerText || "BOSS产品名称：" == $(orange[i])[0].outerText) {
                    var _this = $(orange[i]);
                    var orangePar = _this.parent().find('div');
                    if (orangePar.length > 0) {
                        var orangerLe = orangePar[0].innerText.replaceAll('<span class="sr-high">', '').replaceAll('</span>', '').replace(/^\s*|\s*$/g, "").length;
                        if (orangerLe > 170) {
                            $(orangePar[0]).addClass("yuanzi-title-include");

                            if ($(orangePar[0]).find('.sr-high').length > 0) {
                                _this.after('<a class="zfbz-a" href="javascript:void(0)"><i class="icon km-shanglajiantou"></i></a>');
                                $(orangePar[0]).after('<div class="box-collapsible"><span class="spanHides">隐藏<i class="icon km-shanglajiantou"></i></span></div>');
                                $(orangePar[0]).removeClass("hide");

                            } else {
                                _this.after('<a class="zfbz-a" href="javascript:void(0)"><i class="icon km-xialajiantou"></i></a>');
                                $(orangePar[0]).after('<div class="box-collapsible hide"><span class="spanHides">隐藏<i class="icon km-shanglajiantou"></i></span></div>');
                                $(orangePar[0]).addClass("hide");
                            }

                        }
                    } else {
                        var moreUt = _this.parent().find('ul').find('li');
                        //.find('div.yuanzi-con')
                        var moren = _this.parent().parent().children('div.left-explain');
                        for (var j = 0; j < moren.length; j++) {
                            var yuanzi = $(moren[j]).find('div.yuanzi-con');
                            if (yuanzi.length > 0) {
                                var morenL = yuanzi[0].innerText.replaceAll('<span class="sr-high">', '').replaceAll('</span>', '').replace(/^\s*|\s*$/g, "").length;
                                if (morenL > 170) {
                                    yuanzi.addClass("yuanzi-title-include");
                                    if (yuanzi.find('.sr-high').length > 0) {
                                        if ($(moreUt[j]).hasClass('active')) {
                                            yuanzi.parent().removeClass('hide');
                                        } else {
                                            yuanzi.parent().addClass('hide');

                                        }
                                        $(moreUt[j]).after('<li style="margin-left: -6px;"><a class="zfbz-d"  href="javascript:void(0)"><i class="icon km-shanglajiantou gqf_' + j + '"></i></a></li>');
                                        $(yuanzi).after('<div class="box-collapsible"><span class="spanHide" gqf="' + j + '">隐藏<i class="icon km-shanglajiantou"></i></span></div>');

                                    } else {
                                        $(moreUt[j]).after('<li style="margin-left: -6px;"><a class="zfbz-d" href="javascript:void(0)"><i class="icon km-xialajiantou gqf_' + j + '" ></i></a></li>');
                                        $(yuanzi).after('<div class="box-collapsible"><span class="spanHide" gqf="' + j + '">隐藏<i class="icon km-shanglajiantou"></i></span></div>');
                                        $(yuanzi).parent().addClass('hide');
                                        if ($(yuanzi).parent().next().find('div.zhujie-con').length > 0) {
                                            $(yuanzi).parent().next().addClass('hide');
                                        }
                                    }

                                }
                            }
                        }

                    }
                } else {
                    continue;
                }
            }
        }
        bossLongHide($this);
        var atomValue = $this.find(".left-words[paraTypeCd = 3]").parent().find(".yuanzi-con");
        for (var i = 0; i < atomValue.length; i++) {
            $(atomValue[i]).html($(atomValue[i]).html().replaceAll(',', '，'));
        }
        refreshKlgState($this);
      /*  $('.lazy').each(function() {
            // 获取图片元素
            var $img = $(this);
            // 获取图片元素距离顶部的距离
            var imgTop = $img.offset().top;

            // 如果图片元素进入视口范围，则加载图片
            /!*if (imgTop < viewportHeight + scrollTop) {*!/
            if(!$img.attr("src")){
                $img.attr('src', $img.data('src')); // 设置图片的src属性为data-src的值
                $img.addClass('loaded'); // 添加.loaded类，显示图片
                /!*  }*!/
            }
        });*/
        if(lazyImg=="1"){
            $(document).ready(function() {
                // 监听滚动事件
                $(".left-content-wrap").scroll(function() {
                    // 获取视口高度
                    var viewportHeight = $(".detail-left").height();
                    // 获取滚动条滚动的距离
                    var scrollTop = $(".detail-left").scrollTop();

                    // 遍历所有带有.lazy类的图片
                    $('.lazy1').each(function() {
                        // 获取图片元素
                        var $img = $(this);
                        // 获取图片元素距离顶部的距离
                        var imgTop = $img.offset().top;
                        if(imgTop!=0){
                            // 如果图片元素进入视口范围，则加载图片
                            if (imgTop <= viewportHeight + scrollTop+$img.width()) {

                                $img.attr('src', $img.data('src')); // 设置图片的src属性为data-src的值
                                //$img.addClass('loaded'); // 添加.loaded类，显示图片
                                $img.removeClass('lazy1');

                            }
                        }
                    });
                });

                // 触发一次滚动事件，加载视口内的图片
                $(".left-content-wrap").scroll();
            });
        }

    }
    String.prototype.colorHex = function () {
        // RGB颜色值的正则
        var reg = /^(rgb|RGB)/;
        var color = this;
        if (reg.test(color)) {
            var strHex = "#";
            // 把RGB的3个数值变成数组
            var colorArr = color.replace(/(?:\(|\)|rgb|RGB)*/g, "").split(",");
            // 转成16进制
            for (var i = 0; i < colorArr.length; i++) {
                var hex = Number(colorArr[i]).toString(16);
                if (hex === "0") {
                    hex += hex;
                }
                strHex += hex;
            }
            return strHex;
        } else {
            return String(color);
        }
    };
    //根据首页地市切换例外
    var excepSwitch = function($this){
        $this.find(".exception").each(function () {
            var _this = $(this);
            var regnId = _this.attr("regnId");
            var regnIds = regnId.split(",");
            var regnIdsStr = regnId.replace(/,/g, "");
            for (var i = 0;i<regnIds.length;i++){
                if (regnIds[i] === cityScope) {
                    _this.parent("li").siblings().removeClass("active");
                    _this.parent("li").addClass("active");
                    var sel = _this.parents("div.atoms");
                    var atomId = sel.attr("atomId");
                    var regn = regnId.replace(/,/g, "");
                    sel.children('.' + atomId).addClass("hide");
                    sel.children("." + regn).removeClass("hide");
                    var message = _this.parents("div.left-words").find("a.message");
                    if (_this.attr("isSendMes") === "1") {
                        message.addClass("hide").removeClass("notSendMessage");
                        _this.parents("div.left-words").find("a." + regn).removeClass("hide");
                    } else {
                        message.addClass("hide");
                        _this.parents("div.left-words").find("a." + regn).removeClass("hide").addClass("notSendMessage");
                    }
                    var arrow = $(".left-words").find("div.above-arrow");
                    if (arrow.length > 0) {
                        arrow.remove();
                    }
                    var explain = $(".left-explain").find("div.above-arrow");
                    if (explain.length > 0) {
                        explain.remove();
                    }
                    // 例外渲染
                    clickExceptionRenderDom(regnIdsStr, _this);
                }
            }

        });
    }
    var alsNameAndKeyWordShow = function () {
        var alsAndsearchKey = "";
        knwlgAls = $detaiTitle.find("h2");
        if(knwlgAls.length !== 0 || $orangeLine.length > 0){
            var alsAndKeyWidth = $("#knwlgNm").parent().width();
            var textLength = Math.ceil(alsAndKeyWidth/20);
            if (knwlgAls.length !== 0) {
                $detaiTitle.find("h2").remove();
                var knwlgAlsText = knwlgAls.text();
                if (knwlgAlsText) {
                    alsNameAll="知识别名："+knwlgAlsText;
                    if (alsNameAll.length>textLength) {
                        alsNameSub = alsNameAll.substring(0, textLength);
                        alsAndsearchKey = "<h2 id='alsName'>" + alsNameSub + "<a id='closeAlsNm'class='closed' href='javascript:void(0)' style='position:absolute'><i class='icon icon km-xialajiantou'></i></a><br/></h2>";
                    }else {
                        alsAndsearchKey = "<h2 id='alsName'>" + alsNameAll + "</h2>"
                    }
                }
            }

            if (searchKeyWordAll) {
                searchKeyWordAll = "搜索关键词："+$.trim(searchKeyWordAll);
                if (searchKeyWordAll.length>textLength){
                    searchKeyWordSub = searchKeyWordAll.substring(0,textLength);
                    alsAndsearchKey = alsAndsearchKey + "<h2 id='searchKeyName'>" + searchKeyWordSub + "<a id='keyWordClosed' class='closed' href='javascript:void(0)' style='position:absolute'><i class='icon icon km-xialajiantou'></i></a><br/></h2>";
                } else {
                    alsAndsearchKey = alsAndsearchKey + "<h2 id='searchKeyName'>" + searchKeyWordAll + "</h2>";
                }
            }
            if (knwlgAls.length && searchKeyWordAll) {
                $detaiTitle.css("height", "154px");
                leftConWrap.css("top", "154px");
                catelog.css("top", "205px");
            }
            $detaiTitle.append(alsAndsearchKey);
            $("#searchKeyName").css("width",alsAndKeyWidth);
            $("#alsName").css("width",alsAndKeyWidth);
        }
    }
    //获取原子查看权限
    var getAtomsPurview = function () {
        // var start = new Date();
        var $knwlgNm = $detaiTitle.find("#knwlgNm");
        var knwlgNm = $knwlgNm.text();
        knowledgeTitle = knwlgNm;
        document.title = knwlgNm;
        if (knwlgNm.length > 56) {
            $detaiTitle.find("h1").append("<a class=\"copyIcon\" title=\"复制\" id='knwlgNm-copy'></a>");
            $detaiTitle.find("h1").attr('title', knwlgNm);
            $knwlgNm.text(knwlgNm.substring(0, 56) + "...");
        }
        if($knwlgNm.children().find("span").hasClass('dated')){
            $knwlgNm.css('color','rgb(128,128,128)');
        }
        $orangeLine = $detailLeft.find(".orange-line:contains('搜索关键词')");
        if ($orangeLine.length > 0) {
            var yuanLengrh = $orangeLine.parent().find(".yuanzi-con").length;
            if (yuanLengrh > 0) {
                searchKeyWordAll = $orangeLine.parent().find(".yuanzi-con").text();
            } else {
                searchKeyWordAll = $orangeLine.parent().parent().find(".yuanzi-con").text();
            }
        }
        Util.ajax.getJson(Constants.AJAXURL + '/knowledge/dealAtomPrivNew', {"knwldgeId": knwlgId}, function (data, status) {
            if (status) {
                //var atomPrivIds = data.bean;//有权限查看的所有原子id
                var removeAtoms = data.object.removeAtomList;
                cityScope = data.object.scope;
                //过滤原子
                if (removeAtoms && removeAtoms.length>0) {
                    $.each(removeAtoms,function (index,item) {
                        //domArray.find("#"+item).remove();
                        domArray.find("div[atomId= "+item+"]").remove();
                    })
                }
                /*domArray.find(".atoms").each(function () {
                    var atomId = $(this).attr("atomId");
                    if (atomId) {
                        if (atomPrivIds.indexOf(atomId) < 0) {
                            //删除无权限查看原子内容
                            $(this).remove();
                        }
                    }
                });*/
                $detailLeft.show();
                navigateBars.getKlgAtoms();
                var atomPriv = domArray.children("div:not(#biaoqiang)").find(".atoms");
                if (!atomPriv || atomPriv.size() == 1) {
                    if(data.object.docEditPus){
                       var knwlgStsCd= data.object.docEditPus.knwlgStsCd;
                       if("D"==knwlgStsCd||"DL"==knwlgStsCd){
                           dialog.alert({type: 'success', message: "此处配置的知识已被删除，请使用“信息反馈”功能向采编人员反馈。"})
                       } else if("PR"==knwlgStsCd){
                           dialog.alert({type: 'success', message: "此处关联的知识正在编辑中，暂时无法查看。"})
                       }
                    }else{
                        dialog.alert({type: 'success', message: "您无权限查看该知识内所有原子"})
                    }

                }else {
                    execpClick();//初始化左右箭头
                    domArray.asynSearch(excepSwitch);
                }
                if(data.object.docEditPus.knwlgGathrTypeCd == '2' && data.object.docEditPus.regnId != '000'){
                    $('.exception[regnId="moren"]').trigger('click');
                }
                var end = new Date();
                var tpl_duration = end - start;
                // <editor-fold desc="ngkm_knowledgeDetail_info_content 知识详情页埋点">
                /*Util.ajax.getJson(Constants.AJAXURL + "/sensorsdata/getSensorsdata?t=" + +new Date().getTime(), {}, function (data) {
                    if (data.returnCode == 0 && data.object == "true") {
                        var tpl_duration = end - start;
                        if (sensorsdata) {
                            sensorsdata.track("ngkm_knowledgeDetail_info_content", {
                                tpl_duration: tpl_duration,
                                knwlgId:knwlgId
                            });
                        }
                    }
                });*/
                Util.ajax.getJson(Constants.AJAXURL + "/sensorsdata/getSensorsdata?t=" + +new Date().getTime(), {}, function (data) {
                    if (data.returnCode == 0 && data.object == "true") {
                        var tpl_duration = end - start;
                        if (sensorsdata) {
                            sensorsdata.track("ngkm_knowledgeDetail_info_content", {
                                tpl_duration: tpl_duration,
                                knwlgId:knwlgId
                            });
                        }
                    }
                });


            } else {

            }
            //删除没有原子内容的原子分组及右侧导航栏
            domArray.find(".left-content-subtitle").each(function () {
                var _this = $(this);
                if (_this.find("div.atoms").length === 0) {
                    _this.remove();
                    $("a[href='#" + _this.find("a.para-title").attr('id') + "']").parent().remove();
                }
            });
            domArray.find(".left-content").each(function () {
                var _this = $(this);
                if (_this.find("div.atoms").length === 0 && !_this.hasClass("rlt-knwlg-content")) {
                    _this.remove();
                    $("a[href='#" + _this.attr('id') + "']").parent().remove();
                }
            });
            //点击摘要信息  跳转到指定位置
            var atomId = kmUtil.getUrlParamter("atomId");
            if (atomId) {
                leftConWrap.scrollTop($("[atomid=" + atomId + "]").offset().top - (80 + $(".detail-title").height()));
            }
            domArray.asynSearch(addPreview);
            alsNameAndKeyWordShow();
        });
    }

    // 是否开启暗水印
    var getWatermarkType = function () {
        Util.ajax.getJson(Constants.AJAXURL + '/knowledge/getBlindWaterSwitch'+ "?t=" + new Date().getTime(), {}, function (data) {
            if (data && data.returnCode == 0) {
                var beanInfo = data.bean;
                var isBlind = beanInfo.isBlind;
                if (isBlind == 1) {
                    //暗水印
                    kmUtil.addKlgDetailBlindWaterMark();
                } else {
                    //明水印
                    kmUtil.addKlgDetailWaterMark();
                }
            } else {
                //明水印
                kmUtil.addKlgDetailWaterMark();
            }
        });
    }

    var regnIdReg = function (regnId) {
        //点击的时候只能是一对一，或者一对多，不能多对一-
        return new RegExp('(^' + regnId + '$)|(^' + regnId + ',{1})|(,{1}' + regnId + ',{1})|(,{1}' + regnId + '$)');
    };
    //自适应名称区域高度
    var getAlsAndKeyWordHig = function (closeFlag) {
        var klgNameHig = $("#knwlgNm").parent()[0].offsetHeight;
        var alsNameHig = 0;
        var keyWordHig = 0;
        if (alsNameAll){
            alsNameHig = $("#alsName")[0].offsetHeight;
        }
        if (searchKeyWordAll){
            keyWordHig = $("#searchKeyName")[0].offsetHeight;
        }
        var totalHig = klgNameHig+alsNameHig+keyWordHig;
        var detailHig = $detaiTitle[0].offsetHeight;
        if (totalHig > detailHig) {
            if (closeFlag == 0) {
                //展开
                var newTop = 154 + (totalHig - detailHig) + 30 + "px";
                var catelogNewTop = 205 + (totalHig - detailHig) + 30 + "px";
                leftConWrap.css("top", newTop);
                catelog.css("top", catelogNewTop);
            } else {
                //折叠
                var newTop = 154 + (totalHig - detailHig) + 30 + "px";
                var catelogNewTop = 205 + (totalHig - detailHig) + 30 + "px";
                leftConWrap.css("top", newTop);
                catelog.css("top", catelogNewTop);
            }
        }else {
            leftConWrap.css("top", "154px");
            catelog.css("top", "205px");
        }
    }
    var showAlsName = function () {
        if (alsNameAll || searchKeyWordAll){
            var $alsName = $("#alsName");
            var $searchKeyName = $("#searchKeyName");
            var alsAndKeyWidth = $("#knwlgNm").parent().width();
            var textLength = Math.ceil(alsAndKeyWidth/20);
            if (alsNameAll && alsNameAll.length>0){
                if (alsNameAll.length>textLength) {
                    alsNameSub = alsNameAll.substring(0, textLength);
                    $alsName.html(alsNameSub + "<a id='closeAlsNm'class='closed' href='javascript:void(0)' style='position:absolute'><i class='icon icon km-xialajiantou'></i></a><br/>");
                }else {
                    $alsName.html(alsNameAll);
                }
                $alsName.css("width",alsAndKeyWidth);
            }
            if (searchKeyWordAll && searchKeyWordAll.length>0) {
                if (searchKeyWordAll.length>textLength){
                    searchKeyWordSub = searchKeyWordAll.substring(0, textLength);
                    $searchKeyName.html(searchKeyWordSub + "<a id='keyWordClosed'class='closed' href='javascript:void(0)' style='position:absolute'><i class='icon icon km-xialajiantou'></i></a><br/>");
                }else {
                    $searchKeyName.html(searchKeyWordAll);
                }
                $searchKeyName.css("width",alsAndKeyWidth);
            }
            leftConWrap.css("top","154px");
            catelog.css("top","205px");
        }
    }
    //展开/闭合右侧
    var closeRight = function (obj) {
        var i = $(obj).find("i");
        var span = $(obj).find("span");
        var click_closebtn_time = new Date().Format("yyyy-MM-dd HH:mm:ss");
        if (i.hasClass("km-arrow_l")) {
            $detailLeft.css("right", "300px");
            $detailRight.css("winth", "290px");
            $layout.removeClass("close-view");
            span.html("闭合右侧");
            i.removeClass("km-arrow_l").addClass("km-arrow_r");
            showAlsName();
            $('.klgevaluationTips').css('left', $('#evaluateAvg').offset().left - 250);

            //getAlsAndKeyWordHig();
            // 新增埋点 展开闭合右侧
            Util.ajax.getJson(Constants.AJAXURL + "/sensorsdata/getSensorsdata?t=" + +new Date().getTime(), {}, function (data) {
                if (data.returnCode == 0 && data.object == "true") {
                    if (sensorsdata) {
                        sensorsdata.track("ngkm_knwlgDetail_closeBtn_click", {
                            click_closebtn_time: click_closebtn_time,
                            knwlg_id: knwlgId,
                            knwlg_name: knwlgName,
                            closeBtnState: "展开右侧",
                            defaultCloseBtnState: defaultCloseBtnState
                        });
                    }
                }
            });
        } else {
            $('.klgevaluationTips').css('left', $('#evaluateAvg').offset().left + 35);
            $detailLeft.css("right", "");
            $detailRight.css("winth", "");
            $layout.addClass("close-view");
            span.html("展开右侧");
            i.removeClass("km-arrow_r").addClass("km-arrow_l");
            showAlsName();
            //getAlsAndKeyWordHig();
            // 新增埋点 展开闭合右侧
            Util.ajax.getJson(Constants.AJAXURL + "/sensorsdata/getSensorsdata?t=" + +new Date().getTime(), {}, function (data) {
                if (data.returnCode == 0 && data.object == "true") {
                    if (sensorsdata) {
                        sensorsdata.track("ngkm_knwlgDetail_closeBtn_click", {
                            click_closebtn_time: click_closebtn_time,
                            knwlg_id: knwlgId,
                            knwlg_name: knwlgName,
                            closeBtnState: "闭合右侧",
                            defaultCloseBtnState: defaultCloseBtnState
                        });
                    }
                }
            });
        }
    };
    //显示/隐藏不可发送项
    var hideNotSendMes = function (obj) {
        var _this = $(obj);
        if (_this.find("i").hasClass("km-yanjing1")) {
            _this.find("i").removeClass("km-yanjing1").addClass("km-yanjing");
            _this.find("span").html("显示不可发送项");
            notSendMessage.parent().parent().hide();
        } else {
            _this.find("i").removeClass("km-yanjing").addClass("km-yanjing1");
            _this.find("span").html("隐藏不可发送项");
            notSendMessage.parent().parent().show();
        }
    };
    //显示/隐藏菜单树
    var hideCatelog = function (obj) {
        if (knowdDetail.hasClass("close-catelog")) {
            $(obj).find("span").html("隐藏菜单树");
            knowdDetail.removeClass("close-catelog");
        } else {
            $(obj).find("span").html("显示菜单树");
            knowdDetail.addClass("close-catelog");
        }
    };
    //展开/闭合分组
    var closed = function (obj) {
        var _this = obj;
        if (_this.find("i").hasClass("km-shanglajiantou")) {
            _this.html('<i class="icon km-xialajiantou"></i>展开');
            _this.parent().nextAll().hide();
        } else {
            _this.html('<i class="icon km-shanglajiantou"></i>闭合');
            _this.parent().nextAll().show();
        }
        conMethod.objFunction();
    }
    // 闭合/显示注解
    var zhj = function (obj) {
        var _this = obj;
        if (_this.hasClass('chked')) {
            _this.removeClass("chked");
            _this.parent().next().find(".is-zhujie").text("：");
            _this.parent().next().find(".zhujie-con").show();
            if (_this.parent().next().find(".above-arrow").length == 0) {
                _this.parent().next().find(".zhujie-con").parent("div").each(function () {
                    if (this.offsetHeight != undefined && this.clientHeight != undefined) {
                        if (this.offsetHeight - this.clientHeight > 0) {
                            execpClick();
                        }
                    }
                });
            }
            conMethod.objFunction();
        } else {
            _this.addClass("chked");
            _this.parent().next().find(".is-zhujie").text("");
            _this.parent().next().find(".zhujie-con").hide();
            conMethod.objFunction();
            _this.parent().next().find(".above-arrow").hide();
        }
    };
    //加载图片
    var myImgLoad = function (imgIndex) {
        var wHeight = $(window).height() - 100;
        var wWidth = $(window).width() - 100;
        // var imgInner = $("#img-inner");
        $imgInner.empty();//删除旧图片
        $imgContent.show();
        $imgInner.append("<img id='my-img' src='" + atomImgAll[imgIndex].src + "'>");
        var innerHeight = $imgInner.height();
        var innerwidth = $imgInner.width();
        var $this = $imgContent.find("#my-img");
        var iHeight = $this.height();
        var iWidth = $this.width();
        if (iHeight > wHeight) {
            iWidth = (wHeight / iHeight) * iWidth;
            iHeight = wHeight;
        }
        if (iWidth > wWidth) {
            iHeight = (wWidth / iWidth) * iHeight;
            iWidth = wWidth;
        }
        $this.removeAttr("style");
        $imgInner.removeAttr("style");
        var top = (innerHeight - iHeight) / 2;
        $this.css({width: iWidth + "px", height: iHeight + "px"});
        $this.css("margin-top", top + "px");
    }
    //图片缩放
    var zoomImg = function (o, innerwidth, zoomiWidth, zoomOne) {
        var zoom = parseInt(o.style.zoom, 10) || 100;
        zoom += event.wheelDelta / 12;
        if (zoomiWidth < innerwidth * 0.7 && zoom > 0 || zoomOne > zoom) {
            o.style.zoom = zoom + '%';
        }
        return false;
    };
    //上一张
    var imgLeft = function () {
        if ($imgLeft[0].style.display == "none") {
            return;
        }
        imgIndex -= 1;
        myImgLoad(imgIndex);
        $imgRight.css("display", "block")
        if (imgIndex == 0) {
            //第一张图片，不展示左侧切换按钮
            $imgLeft.css("display", "none")
        } else {
            $imgLeft.css("display", "block")
        }
    };
    //下一张
    var imgRight = function () {
        if ($imgRight[0].style.display == "none") {
            return;
        }
        imgIndex += 1;
        myImgLoad(imgIndex);
        $imgLeft.css("display", "block")
        if (imgIndex == atomImgAll.length - 1) {
            //最后一张图片，不展示右侧切换按钮
            $imgRight.css("display", "none")
        } else {
            $imgRight.css("display", "block")
        }
    };
    //关闭轮播
    var imgClose = function () {
        $imgContent.hide();
        $imgContent.find("#my-img").remove();
        return false;
    };
    //云问卷
    var CloudNaire = function (knwlgId) {
        var config = {
            type: 'post',
            url: Constants.AJAXURL + '/knowledge/getCloudNaire',
            data: {knwlgId: knwlgId},
            dataType: 'json',
            success: function (data, textStatus) {
                if (textStatus !== "success") {

                    return false;
                }
                if (data.returnCode !== '0') {

                    return false;
                }
                if (data.object === null || data.object === undefined) {

                    return false;
                }
                var QueNm = data.object.otherCloudQueNm;
                var QueUrl = data.object.otherCloudQueUrl;
                if (QueNm !== null && QueNm !== undefined && QueUrl !== null && QueUrl !== undefined) {
                    var yunwenjuan;
                    var ywjLimk = $detaiTitle.find('.ywj-link');
                    if (ywjLimk.length === 0) {
                        yunwenjuan = '<a class="ywj-link" href="javascript:void(0);" url="' + QueUrl + '" title="' + QueNm + '"><i class="icon km-s-logo"></i><em>云问卷</em></a>';
                        $detaiTitle.find("h1").append(yunwenjuan);
                    } else {
                        var QueNmBig = ywjLimk.attr("title");
                        var QueUrlBig = ywjLimk.attr("url");
                        $detaiTitle.find(".ywj-link").remove();
                        yunwenjuan = '<div class="add-ywj-link"> <a class="ywj-link" href="javascript:void(0);" ><i class="icon km-s-logo"></i><em>云问卷</em></a>' +
                            '<div class="ywj-add-inner"  style="display:none"> ' +
                            '<ul> ' +
                            '<li title="' + QueNmBig + '" url="' + QueUrlBig + '">' + QueNmBig + '</li> ' +
                            '<li title="' + QueNm + '" url="' + QueUrl + '">' + QueNm + '</li> ' +
                            '</ul> </div> </div>';
                        $detaiTitle.find("h1").append(yunwenjuan);
                        $detaiTitle.find('.ywj-add-inner').hover(function () {
                        }, function () {
                            $(this).attr("style", "display:none");
                        });
                    }
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                dialog.alert({type: 'error', message: errorThrown});
            }
        };
        Util.ajax.ajax(config);
    };
    CloudNaire(knwlgId);
    //访问记录统计
    var addAccessChnlRecord = function () {
        if (kmUtil.getUrlParamter("sysCode")) {
            var ChnlCode = kmUtil.getUrlParamter("sysCode");
            var PageName = "新知识详情页";
            var config = {
                type: 'post',
                url: Constants.AJAXURL + '/chnlRecord/addAccessChnlRecord',
                data: {ChnlCode: ChnlCode, PageName: PageName, _v: new Date().getTime()}, //要传递给url的数据
                dataType: 'json', //返回值的数据类型
                async: true,
                success: function (result) {
                    if (result.returnCode == "0") {

                    } else {

                    }
                },
                error: function () {

                }
            };
            Util.ajax.ajax(config);
        }
    };
    // 记录点击日志
    var recordLog = function () {
        // 记录日志明细
        // var knwlgId = kmUtil.getUrlParamter("knwlgId")||knwlgId;//知识id
        var keyWord = kmUtil.getUrlParamter("keyWord"); //关键词
        var rsltTotalCnt = kmUtil.getUrlParamter("rsltTotalCnt");//结果总数
        var pstnNo = kmUtil.getUrlParamter("pstnNo");//位置号
        var srcTypeCd = kmUtil.getUrlParamter("srcTypeCd");//类型;
        var searchLogId = kmUtil.getUrlParamter("searchLogId");  // 关键词搜索日志id
        var imgSearchSign = kmUtil.getUrlParamter("imgSearchSign"); // 以图搜文标识
        var pageNum;
        var pageRank;
        if (null!=imgSearchSign&&"1"==imgSearchSign){
            searchLogId= kmUtil.getUrlParamter("imgSearchLogId"); // 以图搜文搜索日志id
            pageNum = kmUtil.getUrlParamter("imgPageSize"); // 内容所在页展示条数
            pageRank = kmUtil.getUrlParamter("imgPageRank"); // 内容所在页面号
        }
        if (srcTypeCd == null || srcTypeCd == "") {
            srcTypeCd = "1";
        }

        var knwlgDetail =  decodeURIComponent(kmUtil.getUrlParamter("knwlgDetail"));

        knwlgDetail = JSON.parse(knwlgDetail);

        var cmd = {
            "knwlgId": knwlgId,
            "srcTypeCd": srcTypeCd,
            "keyWord": keyWord,
            "rsltTotalCnt": rsltTotalCnt,
            "pstnNo": pstnNo,
            "serviceCode": serviceCode,
            "serviceName": serviceName,
            "accessType": accessType,
            "sourceFlag": "fromNewDetail",
            "searchLgId": searchLogId,
            "contentRank":pstnNo,
            "pageNum":pageNum,
            "pageRank":pageRank
            // "searchTitleTypeNm": knwlgDetail.searchTitleTypeNm,
            // "knwlgNm": knwlgDetail.knwlgNm,
            // "wholeKeyWord": knwlgDetail.wholeKeyWord,
            // "knowledgeScore": knwlgDetail.knowledgeScore,
            // "isFirstClick": knwlgDetail.isFirstClick,
            // "contentRank": knwlgDetail.contentRank,
            // "pageRank": knwlgDetail.pageRank,
            // "pageNum": knwlgDetail.pageNum,
            // "baseSign": knwlgDetail.baseSign
        };

        if (knwlgDetail){
            cmd.searchTitleTypeNm = knwlgDetail.searchTitleTypeNm;
            cmd.knwlgNm = knwlgDetail.knwlgNm;
            cmd.wholeKeyWord = knwlgDetail.wholeKeyWord;
            cmd.knowledgeScore = knwlgDetail.knowledgeScore;
            cmd.isFirstClick = knwlgDetail.isFirstClick;
            cmd.contentRank = knwlgDetail.contentRank;
            cmd.pageRank = knwlgDetail.pageRank;
            cmd.pageNum = knwlgDetail.pageNum;
            cmd.baseSign = knwlgDetail.baseSign;
        }
        if (null!=imgSearchSign&&"1"==imgSearchSign){
            var imgSearchClickDetail = {
                type: 'POST',  //请求类型 '../../../data.json'
                url: Constants.AJAXURL + '/record/saveImgSearchClickLog', //Constants.AJAXURL + '/knowledge/getKmDetatil',    //接受请求的地址
                data: JSON.stringify(cmd),
                dataType: 'json', //返回值的数据类型
                headers: {'Content-Type': 'application/json;charset=utf-8'},
                success: function (data, textStatus) {
                    if (textStatus == "success") {
                        var flag = data.bean;
                        if (true == flag) {

                        }
                    } else {

                    }
                },  //url调用成功后执行的回调函数
                error: function (jqXHR, textStatus, errorThrown) {

                }  //url调用失败后执行的回调函数
            };
            Util.ajax.ajax(imgSearchClickDetail);
        }

        var config = {
            type: 'POST',  //请求类型 '../../../data.json'
            url: Constants.AJAXURL + '/record/saveLogDetail', //Constants.AJAXURL + '/knowledge/getKmDetatil',    //接受请求的地址
            data: JSON.stringify(cmd),
            dataType: 'json', //返回值的数据类型
            headers: {'Content-Type': 'application/json;charset=utf-8'},
            success: function (data, textStatus) {
                if (textStatus == "success") {
                    var flag = data.bean;
                    if (true == flag) {

                    }
                } else {

                }
            },  //url调用成功后执行的回调函数
            error: function (jqXHR, textStatus, errorThrown) {

            }  //url调用失败后执行的回调函数
        };
        Util.ajax.ajax(config);
        // 异步记录日志总数
        Util.ajax.getJson(Constants.AJAXURL + '/record/saveLog', {"knwlgId": knwlgId}, function (data, status) {
            if (status) {
                var flag = data.bean;
                if (true == flag) {

                }
            } else {

            }
        }, false);
    };
    // 编译省份例外的html
    var hdb = function (knowledgeInfo,$atoms) {
        //注册一个判断相等的Helper,判断v1是否等于v2
        Util.hdb.registerHelper("equal", function (v1, v2, options) {
            if (v1 === v2) {
                //满足添加继续执行
                return options.fn(this);
            } else {
                //不满足条件执行{{else}}部分
                return options.inverse(this);
            }
        });
        //注册一个判断相等的Helper,判断v1是否不等于v2
        Util.hdb.registerHelper("notEqual", function (v1, v2, options) {
            if (v1 !== v2) {
                return options.fn(this);
            } else {
                return options.inverse(this);
            }
        });
        //注册一个判断是否直接显示value值的Helper,是否直接显示value
        Util.hdb.registerHelper("normal", function (v1, options) {
            if (v1 === '1' || v1 === '2' || v1 === '3' || v1 === '4' || v1 === '5' || v1 === '6' || v1 === '7' || v1 === '9' ||
                v1 === '11' || v1 === '12' || v1 === '14' || v1 === '16') {
                return options.fn(this);
            } else {
                return options.inverse(this);
            }
        });
        //注册一个判断是否有单位
        Util.hdb.registerHelper("unit", function (v1, options) {
            if (v1 === '5' || v1 === '9' || v1 === '11' || v1 === '12') {
                return options.fn(this);
            } else {
                return options.inverse(this);
            }
        });
        //注册一个判断数组为空的的Helper,判断item是否为空
        Util.hdb.registerHelper("blank", function (items, options) {
            if (items.length !== 0) {
                return options.fn(this);
            } else {
                return options.inverse(this);
            }
        });
        //注册一个判断是否有单位
        Util.hdb.registerHelper("excp", function (v1, options) {
            if (v1 === '8' || v1 === '10' || v1 === '13' || v1 === '15') {
                return options.fn(this);
            } else {
                return options.inverse(this);
            }
        });
        // var authRegnNms = knowledgeInfo.authRegnNm.split(",");
        // knowledgeInfo.authRegnNms = authRegnNms;
        //编译省份例外原子
        var templateExcept;
        var exceptionZhujie;
        templateExcept = Util.hdb.compile(knowledgeInfoGroupexception);
        exceptionZhujie = Util.hdb.compile(knowledgeInfoGroupexceptionZhujie);
        var templateExceptHtml = templateExcept(knowledgeInfo);
        var templateExceptHtmlZhujie = exceptionZhujie(knowledgeInfo);
        // console.log($atoms)
        $atoms.html(templateExceptHtml);
        $atoms.after(templateExceptHtmlZhujie);
        $atoms.asynSearch(addPreview);//加按钮
        if (templateExceptHtmlZhujie != '') {
            var left_words = $atoms.next();
            exceptionHideAdd(left_words);//折叠缩略
        }
        exceptionHideAdd($atoms);//折叠缩略
        // domArray.asynSearch(addPreview);//加按钮
        // 插入页面对应位置templateExceptHtml
    }


    // 例外功能拆分 点击渲染
    var clickExceptionRenderDom = function (regnIds, _this) {
        var URL = decodeURI(window.location.href);
        var urlIdenti = URL.substr(0, URL.indexOf("?"));
        var identify = urlIdenti.substr(urlIdenti.lastIndexOf('_') + 1, 1);//是否是去掉省份例外的知识的标识
        // if (_this.parents('.atoms').find("div." + regnIds).length < 0) {
        if (identify == '0' && (_this.parents('.atoms').find(".left-explain." + regnIds).find('.yuanzi-con').length == 0)) {
            var grpngIds = [];
            domArray.find('div.left-content').each(function () {
                // console.log($(this).attr("id").split(',').length);
                if ($(this).attr("id").split(',').length > 1) {
                    grpngIds.push($(this).attr("id").replace(/,/g, ''));
                }
            })
            // var arr = knowledgeDetailInfo.knwldgGroupItems;
            var arr = window.knwldgGroupItems;
            for (var q = 0; q < grpngIds.length; q++) {
                var grpngId = grpngIds[q];
                for (var i = 0; i < arr.length; i++) {
                    var ele = arr[i];
                    if (ele.grpngId == grpngId) {
                        var tempArr = ele.atrrItems;
                        for (var j = 0; j < tempArr.length; j++) {
                            var element = tempArr[j];
                            var knwlgAttrAtomId = element.knwlgAttrAtomId;
                            var exceptionMapList = element.exceptionMapList;
                            for (var o = 0; o < exceptionMapList.length; o++) {
                                var objmap = exceptionMapList[o];
                                var flagRegnIds = objmap.regnIds.split(',');
                                if ($.inArray(regnIds,flagRegnIds) >= 0 || objmap.regnId == regnIds) {
                                    hdb(objmap, domArray.find('.atoms[atomid=' + knwlgAttrAtomId + ']').find(".left-explain." + objmap.regnId));
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    //全局点击事件
    var gloBalClick = function () {

        domArray.on("click", "div.atoms a[linkType = 'relateTool']", function () {
            var openMode = kmUtil.getOpenMode() || "1";
            
            var menuId = $(this).attr('menuRelate').split('_')[0];
            var menuName = $(this).attr('menuRelate').split('_')[1];
            Util.ajax.ajax({
                type: "POST",
                url: Constants.AJAXURL + "/knowledge/checkMneuAuthByStaffId",
                data: JSON.stringify({ "menuId": menuId }),
                dataType: "json",
                headers: {
                    'Content-Type': 'application/json;charset=utf-8'
                },
                success: function (data) {
                    if (data.returnCode == '0') {
                        if (openMode == '1') {
                            window.localStorage.setItem('toolMenuInfo', JSON.stringify({ menuName: menuName, menuUrl: data.object }));
                            new myAlert({ type: 'error', text: "请前往一体化客服系统核实是否成功跳转至相应菜单工具。", falseShow: false, trueName: "知道了" });
                            return;
                        } else {
                            CrossAPI.createTab(menuName,data.object);
                            // 新增埋点 工具跟随跳转
                            var click_closebtn_time = new Date().Format("yyyy-MM-dd HH:mm:ss");
                            Util.ajax.getJson(Constants.AJAXURL + "/sensorsdata/getSensorsdata?t=" + +new Date().getTime(), {}, function (data) {
                                if (data.returnCode == 0 && data.object == "true") {
                                    if (sensorsdata) {
                                        sensorsdata.track("ngkm_knwlgDetail_toolMenuBtn_click", {
                                            click_btn_time: click_closebtn_time,
                                            knwlg_id: knwlgId,
                                            knwlg_name: knwlgNM,
                                            menuId: menuId,
                                            menuName: menuName,
                                            ifjump: "是"
                                        });
                                    }
                                }
                            });
                        }
                        
                    } else {
                        new myAlert({ type: 'error', text: data.returnMessage, falseShow: false, trueName: "知道了" });
                        // 新增埋点 工具跟随跳转
                        var click_closebtn_time = new Date().Format("yyyy-MM-dd HH:mm:ss");
                        Util.ajax.getJson(Constants.AJAXURL + "/sensorsdata/getSensorsdata?t=" + +new Date().getTime(), {}, function (data) {
                            if (data.returnCode == 0 && data.object == "true") {
                                if (sensorsdata) {
                                    sensorsdata.track("ngkm_knwlgDetail_toolMenuBtn_click", {
                                        click_btn_time: click_closebtn_time,
                                        knwlg_id: knwlgId,
                                        knwlg_name: knwlgNM,
                                        menuId: menuId,
                                        menuName: menuName,
                                        ifjump: "否"
                                    });
                                }
                            }
                        });
                    }
                }
            })
            return false;
        });
        domArray.on("click", ".pre-video", function () {
            myVideoLoad($(this).attr("fileid"), $(this).attr("link"));
            return false;
        });

        //点击发送短信图标，触发监听事件调用header.js中的msgCount方法
        domArray.on("click", "div.atoms .attrData", function (e) {
            var $this = $(this);
            //卡片类型不允许发送短信
            if ($(this).parent('div').attr('paraTypeCd') == '22') {
                new Dialog({
                    mode: 'tips',
                    tipsType: 'error',
                    content: '暂不支持卡片类型原子短信下发！'
                });
                return;
            }else {
                fireEvent.msgCount && fireEvent.msgCount($this, e);
            }
        });

        domArray.on("mouseover","div.atoms .attrData",function (e) {
            // 短信图标悬浮提示
                e = e || window.event;
                var base64 = '';
                if ($(this).hasClass("normal-text")) {
                    base64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAQCAYAAADj5tSrAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAt5JREFUOMudlEtME1EUhsdF2YCorCS6wJhIdMHC10ZNTAyCxgVsjRGNiVtFSTTujDERWsKzRsAABkFeYgjRIkhEKCACERARyvRJobSFFlpo6fP33GkGIS1YvcmfSe6cc79z/jlzOQAcE5evFpVIGokv0S7vKY1eccXaZcqrIUnEszbODoPk8umna40wr/mxvB6A2xeE2x9Z6yQXvWdxUzYvYos1bk6qjv875BmfdrnFBHGNWz0YtXgwFkFsf8buFeIYbG+pdoWT8rE7Q6R8OvdE1Z/21hRkiVZXABea5nG8ZhanXhv/iDo9Sc+U6llkKSxgwQ5PALtLtAHuqaqBk6mPRYZI+TuHXuqR+c6ESy0mv9gJs8ThDWB1k5ykNW9QeHr8Qj1YcvtxoEznu91hCSbItVay7UQ4JJcfY1XmD9mR0bogJHoDQdxotyCteR7MQlGpDXOQj65g82KdJFcZ0Klz4TAVy+Xx8jBITJH25/kmM+IKtThSacCc0yckf9K70DjtRLNqdUMNU058N3u2QL6a3Ngl43GwwoCUmjmQXYoIEM1EvcaHWrUXZ+pNSHqhQ/nY1mojLTtN1qOeJewr1eJKqxXvjX48HHCAnPkQBpEUaiYqpz0YtgPKReDx0CqSygw4V2dE96wrIqBu0oHkCj2OVhlR9MONwSWAuZjdu7IzpI8A3RZg0AZ8pCHL6rQhQa7DdYUZBkfIwuGFdaQ2ziPxuR45Sge+UPwAAbrNwDfKu6eMAvLZHFKPNZRUy3txtmkBSVT1RRrp/WRlRtsi2owB4T2DiDkhiGCXIiqIKLbHKpWNunCtw4byKY9wWK81PJbt3+/bHjJZrYoMYWJW9BOIJnzbGBHyYMDJIO3h/0keP5JNXrKBYof8r8YdwK0uO0Fm3kT647Po5kUOtfqKOqpimo5ezAVm912aLHYOJ+Mzt7u7blJHSkmB5lcMfSPJP0iIL9BMUn4XnXN18931Gz2i0iukRc4pAAAAAElFTkSuQmCC';
                }else{
                    base64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAQCAYAAADj5tSrAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAzdJREFUOMudlEtMU1EQhtm4MnFvjDtBRV0oC0XciCai0cRHYnygWAEViW1IRAMoghqjWAyoaOJCQXzTFkoLLSqClAIFCqJ9yEtAlKdY2lLaQsvvnFtqiK3YeJs/t+ecmfnmzpxzggAEMZ0oXuPVYpKWL9swLpBvDFhnZOvHya+QtMAbyxs76E8ITxwSda36ICyOMUxOWWCfnoDDNQnH9CSNrTS2ecazYuvMbsjaAwLZ4yShi/4JiREt23a7LgFzH9uUGVbnT+7/DP0mnCYam2je8tvGSUkI5BHmWMnKhfNCYiWhUQdeLKnLUZ+cYY4sw4fNqcio3I0nrZehG6rF9ffREKp4yKo5iqtV+5GvvQiny05fagNfFu4+/Grpy3jJqlC/EMpAkFoRhTv1ichVn3IxiLLjIR40JnMlcc+4QHBo+stgHNV4yka6r0nCu+6ntO7GOeWW6cetGTNJ8ohRKluYD4QnCm67VnUQFR35yGvgYy6EBWNBjSMa1H8tBSsnC8rgHsgzzj79zS4YhuuRVrEdx8Ur8nwgidIwfbaah9PSMFx4vRMm+wiXfUFLOleWrJoYCGt43NswUo/C1kxkVu6ldwYH6DXpECdZhfPKrbhStQ/xktUKH8hp6Tpdy7AS2mEFbqiikayIhKpH5Gkq7SKz4wdpFC73NDfHxlMuB7frivW54MvDcVeTCMNPFUrac8EThZT7QBKka3UNAyX4ZjOg1/oBZZ33kKyMxPXqI+j80QJ/T2O/AinUxwtvd6Cq7ym+TnzCoL0dIsPN+SEM0G1pRr9Nh/bxBuR/SENSWQTtsjSMTQ7OlkaPbFUskso3cQG/WLTom/iILrPHLyBIl7mJ0xdLCznp0TxUDqE6hrLehluqeJxVbMb9JgH0YzVc0G6CeH04iFFIkOWKgCBesTmWaWVvAR61pkD9XcwF66Ek/rRl82Jj9l8hBs1gqV+IR83os7ZRz/Tz2HggJZ9zGETpA6F9rRUZsqhxHVyQ/9WQoxOFbZdwrCj4uQ+ETmgMX7YeEvpUzUApSQpWvkDltS+iROmipDMTusfv3UULvFjxiloqnTGBzg3rU+Di7A1UkUqKc2ju3fULqU6s8QpKbGsAAAAASUVORK5CYII=';
                }
                var noticeHtml = '<div class="atomNoticeHtml" style="\
                position: fixed;\
                width: 240px;\
                padding: 6px;\
                top: '+(e.pageY+14)+'px;\
                left: '+(e.pageX-15)+'px;\
                right: -1px;\
                background-color: #fff;\
                border: 1px solid #DFDFDF;\
                z-index: 1000;\
                -webkit-box-shadow: 0 2px 6px #ccc;\
                box-shadow: 0 2px 6px #ccc;\
                ">\
                <div style="width: 0;\
                    height: 0;\
                    border: 8px solid #fff;\
                    border-top: 8px solid transparent;\
                    border-right: 8px solid transparent;\
                    border-left: 8px solid transparent;\
                    position: absolute;\
                    top: -14px;\
                    left: 13px"></div>\<span>可点击</span>\
                <span style="\
                        display: inline-block;\
                        width: 26px;\
                        height: 16px;\
                        background-repeat: no-repeat;\
                        background-position: center 0px;\
                        background-image: url('+base64+');\
                        "></span>\
                <span>选中要发送的短信内容</span>\
            </div>';
                $("body").append(noticeHtml);
        })

        domArray.on("mouseout","div.atoms .attrData",function (e) {
            $('.atomNoticeHtml').remove();
        })

        //boss编码超长隐藏/展示
        domArray.on("click", ".left-content .zfbz-a", function () {
            var _this = $(this);
            if (_this.find("i").hasClass("km-shanglajiantou")) {
                _this.html('<i class="icon km-xialajiantou"></i>');
                var moren = _this.parent().parent().children();
                // var regnid = _this.parent().find(".active").find("a").attr('regnid');
                if (moren.length > 0) {
                    for (var i = 1; i < moren.length; i++) {
                        moren.eq(i).addClass("hide");
                    }

                }
                _this.parent().find("div").addClass("hide");
            } else {
                _this.html('<i class="icon km-shanglajiantou"></i>');
                var moren = _this.parent().parent().children();
                var regnid = _this.parent().find(".active").find("a").attr('regnid');
                if (regnid) {
                    regnid = _this.parent().find(".active").find("a").attr('regnid').replace(/,/g, "");
                    if (moren.length > 0) {
                        for (var i = 1; i < moren.length; i++) {
                            if (moren.eq(i).hasClass(regnid)) {
                                moren.eq(i).removeClass("hide");
                            }
                        }
                    }
                } else {
                    if (moren.length > 0) {
                        for (var i = 1; i < moren.length; i++) {
                            moren.eq(i).removeClass("hide");
                        }
                    }
                }
                _this.parent().find("div").removeClass("hide");
            }
            conMethod.objFunction();
        });
        // 原子中关联咨询表链接
        domArray.on("click", "div.atoms a[linkType = 'relateCns']", function () {
            var _this = $(this);
            var _root = window.location.protocol + "//" + window.location.host;
            var tmpltId = _this.attr("tmpltId");
            var cnslId = _this.attr("cnslId");
            var crossAPIArg = {};
            var openMode = window.localStorage.getItem("openMode");

            if (openMode == "1") {//open
                crossAPIArg = window.parent.crossAPIobj;
                kmUtil.openTab("咨询表记录查询列表", Constants.PREAJAXURL + Constants.ROOTURL + '/modules/knowledgeAppNew/kmConsultDataQuery.html?tmpltId=' + tmpltId + '&cnslId=' + cnslId, null, { crossAPIArg: crossAPIArg });
            } else {//菜单环境
                crossAPI.destroyTab("咨询表记录查询");
                crossAPI.createTab('咨询表记录查询', _root + Constants.PREAJAXURL + Constants.ROOTURL + '/modules/knowledgeAppNew/kmConsultDataQuery.html?tmpltId=' + tmpltId + '&cnslId=' + cnslId);
            }
            return false;
        });
        //富文本关联知识跳转
        domArray.on("click", "div.atoms a[linkType = 'relateKm']", function () {
            var _this = $(this);
            conMethod.goKnowledgeDetail(_this.text(), _this.attr("fileId"));
            return false;
        });

        //富文本关联原子跳转
        domArray.on("click", "div.atoms a[linkType = 'relateKmAtom']", function () {
            var _this = $(this);
            conMethod.goKnowledgeDetail(_this.text(), _this.attr("relateId"), _this.attr("fileid"));
            return false;
        });
        //富文本关联业务树跳转
        domArray.on("click", "div.atoms a[linkType = 'seriesRelateKm']", function () {
            var _this = $(this);
            conMethod.goBusinessTree(_this.attr("fileid"));
            return false;
        });
        //点击附件预览
        domArray.on("click", "div.atoms .fj-preview a", function () {
            var href = $(this).attr("id");
            var fileName =$(this).parent().siblings("a[linktype='download']").html();
            var subSufix = fileName.substring(fileName.lastIndexOf('.') + 1);
            if (href) {
                var hrefArr = href.split("?");
                if (hrefArr && hrefArr.length == 2) {
                    if ((!!window.ActiveXObject || "ActiveXObject" in window) && subSufix =="mht") {
                        window.open(url_prefix + '/modules/knowledge/' + href);
                    }else {
                        var params = hrefArr[1];
                        Util.ajax.getJsonAsync(Constants.AJAXURL + "/file/getFileSize?" + params, {}).then(function (data) {
                            if (data.returnCode == "0") {
                                window.open(url_prefix + '/modules/knowledge/' + href);
                            } else if (data.returnCode == "BIG_FILE") {
                                dialog.alert({
                                    type: 'error',
                                    message: '您预览的文件过大，请手动下载查看！',
                                    falseShow: false,
                                    trueName: '知道了'
                                });
                            }else if(data.returnCode == "MORE_SHEET_FILE"){
                                dialog.alert({
                                    type: 'error',
                                    message: '您预览的文件sheet页过多，请手动下载查看！',
                                    falseShow: false,
                                    trueName: '知道了'
                                });
                            } else {
                                dialog.alert({type: 'error', message: data.returnMessage});

                            }
                        }).then(function (data) {
                            return data;
                        }).fail(function (data) {
                            if (data && data.returnCode == 'BIG_FILE') {
                                //new myAlert({type: 'error', text: "您预览的文件过大，请手动下载查看！", falseShow: false, trueName: "知道了"});
                                dialog.alert({
                                    type: 'error',
                                    message: '您预览的文件过大，请手动下载查看！',
                                    falseShow: false,
                                    trueName: '知道了'
                                });
                            } else if(data.returnCode == "MORE_SHEET_FILE"){
                                dialog.alert({
                                    type: 'error',
                                    message: '您预览的文件sheet页过多，请手动下载查看！',
                                    falseShow: false,
                                    trueName: '知道了'
                                });
                            }else {
                                dialog.alert({type: 'error', message: data.returnMessage});

                            }
                        });
                    }

                }
            }
        });

        // 点击卡片预览
        domArray.on("click", 'div[paratypecd="22"] .yuanzi-con .kapan-preview', function() {
            var _this = $(this);
            var klg_nm = _this.parent().attr('cardName');
            var cardId = _this.parent().attr('cardId');
            var queryUrl= _this.parent().attr('queryUrl');
            var provCode = provId;

            var env = Constants.getEnvment();
            var _root = "";
            var httpType = window.location.protocol;
            if (env != Constants.NGKM_ENVIROMENT_PRODUCT) {
                if ('https:' == httpType) {
                    _root = "https://ngcard-test.cs.cmos:443/ngcardh5";
                } else {
                    _root = "http://ngcard-test.cs.cmos:8080/ngcardh5";
                }

            } else {
                if ('https:' == httpType) {
                    _root = "https://ngcard.cs.cmos:443/ngcardh5";
                } else {
                    _root = "http://ngcard.cs.cmos:31213/ngcardh5";
                }

            }
            // /v2/dist/vp/unifyCards/mainPage/main.html#/outerPreview?cardId=02720242222222222&sysCode=kng&provCode=270&opType=preview&opCode=1000&queryUrl=
            // window.open(_root +'/v2/dist/vp/unifyCards/mainPage/main.html#/outerPreview?cardId=02720242222222222&sysCode=kng&provCode=270&opType=preview&opCode=1000&queryUrl=')
            // crossAPI.createTab('卡片预览', _root +'/v2/dist/vp/unifyCards/mainPage/main.html#/outerPreview?cardId=02720242222222222&sysCode=kng&provCode=270&opType=preview&opCode=1000&queryUrl=');

            // var openMode = kmUtil.getUrlParamter("openMode");
            var openMode = window.localStorage.getItem("openMode");
            if (openMode && openMode == "1") {
                window.open(_root +'/v2/dist/vp/unifyCards/mainPage/main.html#/outerPreview?cardId='+cardId+'&sysCode=kng&provCode='+provCode+'&opType=preview&opCode=1000&queryUrl='+queryUrl)

            }else {
                crossAPI.createTab('卡片预览-'+klg_nm, _root +'/v2/dist/vp/unifyCards/mainPage/main.html#/outerPreview?cardId='+cardId+'&sysCode=kng&provCode='+provCode+'&opType=preview&opCode=1000&queryUrl='+queryUrl);
            }
            console.log('你点击了预览')
            return;
        })

        domArray.on("click", "div.atoms .exceptionAtom", function () {
            var _this = $(this);
            if (_this.parent().hasClass("active")) {
                return false;
            }
            var regnId = _this.attr("regnId");
            var regnIds = regnId.replace(/,/g, "");
            if(_this.parent().parent().parent().find(".zfbz-a").find(".km-xialajiantou").length >0){
                _this.parent().siblings().removeClass("active");
                _this.parent().addClass("active");
                if (_this.attr("isSendMes") === "1") {
                    _this.parents(".atc-prv-tips div.left-words").find("a.message").addClass("hide").removeClass("notSendMessage");
                    _this.parents("div.left-words").find("a." + regnIds).removeClass("hide");
                } else {
                    _this.parents(".atc-prv-tips div.left-words").find("a.message").addClass("hide");
                    _this.parents(".atc-prv-tips div.left-words").find("a." + regnIds).removeClass("hide").addClass("notSendMessage");
                }
                return false;
            }
            _this.parent().siblings().removeClass("active");
            _this.parent().addClass("active");
            var sel = _this.parents(".atc-prv-tips div.atoms");
            var atomId = sel.attr("atomId");
            sel.children('.' + atomId).addClass("hide");
            sel.children("." + regnIds).removeClass("hide");
            if (_this.attr("isSendMes") === "1") {
                _this.parents(".atc-prv-tips div.left-words").find("a.message").addClass("hide").removeClass("notSendMessage");
                _this.parents(".atc-prv-tips div.left-words").find("a." + regnIds).removeClass("hide");
            } else {
                _this.parents(".atc-prv-tips div.left-words").find("a.message").addClass("hide");
                _this.parents(".atc-prv-tips div.left-words").find("a." + regnIds).removeClass("hide").addClass("notSendMessage");
            }
            // _this.parents("div.left-words").find("a.message").each(function () {
            //     if (_this.hasClass("selected")) {
            //         _this.trigger("click");
            //     }
            // });

            var leftwords = $(".atc-prv-tips .left-words");
            leftwords.find("div.above-arrow").each(function () {
                $(this).remove();
            });
            leftwords.each(function () {
                var _this = $(this);
                if (this.offsetHeight != undefined && this.clientHeight != undefined) {
                    if (this.offsetHeight - this.clientHeight > 0) {
                        if (_this.find(".above-arrow").length == 0) {
                            _this.prepend(divAdd);
                            $(".above-arrow").hide();
                        }
                    }
                }
            });

            $(".atc-prv-tips .left-explain").each(function () {
                var _this = $(this);
                if (this.offsetHeight != undefined && this.clientHeight != undefined) {
                    if (this.offsetHeight - this.clientHeight > 0) {
                        if (_this.find(".above-arrow").length == 0) {
                            _this.prepend(divAdd);
                            $(".above-arrow").hide();
                        }
                    }
                }

            conMethod.objFunction();
            });
        });


        domArray.on("click", ".left-content-inner .arrow-left", function () {
            var a1 = $(this).parent().scrollLeft();
            if (a1 === 0) {
                return;
            } else {
                a1 -= 100;
                $(this).parent().scrollLeft(a1);
                if (a1 === 0) {
                    return;
                }
            }
        });

        domArray.on("click", ".left-content-inner .arrow-right", function () {
            var _this = $(this);
            var a2 = _this.parent().scrollLeft();
            _this.parent().scrollLeft(a2 + 100);
        });

        //点击附件下载
        domArray.on("click", "div.atoms a[linkType = 'download']", function () {
            var _this = $(this);
            closeFlag  = true;
            _this.attr("href", Constants.AJAXURL + "/file/download?key=NGKM_FILE_ATTACH&fileId=" + _this.attr("fileId") + "&fileName=" + encodeURIComponent(_this.text()));
        });
        domArray.on("click", ".spanHide", function () {
            var ht = $(this).attr("gqf");
            var par = $(this).parent().parent();
            par.addClass('hide');
            par.parent().find('.gqf_' + ht + '').removeClass('km-shanglajiantou').addClass('km-xialajiantou');
        });
        //boss代码超长隐藏按钮
        domArray.on("click", ".spanHides", function () {
            var par = $(this).parent();
            par.prev().addClass('hide');
            par.parent().find('.zfbz-a').find('i').removeClass('km-shanglajiantou').addClass('km-xialajiantou');
            par.addClass('hide');
        });
        domArray.on("click", ".zfbz-d", function () {
            var $this = $(this);
            var par = $this.parent();
            var regnid = $(par).prev().find('a').attr('regnid').replaceAll(',', '');
            var parDiv = par.parent().parent().parent().find('div.' + regnid + '');
            var findI = $this.find('i');
            if (findI.hasClass('km-xialajiantou')) {
                if (par.prev().hasClass('active')) {
                    var sl = parDiv.siblings();
                    sl.splice(0, 1);
                    sl.addClass('hide');
                    parDiv.removeClass('hide');
                }
                findI.removeClass('km-xialajiantou').addClass('km-shanglajiantou');
            } else {
                parDiv.addClass('hide');
                findI.removeClass('km-shanglajiantou').addClass('km-xialajiantou');
            }
        });
        //富文本关联原子点击预览
        domArray.on("click", "div.atoms .preview", function () {
            var _this = $(this);
            //预览窗口打开的原子ID
            var atomid = '-1';
            domArray.find(".atc-prv-tips").each(function () {
                var tips = $(this);
                tips.prev().removeClass('aft-preview');
                tips.remove();
                atomid = tips.find(".atoms").attr('atomid');
            });
            //当前点击的原子ID
            var klgAttrAtomId = _this.prev().attr('fileid');
            if (atomid != '-1' && klgAttrAtomId == atomid) {
                return;
            }
            //var klgAttrAtomId = _this.prev().attr('fileid');
            var knwlgId = _this.prev().attr('relateid');
            var verNo = _this.prev().attr('verno');
            getKlgAtomContent(knwlgId, verNo, klgAttrAtomId, _this);
            _this.addClass('aft-preview');
        });
        //例外切换
        domArray.on("click", ".atoms .exception", function (e) {
            var _this = $(e.currentTarget);
            var $li = _this.parent();
            if ($li.hasClass("active")) {
                return;
            }
            //如果点击同一个按钮，则锁止
            var theLeftwords = $li.closest(".left-words");
            var regnId = _this.attr("regnId");
            var regnIds = _this.attr("regnId").replace(/,/g, "");

            // var grpngId = _this.parents('div.left-content').attr('id').replace(/,/g,'');

            //点击渲染省份例外
            clickExceptionRenderDom(regnIds, _this);

            if (theLeftwords.find(".zfbz-a .km-xialajiantou").length) {
                $li.addClass("active").siblings().removeClass("active");

                var $messages = theLeftwords.find("a.message");
                var $regnIdDom = theLeftwords.find("a." + regnIds);

                $regnIdDom.removeClass("hide");
                $messages.addClass("hide");
                if (_this.attr("isSendMese") === "1") {
                    $messages.removeClass("notSendMessage");
                } else {
                    $regnIdDom.addClass("notSendMessage");
                }
                return;
            }
            //若当前点击例外，地市为单个则同步，反之不同步
            var regnIdArr = regnId.split(",");
            //如果点击的选项只包含一个ID
            if (regnIdArr.length == 1) {
                var inlineFun = function(inlineTabDom){
                    inlineTabDom.find('li.active').removeClass('active');//先取消掉所有tab页签的选中状态
                    //同步展示相同地区例外
                    inlineTabDom.each(function (i, ele) {
                        var thisE = $(ele);
                        theLeftwords = thisE.closest(".left-words");
                        var atoms = theLeftwords.closest(".atoms");//此项的atoms的DOM
                        var atomId = atoms.attr("atomId");//atoms  ID
                        atoms.find('.' + atomId).addClass("hide");
                        var message = theLeftwords.find("a.message");
                        message.addClass("hide");//先隐藏此项中所有message
                        var exceptionDom = thisE.find('.exception');//此列表中的所有列表项
                        var theChcExceptionDom = '',//此列表中应该被选中的列表项DOM
                            theChcRegnId = '';//此列表中应该被选中的列表项的regnId

                        exceptionDom.each(function (j, elm) {
                            var _this = $(elm);
                            var theRegnId = _this.attr("regnId");
                            if (theRegnId.match(regnIdReg(regnId))) {
                                theChcExceptionDom = _this;
                                theChcRegnId = theRegnId;
                            } else {
                                //如果是最后一项还没有匹配上，则选中默认的
                                if (!_this.parent().next().length) {
                                    theChcExceptionDom = $(ele).find('.exception:first');
                                    theChcRegnId = 'moren';
                                }
                            }
                            if (theChcExceptionDom && theChcRegnId) {
                                theChcExceptionDom.parent().addClass("active");
                                var regn = theChcRegnId.replace(/,/g, "");
                                if (theChcExceptionDom.parent().next().find("i").hasClass("km-xialajiantou")) {
                                    atoms.find("." + regn).addClass("hide");
                                } else {
                                    atoms.find("." + regn).removeClass("hide");

                                }

                                theLeftwords.find("a." + regn).removeClass("hide");
                                if (_this.attr("isSendMes") === "1") {
                                    message.removeClass("notSendMessage");
                                } else {
                                    theLeftwords.find("a." + regn).addClass("notSendMessage");
                                }
                                //此时此列表有被选中的项，则继续循环下一个列表
                                return false;
                            }
                            //theLeftwords.find("a.message[class*=selected]").trigger('click');
                        });
                    });
                };

                domArray.find('.inline-tab').asynSearch(inlineFun);
            } else {
                $li.addClass("active").siblings().removeClass("active");
                var atoms = $li.closest(".atoms");
                var atomId = atoms.attr("atomId");
                atoms.find('.' + atomId).addClass("hide");
                if ($li.next().find('a.zfbz-d').length > 0 && $li.next().find('a.zfbz-d').find('i').hasClass('km-xialajiantou')) {
                    atoms.find("." + regnIds).addClass("hide");
                } else {
                    atoms.find("." + regnIds).removeClass("hide");

                }
                theLeftwords.find("a.message").addClass("hide");
                theLeftwords.find("a." + regnIds).removeClass("hide");
                if (_this.attr("isSendMes") === "1") {
                    theLeftwords.find("a.message").removeClass("notSendMessage");
                } else {
                    theLeftwords.find("a." + regnIds).addClass("notSendMessage");
                }
                //theLeftwords.find("a.message[class*=selected]").trigger("click");

            }
            var leftwords = domArray.find(".left-words");
            leftwords.find("div.above-arrow").remove();
            leftwords.each(function () {
                var _this = $(this);
                if (this.offsetHeight != undefined && this.clientHeight != undefined) {
                    if (this.offsetHeight - this.clientHeight > 0) {
                        var $divAdd = $(divAdd);
                        _this.prepend($divAdd);
                        $divAdd.hide();
                    }
                }
            });
            domArray.find(".left-explain").each(function (i, ele) {
                var _this = $(this);
                if (this.offsetHeight != undefined && this.clientHeight != undefined) {
                    if (this.offsetHeight - this.clientHeight > 0) {
                        var $divAdd = $(divAdd);
                        _this.prepend(divAdd);
                        $divAdd.hide();
                    }
                }
            });
            conMethod.objFunction();
            if(lazyImg=="1"){
                var currentheight  =$(".detail-left").height();
                var currentScroll =$(".left-content-wrap").scrollTop();
                if(currentheight==currentScroll){
                    $(".left-content-wrap").scrollTop(currentScroll - 0.5);
                }else{
                    $(".left-content-wrap").scrollTop(currentScroll+1);

                }
            }
        });
        //展开/闭合分组原子按钮、闭合/显示注解
        leftConWrap.on("click", "a", function () {
            var _this = $(this);
            if (_this.hasClass("closed")) {
                closed(_this);
            } else if (_this.hasClass("zhj")) {
                zhj(_this);
            }
        });
        //事件代理，布局切换区按钮组
        layoutSwitch.on("click", "a", function (event) {
            // var targetElement = event.srcElement || event.currentTarget;
            var id = $(this).attr("id");
            switch (id) {
                case "closeRight":
                    closeRight(this);
                    break;
                case "hideNotSendMes":
                    hideNotSendMes(this);
                    break;
                case "hideCatelog":
                    hideCatelog(this);
                    break;
                default:
                    break;
            }
        });
        knowdDetail.find(".is-zhujie").on("mouseover", function () {
            var _this = $(this);
            if (_this.parent().parent().parent().prev().hasClass("left-title")) {
                if (_this.parent().parent().parent().prev().find(".zhj").hasClass("chked")) {
                    _this.parent().addClass("zhujie-tip-wrap");
                    _this.parent().append('<div class="zhujie-tip"><div>' + _this.parent().find(".zhujie-con").html() + '</div></div>');
                }
            } else if (_this.parent().parent().parent().parent().prev().hasClass("left-title")) {
                if (_this.parent().parent().parent().parent().prev().find(".zhj").hasClass("chked")) {
                    _this.parent().addClass("zhujie-tip-wrap");
                    _this.parent().append('<div class="zhujie-tip"><div>' + _this.parent().find(".zhujie-con").html() + '</div></div>');
                }
            }
        }).on("mouseout", function () {
            var _this = $(this);
            _this.parent().children(".zhujie-tip").remove();
            _this.parent().removeClass("zhujie-tip-wrap");
        });
        $detaiTitle.on("click", ".ywj-link", function () {
            if ($detaiTitle.find('.ywj-add-inner').length === 0) {
                kmUtil.openTabUseFullURLPath($(this).attr("title"), $(this).attr("url"));
            } else {
                $detaiTitle.find('.ywj-add-inner').attr("style", "display:block");
            }
        });
        domArray.on("click", ".ywj-add-inner li", function () {
            kmUtil.openTabUseFullURLPath($(this).attr("title"), $(this).attr("url"));
        });
        //复制知识名称
        domArray.on("click", "#knwlgNm-copy", function () {
            ContentSelect.copyKnwlgNm();
        });
        domArray.on("click", "#closeAlsNm", function () {
            var _this = $(this);
            var $alsName = $("#alsName");
            if (_this.find("i").hasClass("km-shanglajiantou")) {
                $alsName.html(alsNameSub + "<a id='closeAlsNm'class='closed' href='javascript:void(0)' style='position:absolute'><i class='icon icon km-xialajiantou'></i></a><br/>");
                getAlsAndKeyWordHig(1);
            } else {
                var alsNameSubT = alsNameAll.substring(alsNameSub.length);
                $alsName.html(alsNameSub + "<a id='closeAlsNm'class='closed' href='javascript:void(0)'style='position:absolute'><i class='icon icon km-shanglajiantou'></i></a><br/>"+alsNameSubT);
                $alsName.css("text-overflow","clip");
                $alsName.css("white-space","normal");
                getAlsAndKeyWordHig(0);
            }

        });
        domArray.on("click", "#keyWordClosed", function () {
            var _this = $(this);
            var $searchKeyName = $("#searchKeyName");
            if (_this.find("i").hasClass("km-shanglajiantou")) {
                $searchKeyName.html(searchKeyWordSub + "<a id='keyWordClosed'class='closed' href='javascript:void(0)'style='position:absolute'><i class='icon icon km-xialajiantou'></i></a><br/>");
                getAlsAndKeyWordHig(1);
            } else {
                var searchKeyWordSubT = searchKeyWordAll.substring(searchKeyWordSub.length);
                $searchKeyName.html(searchKeyWordSub + "<a id='keyWordClosed'class='closed' href='javascript:void(0)'style='position:absolute'><i class='icon icon km-shanglajiantou'></i></a><br/>"+searchKeyWordSubT);
                $searchKeyName.css("text-overflow","clip");
                $searchKeyName.css("white-space","normal");
                getAlsAndKeyWordHig(0);
            }
        });
        //轮播事件
        // $imgContent.on("click", "#img-close", function () {
        //     imgClose();
        //     return false;
        // }).on("click", "#img-left", function () {
        //     imgLeft();
        //     return false;
        // }).on("click", "#img-right", function () {
        //     imgRight();
        //     return false;
        // }).on("mousewheel", "#my-img", function () {
        //     var _this = $(this);
        //     var zoomOne = parseInt(this.style.zoom, 10) || 100;
        //     var iHeight = _this.height();
        //     var iWidth = _this.width();
        //     var zoomiWidth = iWidth * zoomOne / 100;
        //     zoomImg(this, $imgInner.width(), zoomiWidth, zoomOne);
        //     var zoom = parseInt(this.style.zoom, 10) || 100;
        //     var wHeight = $(window).height() - 100;
        //     var top = (wHeight - iHeight) / 2 + 50;
        //     if (navigator.userAgent.indexOf('MSIE') > 0 && document.documentMode !== 11) {//IE8,9，处理IE8,9下样式问题
        //         var openMode = kmUtil.getOpenMode() || "1";
        //         if (document.documentMode == 9 && openMode == "1" || navigator.userAgent.indexOf('Trident/7.0') > -1) {
        //             return false;
        //         }
        //         if (zoom > 160) {
        //             if (iWidth > iHeight) {
        //                 _this.css("margin-left", -(zoom + 220) + "px");
        //             } else {
        //                 _this.css("margin-left", -160 + "px");
        //             }
        //         }
        //     }
        //     return false;
        // });
        //原子图片轮播
        leftConWrap.on("click", "img[linktype = 'img']", function () {
            //获取图片所在原子顶级父标签对象
            // var $this = $(this)[0];
            // atomImgAll = [];
            // //遍历当前原子中所有图片，去除隐藏的图片
            // $(this).parents("div.atoms").find("img[linktype = 'img']").each(function () {
            //     var wordParent = $(this).parents("div.left-words");//该图片在原子默认或注解中
            //     var explainParent = $(this).parents("div.left-explain");//该图片在原子例外中
            //     if ((wordParent || explainParent)) {
            //         //该图片所在原子默认/注解或例外是隐藏状态
            //         if (!wordParent.hasClass("hide") && !explainParent.hasClass("hide")) {
            //             atomImgAll.push($(this)[0])
            //         }
            //     }
            // });
            // for (var i = 0; i < atomImgAll.length; i++) {
            //     //如果遍历得到的图片是当前点击的图片，将图片展示
            //     if (atomImgAll[i] == $this) {
            //         imgIndex = i;
            //         if (imgIndex == 0) {
            //             //第一张图片，不展示左侧切换按钮
            //             $imgLeft.css("display", "none")
            //         } else {
            //             $imgLeft.css("display", "block")
            //         }
            //         if (imgIndex == atomImgAll.length - 1) {
            //             //最后一张图片，不展示右侧切换按钮
            //             $imgRight.css("display", "none")
            //         } else {
            //             $imgRight.css("display", "block")
            //         }
            //         myImgLoad(imgIndex);
            //         return;
            //     }
            // }
            if (IEVersion() == 8) {
                $('.viewer-container').find('.viewer-footer').find('.viewer-rotate-left').hide();
                $('.viewer-container').find('.viewer-footer').find('.viewer-rotate-right').hide();
            }
            $('.viewer-container').css("top", "40px");
        });
        leftConWrap.on("click", "img[linktypes = 'imgDm']", function () {
            //获取图片所在原子顶级父标签对象
            // var $this = $(this)[0];
            // atomImgAll = [];
            // //遍历当前原子中所有图片，去除隐藏的图片
            // $(this).parents("div.atoms").find("img[linktypes = 'imgDm']").each(function () {
            //     var wordParent = $(this).parents("div.left-words");//该图片在原子默认或注解中
            //     var explainParent = $(this).parents("div.left-explain");//该图片在原子例外中
            //     if ((wordParent || explainParent)) {
            //         //该图片所在原子默认/注解或例外是隐藏状态
            //         if (!wordParent.hasClass("hide") && !explainParent.hasClass("hide")) {
            //             atomImgAll.push($(this)[0])
            //         }
            //     }
            // });
            // for (var i = 0; i < atomImgAll.length; i++) {
            //     //如果遍历得到的图片是当前点击的图片，将图片展示
            //     if (atomImgAll[i] == $this) {
            //         imgIndex = i;
            //         if (imgIndex == 0) {
            //             //第一张图片，不展示左侧切换按钮
            //             $imgLeft.css("display", "none")
            //         } else {
            //             $imgLeft.css("display", "block")
            //         }
            //         if (imgIndex == atomImgAll.length - 1) {
            //             //最后一张图片，不展示右侧切换按钮
            //             $imgRight.css("display", "none")
            //         } else {
            //             $imgRight.css("display", "block")
            //         }
            //         myImgLoad(imgIndex);
            //         return;
            //     }
            // }
            if (IEVersion() == 8) {
                $('.viewer-container').find('.viewer-footer').find('.viewer-rotate-left').hide();
                $('.viewer-container').find('.viewer-footer').find('.viewer-rotate-right').hide();
            }
            $('.viewer-container').css("top", "40px");
        });
        $detailRight.on("mouseenter", "ul.right-words .pst-abt-title", function () {
            $detailRight.find("div.pst-abt").show();
        }).on("mouseout", "ul.right-words .pst-abt-title", function () {
            $detailRight.find("div.pst-abt").hide();
        });
    };
    //faq知识展示
    var thumbLinkFaqOpen = function (showNum, $this) {
        $this.find("a[sid=thumbnailLinkFQA]").each(function () {
            var _this = $(this);
            if (showNum) {
                if (_this.parent().find(".tab-inline")) {
                    var _thisP = _this.parent();
                    var _thisEq = _thisP.find(".exceptionAfq").eq(0);
                    _thisP.find(".location").hide();
                    _thisP.find(".tab-inline").show();
                    if (_thisEq.hasClass("active") == false) {
                        _thisEq.parent().addClass("active");
                        var regnIds = _thisEq.attr("regnIdAfqs");
                        if (regnIds && _thisP.find("div[regnIdAfqs=" + regnIds + "]")) {
                            _thisP.find("div[regnIdAfqs=" + regnIds + "]").removeClass("hide");
                        }
                    }
                }
            } else {
                if (_this.parent().find(".tab-inline")) {
                    var _thisP = _this.parent();
                    _thisP.find(".location").show();
                    _thisP.find(".tab-inline").hide();
                }
            }
        })
    };
    //详情页根据归属地切换例外
    var refrushExp = function (exceptScope) {
        $(".exception").each(function () {
            var _this = $(this);
            doEcept(_this,exceptScope,"0");
        });

        $(".exception").parent().parent().each(function () {
            var _this  = $(this);
            var isTrue = true;
            var _isMore = _this.find('.active').find('a').attr('regnid');
            var regnIds = _isMore.split(",");
            for(var i = 0;i<regnIds.length;i++) {
                if (regnIds[i] == exceptScope) {
                    isTrue = false;
                    break;
                }
            }
            if (isTrue && _isMore !== 'moren'){
                var _moren = _this.find('a[regnid=moren]');
                _moren.parent("li").addClass("active").siblings().removeClass("active");
                var sel = _moren.parents("div.atoms");
                var atomId = sel.attr("atomId");
                var regn = _isMore.replace(/,/g, "");
                sel.children('.' + atomId).addClass("hide");
                sel.children("." + regn).removeClass("hide");
                var message = _moren.parents("div.left-words").find("a.message");
                if (_moren.attr("isSendMes") === "1") {
                    message.addClass("hide").removeClass("notSendMessage");
                    _moren.parents("div.left-words").find("a." + regn).removeClass("hide");
                } else {
                    message.addClass("hide");
                    _moren.parents("div.left-words").find("a." + regn).removeClass("hide").addClass("notSendMessage");
                }
                var arrow = $(".left-words").find("div.above-arrow");
                if (arrow.length > 0) {
                    arrow.remove();
                }
                var explain = $(".left-explain").find("div.above-arrow");
                if (explain.length > 0) {
                    explain.remove();
                }

            }
        });
    };
    var doRefalshPageByCall = function () {
        var openMode = kmUtil.getOpenMode() || "1";
        var bodyObj = $("body");
        if ("2" == openMode && CrossAPI.url != undefined) {
            var ngkmCall = localStorage.getItem("ngkm_call") || "0_0";
            var callinfoarr = ngkmCall.split("_");
            bodyObj.attr("phoneCity", callinfoarr[0]);
            bodyObj.attr("phoneNum", callinfoarr[1]);
            bodyObj.attr("phoneFlag", "0");
            bodyObj.attr("phoneChange", "0");
            if(window.addEventListener){//IE8+
                window.addEventListener("storage",function (e) {
                    if(e.key == "ngkm_call"){
                        CrossAPI.getContact("getClientBusiInfo", Constants.PARAMJSONBUSINFO, function (clientBusiInfo) {
                            lastNumAssCode = clientBusiInfo.bean.numAssignmentCode + "";
                            bodyObj.attr("phoneNum", clientBusiInfo.bean.msisdn);
                            bodyObj.attr("phoneChange", "1");
                            if (bodyObj.attr("phoneCity") != lastNumAssCode) {
                                bodyObj.attr("phoneFlag", "1");
                            }
                        });
                    }
                });
            }else{//IE8
                var currCallNum = localStorage.getItem("ngkm_call") || "0_0";
                $(document).on("storage",function () {
                    var targetCallNum = localStorage.getItem("ngkm_call") || "0_0";
                    if(currCallNum != targetCallNum){
                        CrossAPI.getContact("getClientBusiInfo", Constants.PARAMJSONBUSINFO, function (clientBusiInfo) {
                            lastNumAssCode = clientBusiInfo.bean.numAssignmentCode + "";
                            bodyObj.attr("phoneNum", clientBusiInfo.bean.msisdn);
                            bodyObj.attr("phoneChange", "1");
                            if (bodyObj.attr("phoneCity") != lastNumAssCode) {
                                bodyObj.attr("phoneFlag", "1");
                            }
                        });
                        currCallNum = targetCallNum;
                    }
                });
            }
            CrossAPI.on('tabSwitch', function (data) {
                $("#feedback-select").hide();
                CrossAPI.getContact("cross_data",Constants.PARAMJSONINDEX,function (info) {
                    var title = info.iframe.title;
                    if (data.title == title) {
                        kmUtil.setFocusFalg(true);
                        if (bodyObj.attr("phoneChange") == "1") {
                            bodyObj.attr("phoneChange", "0");
                            $("#telephone").val(bodyObj.attr("phoneNum"));
                            msgSd.getPhoneArea(false);
                            klgFdbkSend.getAcceptPhoneNum(function (msisdn) {
                                $("#acceptTelNum").val(msisdn);
                            });
                            clickProcess.getData();
                        }
                        if (bodyObj.attr("phoneFlag") == "1") {
                            bodyObj.attr("phoneFlag","0")
                            bodyObj.attr("phoneCity", lastNumAssCode);
                            refrushExp(bodyObj.attr("phoneCity"));
                        }
                        leftConWrap.scrollTop(kmUtil.getScrollHt());
                    }else {
                        kmUtil.setFocusFalg(false);
                    }
                });
                //ContentSelect.clearSelect();
            });
        } else {
            var ngkmCall = localStorage.getItem("ngkm_call") || "0_0";
            var callinfoarr = ngkmCall.split("_");
            bodyObj.attr("phoneCity", callinfoarr[0]);
            bodyObj.attr("phoneNum", callinfoarr[1]);
            bodyObj.attr("phoneFlag", "0");
            bodyObj.attr("phoneChange", "0");
            if (window.addEventListener) {//IE8+
                window.addEventListener("storage", function (e) {
                    if (e.key == "ngkm_call") {
                        // getClientInfo();
                        var newVal = e.newValue || "0_0";
                        var newValInfoArr = newVal.split("_");
                        bodyObj.attr("phoneNum", newValInfoArr[1]);
                        bodyObj.attr("phoneChange", "1");
                        lastNumAssCode = newValInfoArr[0];
                        if (bodyObj.attr("phoneCity") != newValInfoArr[0]) {
                            bodyObj.attr("phoneFlag", "1");
                        }
                        if (kmUtil.getFocusFalg()){
                            clickProcess.initialize(knwlgId, true, false);
                        }
                    }
                });
            } else {//IE8
                var currCallNum = localStorage.getItem("ngkm_call") || "0_0";
                $(document).on("storage", function () {
                    var targetCallNum = localStorage.getItem("ngkm_call") || "0_0";
                    if (currCallNum != targetCallNum) {
                        var newValInfoArr = targetCallNum.split("_");
                        bodyObj.attr("phoneNum", newValInfoArr[1]);
                        bodyObj.attr("phoneChange", "1");
                        lastNumAssCode = newValInfoArr[0];
                        if (bodyObj.attr("phoneCity") != newValInfoArr[0]) {
                            bodyObj.attr("phoneFlag", "1");
                        }
                        currCallNum = targetCallNum;
                    }
                });
            }
            window.onfocus = function () {
                kmUtil.setFocusFalg(true);
                if (bodyObj.attr("phoneChange") == "1") {
                    bodyObj.attr("phoneChange", "0");
                    if (window.addEventListener) {
                         clickProcess.initialize(knwlgId, true, false);
                    }
                    $("#telephone").val(bodyObj.attr("phoneNum"));
                    //msgSd.getPhoneArea(false);
                    msgSd.getAcceptNumber();
                    klgFdbkSend.getAcceptPhoneNum(function (msisdn) {
                        $("#acceptTelNum").val(msisdn);
                    });
                }

                if (bodyObj.attr("phoneFlag") == "1") {
                    bodyObj.attr("phoneFlag", "0");
                    bodyObj.attr("phoneCity", lastNumAssCode);
                    refrushExp(bodyObj.attr("phoneCity"));
                }
            };
            window.onblur = function(){
                kmUtil.setFocusFalg(false);
            }
        }
    };
    //缩略图全开全缩
    $("#thumbnailAll").on('click', function () {
        var _this = $(this);
        var showNum = _this.attr("show");
        var thumbnailAll = function ($this) {
            var $thumbnailDivFQA = $this.find("div.thumbnailDivFQA");
            if (showNum == 0) {
                $this.find("div.thumbnailDiv").show();
                $thumbnailDivFQA.show();
                $thumbnailDivFQA.find('.has-inner-tag').show();
                $this.find("img.thumbnailPlus").attr("src", url_prefix + "/assets/img/thumbnailMinus.png");
                $this.find('a[sid="thumbnailLinkFQA"]').addClass('open');
                thumbLinkFaqOpen(true, $this);
                //展开或者闭合全部自定义标签内容
                var thumbnailLinkTabFQA = $this.find("a[sid=thumbnailLinkTabFQA]");
                thumbnailLinkTabFQA.addClass("open");
                $this.find("#biaoqiang").find(".yuanzi-title-inner").show();
                thumbnailLinkTabFQA.parent().find(".location").hide();
                thumbnailLinkTabFQA.parent().find(".tab-inline").show();
                //展开或者闭合全部自定义标签内容
                var thumbnailLinkFQAMORE = $this.find("a[sid=thumbnailLinkFQAMORE]");
                thumbnailLinkFQAMORE.parent().find(".moreQuestion").show();
                thumbnailLinkFQAMORE.addClass("open");

                var thumbnailLinkFQAMORENew = $this.find("a[sid=thumbnailLinkFQAMORENew]");
                thumbnailLinkFQAMORENew.parent().find(".yuanzi-title-include").show();
                thumbnailLinkFQAMORENew.addClass("open");
                _this.attr("show", 1);
                _this.text("闭合缩略");
                //boss编码
                var zfbzA = $this.find('.zfbz-a');
                zfbzA.find('i').addClass('km-shanglajiantou').removeClass('km-xialajiantou');
                zfbzA.parent().find('.yuanzi-title-include').removeClass('hide');
                zfbzA.parent().find('.yuanzi-con').removeClass('hide');
                zfbzA.parent().find('.box-collapsible').removeClass('hide');
                var zfbzD = $this.find('.zfbz-d');
                zfbzD.find('i').addClass('km-shanglajiantou').removeClass('km-xialajiantou');
                if (zfbzD.length > 0) {
                    for (var i = 0; i < zfbzD.length; i++) {
                        var regn = $(zfbzD.parent()[i]).prev().find('a').attr('regnid').replaceAll(',', '');
                        if ($(zfbzD.parent()[i]).prev().hasClass('active')) {
                            var sl = $(zfbzD.parent()[i]).parent().parent().parent().find('div.' + regn + '').siblings();
                            sl.splice(0, 1);
                            sl.addClass('hide');
                            $(zfbzD.parent()[i]).parent().parent().parent().find('div.' + regn + '').removeClass('hide');
                        }
                    }
                }

            } else {
                $this.find("div.thumbnailDiv").hide();
                $thumbnailDivFQA.find('.has-inner-tag').hide();
                $thumbnailDivFQA.hide();
                $this.find("img.thumbnailPlus").attr("src", url_prefix + "/assets/img/thumbnailPlus.png");
                $this.find('a[sid="thumbnailLinkFQA"]').removeClass('open');
                thumbLinkFaqOpen(false, $this);
                //展开或者闭合全部自定义标签内容
                var thumbnailLinkTabFQA = $this.find("a[sid=thumbnailLinkTabFQA]");
                thumbnailLinkTabFQA.removeClass("open");
                $this.find("#biaoqiang").find(".yuanzi-title-inner").hide();
                thumbnailLinkTabFQA.parent().find(".location").show();
                thumbnailLinkTabFQA.parent().find(".tab-inline").hide();
                var thumbnailLinkFQAMORE = $this.find("a[sid=thumbnailLinkFQAMORE]");
                thumbnailLinkFQAMORE.parent().find(".moreQuestion").hide();
                thumbnailLinkFQAMORE.removeClass("open");
                var thumbnailLinkFQAMORENew = $this.find("a[sid=thumbnailLinkFQAMORENew]");
                thumbnailLinkFQAMORENew.parent().find(".yuanzi-title-include").hide();
                thumbnailLinkFQAMORENew.removeClass("open");
                _this.attr("show", 0);
                _this.text("展开缩略");
                //boss编码
                var zfbzA = $this.find('.zfbz-a');
                zfbzA.find('i').addClass('km-xialajiantou').removeClass('km-shanglajiantou');
                zfbzA.parent().find('.yuanzi-title-include').addClass('hide');
                zfbzA.parent().find('.yuanzi-con').addClass('hide');
                zfbzA.parent().find('.box-collapsible').addClass('hide');
                var zfbzD = $this.find('.zfbz-d');
                zfbzD.find('i').addClass('km-xialajiantou').removeClass('km-shanglajiantou');
                if (zfbzD.length > 0) {
                    for (var i = 0; i < zfbzD.length; i++) {
                        var regn = $(zfbzD.parent()[i]).prev().find('a').attr('regnid').replaceAll(',', '');
                        $(zfbzD.parent()[i]).parent().parent().parent().find('div.' + regn + '').addClass('hide');
                    }
                }
            }
        }
        domArray.asynSearch(thumbnailAll);
    });
    var findSpanHig = function (searchKeyWord) {
        //搜索无结果给予提示
        var searchClear = $("#searchClear");
        var topSearch = $("#topSearchInput");
        var searchResult = "有";
        if ($("body").find("span.sr-high").length == 0) {
            searchNo = "1";
            searchResult = "无";
            searchClear.prev().focus().val("");
            topSearch.val("未搜索到相关内容").css("color", "#cc0000");
            searchClear.parent().removeClass("search-typein");
            topSearch.blur();
            //bossClick();
        } else {
            //bossHide();    var inputKeyWord = "";
            topSearch.val(inputKeyWord ).css("color", "#AAA");
            searchClear.parent().addClass("search-typein");
        }
        var click_searchKeyWordBtn_time = new Date().Format("yyyy-MM-dd HH:mm:ss");
        Util.ajax.getJson(Constants.AJAXURL + "/sensorsdata/getSensorsdata?t=" + +new Date().getTime(), {}, function (data) {
            if (data.returnCode == 0 && data.object == "true") {
                if (sensorsdata) {
                    sensorsdata.track("ngkm_knwlgDetail_keyWordSearch_click", {
                        click_searchKeyWordBtn_time: click_searchKeyWordBtn_time,
                        knwlg_id: knwlgId,
                        knwlg_name: knwlgName,
                        klgDetailKeyWord: searchKeyWord,
                        search_result: searchResult
                    });
                }
            }
        });
    }
    // 判断IE浏览器版本
    function IEVersion() {
        var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串
        var isIE = userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1; //判断是否IE<11浏览器
        var isEdge = userAgent.indexOf("Edge") > -1 && !isIE; //判断是否IE的Edge浏览器
        var isIE11 = userAgent.indexOf('Trident') > -1 && userAgent.indexOf("rv:11.0") > -1;
        if (userAgent.indexOf("Windows NT 5") != -1) {
            // console.log("这是XP系统");
        } else if (userAgent.indexOf("Windows NT 7") != -1||userAgent.indexOf("Windows NT 6.1") !=-1) {
            platform = 7;
        } else if (userAgent.indexOf("Windows NT 10") != -1) {
            platform = 10;
        }
        if(isIE) {
            var reIE = new RegExp("MSIE (\\d+\\.\\d+);");
            reIE.test(userAgent);
            var fIEVersion = parseFloat(RegExp["$1"]);
            if(fIEVersion == 7) {
                return 7;
            } else if(fIEVersion == 8) {
                return 8;
            } else if(fIEVersion == 9) {
                return 9;
            } else if(fIEVersion == 10) {
                return 10;
            } else {
                return 6;//IE版本<=7
            }
        } else if(isEdge) {
            return -2;//edge
        } else if(isIE11) {
            return 11; //IE11
        }else{
            return -1;//不是ie浏览器
        }
    }
    // 查询搜索高亮数量并上一个下一个
    var searchNumFn = function (isNext, keyWord, clearFlag) {
        // #ff9632 高亮颜色
        if (clearFlag) {
            if ($("body").find("span.sr-high.is-in-vision")[searchIndex]) {
                $("body").find("span.sr-high.is-in-vision")[searchIndex].style.backgroundColor = '#FFFF00';
            }
            searchIndex = 0;
            UnrealWords = '';
            return;
        }

        var allCount = $("body").find("span.sr-high").length;
        for (var index = 0; index < allCount; index++) {
            var element = $("body").find("span.sr-high").eq(index).offset().top;
            if (element != 0) {
                $("body").find("span.sr-high").eq(index).addClass('is-in-vision');
            }
        }
        var allCount = $("body").find("span.sr-high.is-in-vision").length;
        // $(this).offset().top == 0

        if (keyWord != UnrealWords) {
            UnrealWords = keyWord;
            searchIndex = 0;
        } else {
            if (isNext) {
                if (searchIndex === allCount - 1 || searchIndex > allCount - 1) {
                    searchIndex = 0;
                } else {
                    searchIndex++;
                }
            } else {
                if (searchIndex === 0) {
                    searchIndex = allCount - 1;
                } else {
                    searchIndex--;
                }
            }
        }
        // $("body").find("span.sr-high")[searchIndex].style.border = '2px solid #ff9632';
        $("body").find("span.sr-high.is-in-vision")[searchIndex].style.backgroundColor = '#ff9632';
        $("body").find("span.sr-high.is-in-vision")[searchIndex].setAttribute('id', 'height-light-span');
        if (IEVersionflag < 0 || IEVersionflag == 9 || IEVersionflag == 8 || (platform == 7 && IEVersionflag == 11)) {
            $("body").find("span.sr-high.is-in-vision")[searchIndex].scrollIntoView(true);
        } else if (platform == 10 && IEVersionflag == 11) {
            // console.log(searchIndex,$("body").find("span.sr-high.is-in-vision").eq(searchIndex).offset().top)
            // $("body").find("span.sr-high.is-in-vision").eq(searchIndex).scrollTop(0);
            // 兼容ie
            var a = document.createElement('a');
            // a.href = '#height-light-span';
            // a.id = 'clickAnchor';
            // a.setAttribute('id','clickAnchor');
            a.setAttribute('href', '#height-light-span');

            a.click();
            // $(a)[0].click();
            // $(a).trigger('click');
            // $('a#clickAnchor').trigger('click');
            // a.remove();
            $(a).remove();
            $searchClick.find("input").focus();
        }
        // $("body").find("span.sr-high")[searchIndex].scrollIntoView(true);
        $('.detail-top .UpAndDownBox #upAndDownKey').text(keyWord);
        $('.detail-top .UpAndDownBox #upAndDownKeyCount').text((searchIndex + 1) + '/' + allCount);

        // console.log('allCount-----', allCount, searchIndex);
    }
    // 添加上一个下一个框 鼠标悬浮background-color: #e5f2fa;
    var pushUpAndDownHtml = function () {
        var parentNode = $('.detail-top .wrap-inner');
        var htmlStr = '<li class="UpAndDownBox hide" style="width: 200px;height: 36px;line-height: 36px;background: #fff;float: right;position: relative;top: 44px;right: -200px;-webkit-box-shadow: 0px 0px 5px #404040;box-shadow: 0px 0px 5px #404040;border-radius: 4px;-webkit-border-radius: 4px;-moz-border-radius: 4px;border-collapse: collapse;">\
        <span id="upAndDownKey" style="\
        float: left;\
        padding-left: 4px;\
        width: 70px;\
        color: #333333;\
        font-size: 12px;\
        white-space: nowrap;\
        overflow: hidden;\
        text-overflow: ellipsis;\
        ">大知识</span>\
        <a class="" href="javascript:void(0);" id="upAndDownClose" title="" style="float: right;">\
            <i class="icon km-guanbi i-curr-bg" onmouseup="this.style.backgroundColor = \'#e5f2fa\'" onmousedown="this.style.backgroundColor=\'#ccc7f6\'" onmouseout="this.style.backgroundColor=\'#fff\'" onmouseover="this.style.backgroundColor = \'#e5f2fa\'" style="\
                padding: 6px 3px;\
                color: #9e9e9e;\
                font-size: 12px;\
                "></i>\
        </a>\
        <a class="" href="javascript:void(0);" id="previousKey" title="" style="float: right;">\
            <i class="icon xiangxia" onmouseup="this.style.backgroundColor = \'#e5f2fa\'" onmousedown="this.style.backgroundColor=\'#ccc7f6\'" onmouseout="this.style.backgroundColor=\'#fff\'" onmouseover="this.style.backgroundColor = \'#e5f2fa\'" style="\
            height: 11px;\
            vertical-align: middle;\
            padding: 5px 9px;\
            "></i>\
        </a>\
        <a class="" href="javascript:void(0);" id="nextKey" title="" style="float: right;">\
            <i class="icon xiangshang" onmouseup="this.style.backgroundColor = \'#e5f2fa\'" onmousedown="this.style.backgroundColor=\'#ccc7f6\'" onmouseout="this.style.backgroundColor=\'#fff\'" onmouseover="this.style.backgroundColor = \'#e5f2fa\'" style="\
            height: 11px;\
            vertical-align: middle;\
            padding: 5px 9px;\
            "></i>\
        </a>\
        <span style="float: right;height: 20px;vertical-align: middle;margin-right: 8px;border-right: 1px #9e9e9e solid;margin-top: 8px;"></span>\
        <span id="upAndDownKeyCount" style="float: right;color: #9e9e9e;margin-right: 8px;font-size: 12px;text-align: right;width: 38px;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;"></span>\
    </li>';
        parentNode.append(htmlStr);
        bindEvent();
    }
    var bindEvent = function () {
        // var value = $searchClick.find("input").val();
        var _this = $searchClick.find("input");
        $('.detail-top').on('click', 'a#nextKey', function () {
            searchEvent(_this, false);
        })
        $('.detail-top').on('click', 'a#previousKey', function () {
            searchEvent(_this, true);
        })
        $('.detail-top').on('click', 'a#upAndDownClose', function () {
            $(this).parent().addClass('hide');
            searchNumFn('', '', true);
        })
    }
    var searchKeyWord = function (value, flag) {

        // console.time();
        var search = function ($this) {
            return knowledgeSearch.highlight($this, value);
        };
        domArray.asynSearch(search);
        $detailRight.asynSearch(search);
        findSpanHig(value);
        var showFlag = $("#thumbnailAll").attr("show");
        if (showFlag == "0") {
            $("#thumbnailAll").trigger("click");
        }
        searchNumFn(flag, value);
        //knowledgeSearch.highlight($("body"), value, findSpanHig);
        // console.timeEnd();
    }

        var searchEvent = function ($this, flag) {
            var _this = $this;
            $("body").find("span.sr-high").each(function () {
                $(this).replaceWith($(this).html());
            });
            light = "0";
            inputKeyWord = _this.val().trim();
            searchKeyWord(inputKeyWord, flag);
            $('.detail-top').find('li.UpAndDownBox').removeClass('hide');
            //重新绑定点击事件
            addPreview($(".detail-left").find(".detail-title:first,.left-catelog-wrap:first,.left-content-wrap"))

        }
    //搜索事件初始化
    var searchInit = function () {
        //var searchClick = $("#searchClick");
        $searchClick.find("input").keydown(function (event) {
            var _this = $(this);
            if (event.keyCode === 13) {
                if (_this.val().trim() !== "" && _this.val().trim() !== "搜索关键字") {
                    var keyWord = _this.val().trim();
                    var keysplitSize = $("#keysplitSize");
                    //重新设置搜索分词个数
                    keysplitSize.val(keyWord.length);
                    searchEvent(_this, true);
                }
            } else {
                _this.parent().addClass("search-typein");
            }
        });
        //搜素输入框相关事件 焦点、按键、输入变化等
        $topSearchInput.focus(function () {
            var _this = $(this);
            if (_this.val().trim() === "" || _this.val().trim() === "搜索关键字" || _this.val().trim() === "未搜索到相关内容" && searchNo == "0") {
                _this.css("color", "#AAA");
                _this.val("");
            }
            searchNo = "0";
        }).blur(function () {
            var _this = $(this);
            if (_this.val().trim() === "") {
                _this.val("搜索关键字").css("color", "#AAA");
                _this.parent().removeClass("search-typein");
            }
        }).on('input propertychange', function () {
            var _this = $(this);
            if (_this.val() === null || _this.val() === undefined || _this.val() === "") {
                _this.parent().removeClass("search-typein");
                $searchClick.find("#searchClear").hide();
                if (IEVersionflag != 8) {
                    $('.detail-top').find('li.UpAndDownBox').addClass('hide');
                    searchNumFn('', '', true);
                }
            } else {
                _this.parent().addClass("search-typein");
                $searchClick.find("#searchClear").show();
            }
        })
        //搜素清除事件
        $searchClick.find("#searchClear").click(function () {
            var _this = $(this);
            $("a#upAndDownClose").trigger('click');
            for (var t = 0; t < $("#keysplitSize").val(); t++) {
                $("body").find("span.sr-high").each(function () {
                    var thisObj = $(this);
                    thisObj.replaceWith(thisObj.html());
                })
            }
            _this.parent().removeClass("search-typein");
            _this.prev().focus().val("");
        });
        $searchClick.find("#searchGo").click(function () {
            light = "0";
            var topSearchInput = $searchClick.find("#topSearchInput");
            if (topSearchInput.val().trim() !== "" && topSearchInput.val().trim() !== "搜索关键字") {
                var keyWord = topSearchInput.val().trim();
                var keysplitSize = $("#keysplitSize");
                //重新设置搜索分词个数
                keysplitSize.val(keyWord.length);
                searchEvent(topSearchInput, true);

            }
        });
    };
    var keyWordHighLight = function () {
        if (keyWord && keyWord != "null") {
            var skeys = keyWord.trim();
            var searchKeyArray = skeys.split(" ");
            //根据分词个数进行清理（如果不清理多次可能嵌套的span不会清除
            var keysplitSize = $("#keysplitSize");
            //重新设置搜索分词个数
            keysplitSize.val(searchKeyArray.length);
            if (light === "0") {
                $searchClick.addClass("search-click").addClass("search-typein");
                $topSearchInput.val(keyWord);

                //searchKeyWord(keyWord, false);
                var search = function ($this) {
                    knowledgeSearch.highlight($this, keyWord);
                };
                // console.time();
                domArray.asynSearch(search);
                // var runOnceFn = setTimeout(function () {
                //     searchNumFn(true, keyWord);
                //     window.clearTimeout(runOnceFn);
                // }, 100);
                // console.timeEnd();
                // domArray.asynSearch(addPreview);
                //refreshKlgState(leftConWrap);
            }

        } else {
            $topSearchInput.val("搜索关键字");
        }
    }

    // 视频放大播放   加载视频遮罩
    var myVideoLoad = function (video_fileId, link) {
        var wHeight = $(window).height() - 100;
        var wWidth = $(window).width() - 100;
        var $videoContent = $("#video-content");
        var $videoInner = $("#video-inner");


        $videoInner.empty();//删除
        $videoContent.show();
        $videoInner.append("");//视频组件
        var innerHeight = $videoInner.height();
        var innerwidth = $videoInner.width();


        var $this = $('#video-inner');
        var width = '400px';
        var height = '480px';
        var fileId = video_fileId;
        var autostart = false;
        // var link = window.location.protocol + "//" + window.location.host + Constants.AJAXURL + "/file/downloadWskmMedia/" + _key + "/" + fileId;
        /*var userAgent = navigator.userAgent;
        var isIE = (userAgent.indexOf("compatible") > -1 && userAgent.indexOf("MSIE") > -1);
        var fIEVersion;*/
        if (IEVersion() != "-1") {
            var object = '<object style="position: absolute;left: 34%;top: 16%;" id="flv__id__' + fileId + '" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="' + width + '" height="' + height + '">\n' +
                '<param name="wmode" value="transparent">' +
                '<param name="movie" value="/ngkm/src/assets/plugin/flvplayer.swf">\n' +
                '<param name="flashvars" value="file=' + link + '.mp4&autostart=' + autostart + '&image=&provider=video">\n' +
                '<param name="quality" value="high">\n' +
                '<param name="allowfullscreen" value="true">' +
                '<embed wmode="transparent" type="application/x-shockwave-flash" src="/ngkm/src/assets/plugin/flvplayer.swf" width="' + width + '" height="' + height + '" flashvars="file=' + link + '.mp4&autostart=' + autostart + '&provider=video" quality="high" allowfullscreen="true" pluginspage="http://www.macromedia.com/go/getflashplayer"></embed>' +
                '</object>';
            $this.append(object);
        } else {
            var $e2 = $('<div class="video' + fileId.split(".")[0] + '"  style="position: absolute;left: 30%;top: 20%;"></div>')
            $this.append($e2);
            var config = {
                el: '.video' + fileId.split(".")[0],
                className: 'video',
                solution: 'html,flash',
                swfPath: '/ngkm/src/assets/lib/jqueryPlugin/jPlayer/dist/jplayer',
                autoPaly: 1, //是否自动播放，0手动播放|默认1自动播放
                volume: 1, //音量设置，取值范围0-1，默认0.8
                repeat: false, //是否循环播放 true|false,默认为false
                shortcutKey: true,
                minPlaybackRate: 1,//最小倍速，整数，默认为1，最小为1
                playbackRate: 1,//默认倍速，整数，默认为1
                rateStep: 2,//倍速每次改变的值，整数，默认为2
                fullscreen: true,
                remainingDuration: true, //为true时，播放器中默认显示剩余时长;为false时，默认显示总时长;
                toggleDuration: true, //为true时，点击播放器中的时间，可以在 剩余时长/总时长 之间切换
                url: link + '.mp4&autostart=false&image=&provider=video' //视频地址
            }
            var video = new Video(config); //生成自定义的音频组件。
        }


        var $this = $videoContent.find("#my-video");
        var iHeight = $this.height();
        var iWidth = $this.width();
        if (iHeight > wHeight) {
            iWidth = (wHeight / iHeight) * iWidth;
            iHeight = wHeight;
        }
        if (iWidth > wWidth) {
            iHeight = (wWidth / iWidth) * iHeight;
            iWidth = wWidth;
        }
        $this.removeAttr("style");
        $videoInner.removeAttr("style");
        var top = (innerHeight - iHeight) / 2;
        $this.css({ width: iWidth + "px", height: iHeight + "px" });
        $this.css("margin-top", top + "px");
    }
    var chamaClick = function () {
        var chnlId = window.localStorage.getItem("channelCode");
        var kmId = kmUtil.getUrlParamter("knwlgId");
        var index1=kmId.indexOf("#");
        kmId = index1 == -1 ? kmId : kmId.substring(0, index1);
        if (!_isTest) {
            $('.logClick').on('click', function () {
                Log.trackEvent([chnlId, kmId, 'click'], this);

            });
            $('.logClick').click();
        }
    };
    /**
     * 访问统计记录serviceTypeId
     */
    var loginSystemRecord = function(){
        /*var curUrl = window.location.href;
        if(curUrl.indexOf("?") > -1){
            curUrl = curUrl.substring(0, curUrl.indexOf("?"));
        }
        var pageName = curUrl.substring(curUrl.lastIndexOf("/") + 1);*/
        //http://ngkm.cs.cmos:8080/test-ngkm/oss/2101191824390208146_771.html?AWSAccessKeyId=iulSxXhw2X6K2qrK&Expires=4100688000&Signature=ljoLl93mUzfR2154KJ7y1%2BDA4Ig%3D&verNo=V1&url_prefix=/ngkm/src&knwlgId=2101191824390208146
        var pageName = "NEW_KNOWLEDGE_DETAIL";
        var url = Constants.AJAXURL + "/kmLoginSystemRecord/addLoginSystemRecord?pageName=" + pageName + "&tm=" + new Date().getTime();
        Util.ajax.ajax({
            type:"POST",
            url:url,
            aysnc:true,
            success:function (data) {

            },
            error:function () {return false;}
        });
    };
    var params_chama = {
        isClick:false,
        sign:{
            'dt': '',  //数据类型标识
            'sid': '', //系统id
            'pr':''    //省份编码
        },
        base:{
            'wid': '', //工单流水号
            'uid': '', //坐席id
            'cn': ''   //呼入号码
        },
        common: {
            'ts': '',    //时间戳
            'tl': '',    //页面标题
            'ul': ''     //当前页面url
        },
        eve: {
            'rf': '',    //上一页链接
            'lp': '',    //页面加载时间
            'dr': '',    //dom加载时间
            'ws': '',    //白屏时间
            'ec': '',    //事件类型
            'ea': '',    //事件标题
            'ev': '',    //事件值
            'cb': '',    //通话开始时间
            'ce': ''     //通话结束时间
        },
        mou: {
            'cl': ''    //点击位置(x,y)
        }
    };
    //拼接参数串
    var getParams = function (name) {
        params_chama.common.ts = new Date().getTime();//每条数据添加时间戳
        params_chama.eve.ce = 'knowledge';
        var args = '';
        for (var i in name) {
            if ( i !="ts" && i != "rf" && i!="cl") {
                args += '|';
            }
            args += name[i];
        }
        return args;
    }
    var imgLazyFunction= function (){
        Util.ajax.postJson(Constants.AJAXURL+'/redisConfig/getRedisConfigInfoByKey', {redisKeys:'NGKM_STATIC_REMOVE_PIC_SEC'}, function (data) {
            if(data&&data.beans){
                if(data.beans.length==1 && data.beans[0]){
                    if($.inArray(knwlgId, data.beans[0].split(","))!=-1){
                        lazyImg="1";
                    }
                }
            }
            // 查询知识详情，获取省份例外(原子权限过滤)
            getAtomsPurview();
        });
    }
    //先获取懒加载开关,再获取原子过滤接口
    imgLazyFunction();

    // getKnowledgeInfo(getAtomsPurview);
    searchInit();
    //缩略图功能事件 初次加载页面给缩略图默认展示方式(闭合)，搜索后再加载不做改动
    thumbnailEvent(true);
    //keyWordHighLight();
    //全局点击事件
    gloBalClick();
    doRefalshPageByCall();

    // 插码记录点击事件
    Util.ajax.getJson(
        Constants.AJAXURL + "/chama/getSwitch?t=" + +new Date().getTime(),
        {},
        function(data){
            if(data&&data.object){
                var kmId = kmUtil.getUrlParamter("knwlgId");
                var index1=kmId.indexOf("#");
                kmId = index1 == -1 ? kmId : kmId.substring(0, index1);
                params_chama.sign.dt = "knowledge";
                params_chama.sign.sid = "ngkm";
                params_chama.sign.pr = window.localStorage.getItem("prov");
                params_chama.eve.ec = window.localStorage.getItem("channelCode");
                params_chama.eve.ea = kmId;
                params_chama.eve.ev = "click";
                params_chama.common.tl = "知识库-知识详情";
                params_chama.common.ul = decodeURI(window.location.href);
                var callInfo = window.localStorage.getItem("callKey")||"||";
                var str = getParams(params_chama.common)+"|"+getParams(params_chama.eve);
                var chama = params_chama.sign.dt + '|' + params_chama.sign.sid + '|' + params_chama.sign.pr + '|' + callInfo + "|" + str;
                Util.ajax.postJson(
                    Constants.AJAXURL + "/chama/send?t=" + +new Date().getTime(),
                    {"chama":chama},
                    function (data) {

                    }
                );
            }/*else{
                try {
                    chamaClick();
                } catch (e) {

                }
            }*/
        }
    );
    // 备案信息
    function appendRecordHtml() {
        var str = '<div class="km-record-wrap" style="left: 0; width: 100%;text-align: center;color: #999;line-height: 32px;font-size: 14px;">\
        <div class="km-record" style="background: #fff;">\
            &copy;2022 中移在线服务有限公司 版权所有 豫ICP备15016518号-4\
        </div>\
    </div>';
        $('.knowd-detail').css({"bottom":"32px"});
        $('.knowd-detail').append(str);
    }
    // 视频放大播放wrap
    function appendVideoWrap() {
        var link = document.createElement('link');
        link.href = '/ngkm/src/css/knowledgeDetailVideo.css'; // 样式文件的路径
        link.rel = 'stylesheet';
        // 将link元素添加到head标签中
        document.getElementsByTagName('head')[0].appendChild(link);


        var str = '<div class="km-popup pic-fullscreen-switch" style="display: none;" id="video-content">\
        <div class="popup-overlay"></div>\
        <div class="pic-fullscreen-inner" id="video-inner">\
        </div>\
        <a id="video-close" class="pic-close" href="javascript:void(0);" style="right: 30px; top: 30px;"></a>\
    </div>';
        $('body').append(str);
        $('body').on("click", "#video-close", function () {
            $("#video-inner").empty();
            $("#video-content").hide();
            return false;
        });
    }
    loginSystemRecord();
    addAccessChnlRecord();
    recordLog();
    //添加水印
    getWatermarkType();
    //kmUtil.addKlgDetailWaterMark();
    pushUpAndDownHtml();
    appendRecordHtml();
    appendVideoWrap();
    IEVersionflag = IEVersion();

    //页面获取/失去焦点
    function freeMemory() {
        $detailLeft = null;
        leftConWrap = null;
        catelog = null;
        knowdDetail = null;
        $layout =null;
        layoutSwitch = null;
        $detaiTitle = null;
        notSendMessage = null;
        $detailTop = null;
        $searchClick = null;
        $topSearchInput = null;
        atomImgAll = null;
        imgIndex = null;//当前图片在atomImgAll集合中的索引
        $imgInner = null;
        $imgContent = null;
        $imgLeft = null;
        $imgRight = null;
        domArray = null;
        lastNumAssCode = null;
        fireEvent = null;
        obj = null;
        searchNo = null;
        $detailRight = null;
        keyWord = null;
        light = null;
        inputKeyWord = null;
        cityScope = null;
        divAdd = null;
        isGetFocus = null;
        _isTest = null;
        knowledgeDetailInfo = null;
        initDom = null;
        initdomArray = null;
        atomsRelateEvent = null;
        execpClick = null;
        doEcept = null;
        refrushAtomExp = null;
        getKlgAtomContent = null;
        exceptFaqClick = null;
        thumbImgAndDivIdChange = null;
        thumbnailEvent = null;
        addPreview = null;
        excepSwitch = null;
        getAtomsPurview = null;
        regnIdReg = null;
        closeRight = null;
        hideNotSendMes = null;
        hideCatelog = null;
        closed = null;
        zhj = null;
        myImgLoad = null;
        zoomImg = null;
        imgLeft = null;
        imgRight = null;
        imgClose = null;
        CloudNaire = null;
        addAccessChnlRecord = null;
        recordLog = null;
        gloBalClick = null;
        thumbLinkFaqOpen = null;
        refrushExp = null;
        doRefalshPageByCall = null;
        findSpanHig = null;
        searchKeyWord = null;
        searchInit = null;
        keyWordHighLight = null;
        searchNumFn = null;
        pushUpAndDownHtml = null;
    }

    return {
        fireEvent: fireEvent,
        detailLeft: $detailLeft,
        domArray: domArray,
        keyWordHighLight: keyWordHighLight,
        initdomArray: initdomArray,
        freeMemory:freeMemory
    }


});